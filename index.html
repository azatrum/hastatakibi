<!doctype html>
<html lang="tr">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Acil Hasta Takip Sistemi</title>
  <!-- Data SDK ve Element SDK baÄŸÄ±mlÄ±lÄ±klarÄ± KALDIRILDI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        /* TÄ±bbi Desenli Arka Plan (2. Ä°stenen) */
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Mobil tÄ±klama vurgusunu kaldÄ±r */
            background-color: #f3f4f6; /* Hafif gri temel */
            /* TÄ±bbi Desen Ekleme: HÃ¼cre/DNA temalÄ± aÃ§Ä±k gri desen */
            background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px),
                              radial-gradient(#d1d5db 0.5px, #f9fafb 0.5px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* TÃ¼m ana container'Ä±n arka planÄ±nÄ± ÅŸeffaf yapÄ±yoruz ki body deseni gÃ¶rÃ¼nsÃ¼n */
        #app {
            background: transparent !important;
        }
        
        html {
            height: 100%;
        }
        
        /* Mobil uyumluluk iÃ§in Ã¶zel sÄ±nÄ±flar */
        @media (max-width: 768px) {
            .mobile-full-screen {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 40; /* Detail panelin diÄŸer iÃ§eriklerin Ã¼zerinde kalmasÄ± iÃ§in */
                padding-top: 4rem; /* Header'a yer aÃ§mak iÃ§in */
                overflow-y: auto;
            }
            .mobile-grid-cols-1 {
                grid-template-columns: 1fr;
            }
            /* Issue 4: Anamnez detay gÃ¶rÃ¼nÃ¼mÃ¼nde 5 kutucuÄŸu alt alta gÃ¶ster */
            .anamnez-sections-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Madde 4: Tablet ve MasaÃ¼stÃ¼ iÃ§in 5 sÃ¼tun yan yana (min-width: 1280px) */
        @media (min-width: 768px) and (max-width: 1279px) {
             .anamnez-sections-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1280px) {
            .anamnez-sections-grid {
                grid-template-columns: repeat(5, 1fr); /* 5 kutucuk yan yana */
            }
        }
        
        /* Madde 2: Anamnez Kare KartlarÄ± */
        .anamnez-square-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .anamnez-square-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
            border-color: #4f46e5;
        }

        .anamnez-card-header {
            background-color: #f9fafb;
            padding: 8px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            color: #4b5563;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .anamnez-card-content {
            padding: 12px;
            flex-grow: 1;
            overflow: hidden;
        }
        
        /* Anamnez metin alanÄ± dÃ¼zenleme modu */
        .anamnez-textarea {
            width: 100%;
            height: 100%;
            resize: none;
            border: none;
            padding: 0;
            margin: 0;
            outline: none;
            background: transparent;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* leading-5 */
            color: #374151; /* text-gray-700 */
        }
        
        .anamnez-textarea:focus {
            background-color: #f3f4f6; /* focus anÄ±nda hafif gri arka plan */
        }

        .patient-card {
            transition: all 0.3s ease;
            position: relative; /* Adli ikon iÃ§in */
        }
        
        .patient-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Durum Renkleri */
        .status-active {
            background: linear-gradient(135deg, #d4f4dd 0%, #a8e6cf 100%);
            border-left: 4px solid #2ecc71;
        }
        
        .status-discharged {
            background: linear-gradient(135deg, #fff4d4 0%, #ffe6a8 100%);
            border-left: 4px solid #f39c12;
        }
        
        .status-admitted {
            background: linear-gradient(135deg, #dae0ff 0%, #b8c5ff 100%);
            border-left: 4px solid #4169e1;
        }
        
        .status-deceased {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            border-left: 4px solid #616161;
        }
        
        /* YENÄ° GÃœÃ‡LENDÄ°RÄ°LMÄ°Å RENKLER (Koyu Arka Plan + Beyaz Metin) */
        /* Ä°zinsiz Terk */
        .status-left-without-permission { 
            background: #9a3412; /* Tailwind amber-900'e yakÄ±n koyu kahve/turuncu */
            border-left: 4px solid #f97316; /* Koyu turuncu sÄ±nÄ±r */
            color: #ffffff; /* Beyaz metin */
        }
        /* Ä°zinsiz Terk kart iÃ§i metinlerini koyu yaparsak daha iyi olur */
        .status-left-without-permission .text-gray-800, 
        .status-left-without-permission .text-gray-600,
        .status-left-without-permission .text-gray-700,
        .status-left-without-permission .text-gray-500,
        .status-left-without-permission .score-badge,
        .status-left-without-permission .text-red-600 {
            color: #fef3c7 !important; /* YumuÅŸak bej/beyaz metin */
            text-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        
        /* Ä°mzalÄ± Taburcu */
        .status-signed-discharge {
            background: #1e3a8a; /* Tailwind blue-900'e yakÄ±n koyu lacivert */
            border-left: 4px solid #3b82f6; /* AÃ§Ä±k mavi sÄ±nÄ±r */
            color: #ffffff; /* Beyaz metin */
        }
         /* Ä°mzalÄ± Taburcu kart iÃ§i metinlerini koyu yaparsak daha iyi olur */
        .status-signed-discharge .text-gray-800, 
        .status-signed-discharge .text-gray-600,
        .status-signed-discharge .text-gray-700,
        .status-signed-discharge .text-gray-500,
        .status-signed-discharge .score-badge,
        .status-signed-discharge .text-red-600 {
            color: #eff6ff !important; /* YumuÅŸak beyaz/aÃ§Ä±k mavi metin */
            text-shadow: 0 0 3px rgba(0,0,0,0.3);
        }
        
        /* Detay Panelinin YumuÅŸak Kahverengi/Bej Tonu */
        .detail-panel {
            background-color: #fef3c7; /* Tailwind bg-amber-50'e yakÄ±n yumuÅŸak bej/kahve */
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); /* Daha belirgin gÃ¶lge */
            border: 1px solid #fcd34d; /* YumuÅŸak sarÄ± kenarlÄ±k */
        }
        
        .quick-complaint-btn {
            transition: all 0.2s;
        }
        
        .quick-complaint-btn:hover {
            transform: scale(1.05);
        }
        
        .score-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* NEWS SkorlarÄ± */
        .news-low { background: #d4f4dd; color: #27ae60; }
        .news-medium { background: #fff4d4; color: #f39c12; }
        .news-high { background: #ffd4d4; color: #e74c3c; }
        
        /* Tetkik Bildirimleri (Blink Efekti Korundu) */
        .test-notification {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .test-item {
            border-left: 3px solid #3b82f6;
            padding-left: 12px;
        }
        
        .test-item.due {
            border-left-color: #ef4444;
            background: #fee;
        }
        
        .test-item.completed {
            border-left-color: #22c55e;
            background: #f0fdf4;
            opacity: 0.7;
        }
        
        .template-icon {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-icon:hover {
            transform: scale(1.1);
            color: #4f46e5;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Adli Vaka Ä°konu */
        .forensic-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            font-size: 1.25rem; /* text-xl */
            color: #ef4444; /* red-500 */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            animation: pulse-forensic 1.5s infinite;
            cursor: help;
        }

        @keyframes pulse-forensic {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        /* Collapsible sections (default collapsed) */
        .collapsible { border-radius: 8px; overflow: hidden; }
        .collapsible-header { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 10px; cursor:pointer; }
        .collapsible-header .title { font-weight:600; }
        .collapsible-toggle { background:transparent; border:none; font-size:16px; cursor:pointer; padding:4px; }
        .collapsible-content { display:none; padding:0 0 8px 0; }
        .collapsible.open .collapsible-content { display:block; }

        /* Simple slider style (clean, like Windows volume control) */
        .vital-row { display:flex; align-items:center; gap:10px; }
        .vital-label { width:140px; font-weight:600; font-size:0.95rem; }
        .slider-wrapper { flex:1; display:flex; align-items:center; gap:8px; }
        .vital-slider { -webkit-appearance:none; appearance:none; width:100%; height:10px; border-radius:6px; background:#e5e7eb; outline:none; }
        .vital-slider::-webkit-slider-thumb { -webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:#2563eb; box-shadow:0 2px 6px rgba(37,99,235,0.3); cursor:pointer; }
        .vital-value { min-width:64px; text-align:center; font-weight:700; background:#fff; border-radius:6px; padding:6px 8px; border:1px solid #e6e6e6; }
        .vital-slider.filled { background: linear-gradient(90deg, #2563eb var(--pct,0%), #e5e7eb var(--pct,0%)); }

        /* Complaint presets popup */
        .complaint-presets { position: absolute; z-index:60; background: #fff; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 6px 20px rgba(0,0,0,0.12); padding:8px; min-width:200px; }
        .complaint-presets button { display:block; width:100%; text-align:left; padding:6px 8px; border-radius:6px; background:transparent; border:none; cursor:pointer; }
        .complaint-presets button:hover { background:#f3f4f6; }

        /* Mic button active state */
        .mic-btn { background: transparent; border: none; cursor: pointer; padding: 2px 6px; border-radius: 6px; }
        .mic-btn.active { background: #fee2e2; color: #b91c1c; }
        .mic-indicator { display:inline-flex; padding:4px 6px; border-radius:8px; background: rgba(37,99,235,0.06); border:1px solid rgba(37,99,235,0.08); }
        .mic-dot { width:10px; height:10px; background:#ef4444; border-radius:999px; box-shadow:0 0 8px rgba(239,68,68,0.6); animation: mic-blink 1s infinite; }
        @keyframes mic-blink { 0%{opacity:1} 50%{opacity:0.25} 100%{opacity:1} }
        .mic-wave { display:inline-flex; gap:3px; align-items:flex-end; height:16px; }
        .mic-wave .bar { width:4px; background:#2563eb; border-radius:2px; transform-origin:bottom; animation: wave 800ms infinite ease-in-out; }
        .mic-wave .b1 { animation-delay: 0ms; }
        .mic-wave .b2 { animation-delay: 120ms; }
        .mic-wave .b3 { animation-delay: 240ms; }
        .mic-wave .b4 { animation-delay: 360ms; }
        .mic-wave .b5 { animation-delay: 480ms; }
        @keyframes wave { 0%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} 100%{transform:scaleY(0.4)} }
        .mic-small-btn { background:transparent; border:none; cursor:pointer; font-size:12px; padding:4px; border-radius:6px; }

        /* Multi-select patient cards */
        .patient-card.selected-card { outline: 3px solid #2563eb; box-shadow: 0 6px 18px rgba(37,99,235,0.12); }
        .patient-card .select-badge { position:absolute; top:8px; left:8px; background:#2563eb; color:#fff; width:28px; height:28px; border-radius:9999px; display:flex; align-items:center; justify-content:center; font-weight:700; z-index:20; }
        #multi-action-toolbar { position: fixed; top: 1rem; right: 1rem; z-index:80; display:none; gap:8px; align-items:center; }
        #multi-action-toolbar .toolbar-btn { background:#111827; color:#fff; padding:8px 10px; border-radius:8px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
        #multi-action-toolbar .toolbar-btn.secondary { background:#6b7280; }

    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="h-full flex flex-col">
   <!-- Header (Mobil Uyumlu - Sabit BaÅŸlÄ±k) -->
   <div class="bg-white shadow-lg p-3 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center flex-wrap">
     <h1 id="app-title" class="text-xl md:text-3xl font-bold text-gray-800 mb-2 md:mb-0">Acil Hasta Takip Sistemi</h1>
     <div class="flex gap-1 md:gap-3 text-sm flex-wrap justify-end">
      <button id="patient-view-btn" class="px-3 py-1 md:px-6 md:py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition text-xs md:text-base"> Hasta Listesi </button>
      <button id="favorites-view-btn" class="px-3 py-1 md:px-6 md:py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-xs md:text-base"> â­ Favoriler </button>
      <button id="anamnesis-view-btn" class="px-3 py-1 md:px-6 md:py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-xs md:text-base"> Anamnez </button>
      <button id="settings-btn" class="px-3 py-1 md:px-6 md:py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition text-xs md:text-base"> âš™ï¸ Ayarlar </button>
     </div>
            <!-- Multi-select toolbar (hidden until selection mode) -->
            <div id="multi-action-toolbar">
                <div id="multi-count" class="px-3 py-2 bg-white rounded text-sm font-semibold">0 seÃ§ildi</div>
                <button id="multi-select-visible" class="toolbar-btn" title="GÃ¶rÃ¼nen tÃ¼m hastalarÄ± seÃ§">TÃ¼mÃ¼nÃ¼ SeÃ§ (GÃ¶rÃ¼nen)</button>
                <button id="multi-discharge" class="toolbar-btn secondary">Taburcu Et</button>
                <button id="multi-delete" class="toolbar-btn">Sil</button>
                <button id="multi-cancel" class="toolbar-btn secondary">Ä°ptal</button>
            </div>
            <!-- Undo toast for bulk delete -->
            <div id="bulk-undo-toast" style="position:fixed; bottom:1rem; left:50%; transform:translateX(-50%); z-index:90; display:none;">
                <div id="bulk-undo-msg" class="px-4 py-3 rounded-lg shadow-lg text-white bg-gray-800 text-sm flex items-center gap-3">
                    <span id="bulk-undo-text">Hastalar silindi</span>
                    <button id="bulk-undo-btn" class="px-3 py-1 bg-white text-gray-800 rounded">Geri Al</button>
                </div>
            </div>
    </div>
   </div>
   <!-- Main Content -->
   <div class="flex-1 overflow-y-auto p-3 md:p-6">
    <div class="max-w-7xl mx-auto">
     <!-- Patient List View -->
     <div id="patient-list-view">
      <!-- Controls -->
      <div class="bg-white rounded-lg shadow-md p-4 mb-4 md:mb-6">
       <div class="flex flex-wrap gap-3 items-center justify-between">
        <button id="scan-btn" class="flex-1 md:flex-none px-4 py-2 md:px-6 md:py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition flex items-center justify-center gap-2 text-sm md:text-base"> <span>ğŸ“·</span> <span id="scan-button-text">Hasta Ekle</span> </button>
        <div class="flex gap-2 flex-wrap flex-1 md:flex-none">
         <!-- Issue 9: Alan Filtrelemesi Eklendi -->
         <select id="filter-area-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderPatientCards()"> 
            <option value="all">TÃ¼m Alanlar</option>
            <option value="yok">Alan BelirtilmemiÅŸ</option>
            <option value="ResÃ¼sitasyon">ResÃ¼sitasyon</option>
            <option value="KÄ±rmÄ±zÄ±">KÄ±rmÄ±zÄ± Alan</option>
            <option value="SarÄ±">SarÄ± Alan</option>
            <option value="YeÅŸil">YeÅŸil Alan</option>
            <option value="MÃ¼ÅŸahade">MÃ¼ÅŸahade</option>
            <option value="DiÄŸer">DiÄŸer</option>
         </select>
         <select id="filter-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderPatientCards()"> <option value="all">TÃ¼m Hastalar</option> <option value="active">Aktif Hastalar</option> <option value="discharged">Taburcu Edilenler</option> <option value="admitted">YatÄ±ÅŸ Verilenler</option> <option value="favorites">Favoriler</option> <option value="forensic">ğŸš¨ Adli Vakalar</option> </select>
         <!-- Issue 8: YaÅŸa GÃ¶ralama SeÃ§eneÄŸi Eklendi -->
         <select id="sort-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderPatientCards()"> <option value="time">Eklenme Saatine GÃ¶re</option> <option value="name">Ä°sme GÃ¶re</option> <option value="age_desc">YaÅŸa GÃ¶re (Azalan)</option> <option value="age_asc">YaÅŸa GÃ¶re (Artan)</option> <option value="complaint">Åikayete GÃ¶re</option> <option value="bed">Yatak NumarasÄ±na GÃ¶re</option> </select>
        
        </div>
       </div>
      </div>
      <!-- Patient Cards -->
      <div id="patient-cards" class="grid gap-3 md:gap-4 mobile-grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
       <!-- Patients will be rendered here -->
      </div>
      <!-- Patient Detail Panel (Mobil Uyumlu) -->
      <div id="detail-panel" class="hidden mt-6 detail-panel p-4 md:p-6 md:static mobile-full-screen">
       <!-- Detail content will be rendered here -->
      </div>
     </div>
     <!-- Favorites View -->
     <div id="favorites-view" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
       <h2 class="text-xl md:text-2xl font-bold mb-4">â­ Favori Hastalar (KategorilenmiÅŸ)</h2>
       <!-- Istenen filtreleme buradaki select'te uygulanacak -->
       <div class="mb-4">
            <select id="favorite-category-filter" class="w-full md:w-1/3 px-4 py-2 border border-gray-300 rounded-lg text-sm" onchange="renderFavoritesView()">
                <option value="all">TÃ¼m Kategoriler</option>
                <!-- Category options will be populated by JS -->
            </select>
       </div>
       <div id="favorites-categories" class="space-y-4 md:space-y-6">
        <!-- Favorite categories will be rendered here -->
       </div>
      </div>
     </div>
     <!-- Anamnesis View (Madde 2/3: Yeni gÃ¶rÃ¼nÃ¼m) -->
     <div id="anamnesis-view" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4">
            <div class="flex flex-wrap gap-4 items-center justify-between">
                <h2 class="text-xl font-bold">Anamnez Ã‡Ä±ktÄ±larÄ± (HÄ±zlÄ± Kopyalama ve DÃ¼zenleme Merkezi)</h2>
                <div class="flex flex-wrap gap-2 items-center flex-grow md:flex-grow-0">
                    <!-- Madde 1: Alan Filtrelemesi (Hasta Listesi ile AynÄ±) -->
                    <select id="anamnesis-area-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm flex-1" onchange="renderAnamnesisView()">
                        <option value="all">TÃ¼m Alanlar</option>
                        <option value="yok">Alan BelirtilmemiÅŸ</option>
                        <option value="ResÃ¼sitasyon">ResÃ¼sitasyon</option>
                        <option value="KÄ±rmÄ±zÄ±">KÄ±rmÄ±zÄ± Alan</option>
                        <option value="SarÄ±">SarÄ± Alan</option>
                        <option value="YeÅŸil">YeÅŸil Alan</option>
                        <option value="MÃ¼ÅŸahade">MÃ¼ÅŸahade</option>
                        <option value="DiÄŸer">DiÄŸer</option>
                    </select>
                    <!-- Yeni Eklenen: Durum Filtrelemesi -->
                     <select id="anamnesis-status-filter" class="px-4 py-2 border border-gray-300 rounded-lg text-sm flex-1" onchange="renderAnamnesisView()">
                        <option value="active">Aktif Hastalar</option>
                        <option value="all">TÃ¼m Hastalar</option> 
                        <option value="discharged">Taburcu Edilenler</option>
                        <option value="admitted">YatÄ±ÅŸ Verilenler</option>
                        <option value="deceased">Eksitus</option>
                        <option value="left_without_permission">Ä°zinsiz Terk</option>
                        <option value="signed_discharge">Ä°mzalÄ± Taburcu</option>
                        <option value="forensic">ğŸš¨ Adli Vakalar</option> <!-- Adli Filtre Eklendi -->
                    </select>
                    <button onclick="copyAllAnamnesisFromAnamnesisView()" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition text-sm flex-1">
                        ğŸ“‹ TÃ¼m Aktif Anamnezleri Kopyala
                    </button>
                </div>
            </div>
        </div>
        <div id="anamnesis-list" class="space-y-4 md:space-y-6">
         <!-- Anamnesis entries will be rendered here -->
        </div>
     </div>
     <!-- Settings View -->
     <div id="settings-view" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
       <h2 class="text-xl md:text-2xl font-bold mb-6">âš™ï¸ Ayarlar & Yedekleme</h2>
       <div class="mb-6 border p-4 rounded-lg bg-indigo-50 border-indigo-200">
        <h3 class="font-bold text-lg mb-2 text-indigo-700">ğŸ§  Yapay Zeka AyarlarÄ± (Google Gemini)</h3>
        <p class="text-sm text-indigo-600 mb-3">
         Anamnez dÃ¼zeltme asistanÄ±nÄ± kullanmak iÃ§in Google Gemini API anahtarÄ±nÄ±zÄ± buraya girin.
        </p>
        <div class="flex gap-2">
         <input type="password" id="google-api-key-input" placeholder="Google API Key (AIzaSy...)" class="flex-1 px-4 py-2 border border-indigo-300 rounded-lg">
         <button onclick="saveGoogleApiKey()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700">Kaydet</button>
        </div>
       </div>
       <!-- GENEL YEDEKLEME BUTONLARI -->
       <div class="mb-8 border p-4 rounded-lg bg-red-50">
        <h3 class="font-bold text-lg mb-3 text-red-700">TÃœM VERÄ°LERÄ° YEDEKLE (Hastalar + Ayarlar)</h3>
        <p class="text-sm text-red-600 mb-4">
         Bu iÅŸlem, anlÄ±k olarak tÃ¼m hasta verilerini (aktif, taburcu, favori) ve tÃ¼m ÅŸablon/skor ayarlarÄ±nÄ± (localStorage verileri) tek bir JSON dosyasÄ± olarak dÄ±ÅŸa/iÃ§e aktarmanÄ±zÄ± saÄŸlar.
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
         <!-- Dosya Export Butonu (1. Ä°stenen) -->
         <button id="export-all-data" onclick="exportAllDataToFile()" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition"> ğŸ’¾ TÃ¼m Veriyi DÄ±ÅŸa Aktar (JSON DosyasÄ±) </button>
         <!-- Dosya Import Butonu (1. Ä°stenen) -->
         <button id="import-all-data" onclick="document.getElementById('file-upload-input').click();" class="px-6 py-3 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition"> ğŸ“¥ TÃ¼m Veriyi Ä°Ã§e Aktar (JSON DosyasÄ±) </button>
        </div>
                 <div class="mt-3">
                     <p class="text-sm text-red-600 mb-2">HÄ±zlÄ± GÃ¶nder: DÄ±ÅŸa aktarÄ±lan JSON'u doÄŸrudan paylaÅŸ</p>
                     <div class="flex gap-2 flex-wrap">
                         <button class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600" onclick="shareAllData('whatsapp')">ğŸ’¬ WhatsApp ile GÃ¶nder</button>
                         <button class="px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-black" onclick="shareAllData('signal')">ğŸ”’ Signal ile GÃ¶nder</button>
                         <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="shareAllData('mail')">ğŸ“§ E-posta ile GÃ¶nder</button>
                     </div>
                 </div>
                 <div class="mt-6 border-t pt-4">
                     <h4 class="font-semibold mb-2">Otomatik Yedekleme (Periyodik)</h4>
                     <div class="flex items-center gap-2 mb-2">
                         <label class="flex items-center gap-2"><input type="checkbox" id="auto-backup-enabled"> <span>Otomatik yedeklemeyi etkinleÅŸtir</span></label>
                     </div>
                     <div class="flex gap-2 items-center mb-2">
                         <label class="text-sm">AralÄ±k:</label>
                         <select id="auto-backup-interval" class="px-3 py-2 border rounded">
                             <option value="5">5 dakika</option>
                             <option value="15">15 dakika</option>
                             <option value="30">30 dakika</option>
                             <option value="60">1 saat</option>
                             <option value="240">4 saat</option>
                         </select>
                         <label class="text-sm">Hedef Dosya:</label>
                         <input id="auto-backup-filename" class="px-3 py-2 border rounded w-64" placeholder="acil_takip_yedek.json">
                     </div>
                     <div class="flex gap-2 items-center mb-3">
                         <label class="flex items-center gap-2"><input type="radio" name="auto-backup-mode" value="new" id="auto-backup-mode-new" checked> Her zaman yeni dosya</label>
                         <label class="flex items-center gap-2"><input type="radio" name="auto-backup-mode" value="reuse" id="auto-backup-mode-reuse"> Son export edilen dosya ismine yaz (varsa)</label>
                     </div>
                     <div class="flex gap-2">
                         <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg" id="auto-backup-start">BaÅŸlat</button>
                         <button class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg" id="auto-backup-stop">Durdur</button>
                         <button class="px-4 py-2 bg-yellow-500 text-white rounded-lg" id="auto-backup-now">Åimdi Yedekle</button>
                     </div>
                     <p class="text-xs text-gray-600 mt-2">Not: TarayÄ±cÄ±lar otomatik olarak bir dosyayÄ± gerÃ§ek anlamda Ã¼zerine yazmaz; "son export edilen dosya ismine yaz" seÃ§eneÄŸi seÃ§ildiÄŸinde aynÄ± dosya adÄ± kullanÄ±lacaktÄ±r. GerÃ§ek Ã¼zerine yazma iÃ§in tarayÄ±cÄ± File System Access desteÄŸi ile ek izin gereklidir.</p>
                 </div>
        <!-- Dosya YÃ¼kleme Inputu (Gizli) -->
        <input type="file" id="file-upload-input" class="hidden" accept=".json" onchange="handleFileImport(event, 'all')">
       </div>
       <!-- Settings Icons Grid -->
       <!-- Karar Metinleri KALDILDI -->
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
        <button onclick="openSettingsSection('diagnosis')" class="settings-icon-btn flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl hover:shadow-lg transition transform hover:scale-105 group">
         <div class="text-3xl md:text-5xl mb-2 md:mb-3">
          ğŸ©º
         </div>
         <div class="font-semibold text-gray-800 text-sm md:text-base">
          Ã–n TanÄ±lar
         </div>
         <div class="text-xs text-gray-600 mt-1 opacity-0 group-hover:opacity-100 transition text-center hidden md:block">
          Ã–n tanÄ± ÅŸablonlarÄ±nÄ± yÃ¶net
         </div>
        </button>
        <button onclick="openSettingsSection('scoring')" class="settings-icon-btn flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl hover:shadow-lg transition transform hover:scale-105 group">
         <div class="text-3xl md:text-5xl mb-2 md:mb-3">
          ğŸ“Š
         </div>
         <div class="font-semibold text-gray-800 text-sm md:text-base">
          Skorlama
         </div>
         <div class="text-xs text-gray-600 mt-1 opacity-0 group-hover:opacity-100 transition text-center hidden md:block">
          Skorlama sistemlerini dÃ¼zenle
         </div>
        </button>
        <!-- KARAR METÄ°NLERÄ° KALDIRILDI -->
        <button onclick="openSettingsSection('anamnesis')" class="settings-icon-btn flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-xl hover:shadow-lg transition transform hover:scale-105 group">
         <div class="text-3xl md:text-5xl mb-2 md:mb-3">
          ğŸ“‹
         </div>
         <div class="font-semibold text-gray-800 text-sm md:text-base">
          Anamnez ÅablonlarÄ±
         </div>
         <div class="text-xs text-gray-600 mt-1 opacity-0 group-hover:opacity-100 transition text-center hidden md:block">
          Anamnez ve Karar ÅablonlarÄ±nÄ± yÃ¶net
         </div>
        </button>
        <button onclick="openSettingsSection('test-templates')" class="settings-icon-btn flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-red-50 to-red-100 rounded-xl hover:shadow-lg transition transform hover:scale-105 group">
         <div class="text-3xl md:text-5xl mb-2 md:mb-3">
          ğŸ§ª
         </div>
         <div class="font-semibold text-gray-800 text-sm md:text-base">
          Tetkik ÅablonlarÄ±
         </div>
         <div class="text-xs text-gray-600 mt-1 opacity-0 group-hover:opacity-100 transition text-center hidden md:block">
          Tetkik protokollerini dÃ¼zenle
         </div>
        </button>
        <button onclick="openSettingsSection('physical-exam-templates')" class="settings-icon-btn flex flex-col items-center justify-center p-4 md:p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl hover:shadow-lg transition transform hover:scale-105 group">
         <div class="text-3xl md:text-5xl mb-2 md:mb-3">
          ğŸ©º
         </div>
         <div class="font-semibold text-gray-800 text-sm md:text-base">
          Fizik Muayene
         </div>
         <div class="text-xs text-gray-600 mt-1 opacity-0 group-hover:opacity-100 transition text-center hidden md:block">
          Normal muayene ÅŸablonlarÄ±nÄ± dÃ¼zenle
         </div>
        </button>
       </div>
      </div>
     </div>
     <!-- Settings Detail Modals (Korundu) -->
     <div id="diagnosis-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
       <h3 class="text-2xl font-bold mb-4">ğŸ©º Ã–n TanÄ± ÅablonlarÄ±</h3>
       <div id="diagnosis-templates-list" class="space-y-4 mb-4">
        <!-- Diagnosis templates will be rendered here -->
       </div>
       <div class="flex gap-3 flex-wrap">
        <button id="add-diagnosis-template-btn-modal" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> + Yeni Ã–n TanÄ± Åablonu Ekle </button>
        <button onclick="closeSettingsSection()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"> Kapat </button>
       </div>
      </div>
     </div>
     <div id="scoring-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
       <h3 class="text-2xl font-bold mb-4">ğŸ“Š Skorlama Sistemleri</h3>
       <div id="scoring-systems-list" class="space-y-4 mb-4">
        <!-- Scoring systems will be rendered here -->
       </div>
       <div class="flex gap-3 flex-wrap">
        <button id="add-scoring-system-btn-modal" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> + Yeni Skorlama Sistemi Ekle </button>
        <button onclick="closeSettingsSection()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"> Kapat </button>
       </div>
      </div>
     </div>
     <!-- KARAR METÄ°NLERÄ° MODALI KALDIRILDI -->
     <div id="anamnesis-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
       <h3 class="text-2xl font-bold mb-4">ğŸ“‹ Anamnez ve Karar ÅablonlarÄ±</h3>
       <div id="anamnez-templates-list" class="space-y-4 mb-4">
        <!-- Anamnez templates will be rendered here -->
       </div>
       <div class="flex gap-3 flex-wrap">
        <button id="add-anamnez-template-btn-modal" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> + Yeni Åablon Ekle </button>
        <!-- Dosya Export Butonu (1. Ä°stenen) -->
        <button id="export-anamnez-templates" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="exportTemplateDataToFile('anamnez')"> ğŸ“¤ Export JSON DosyasÄ± </button>
        <!-- Dosya Import Butonu (1. Ä°stenen) -->
        <button id="import-anamnez-templates" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="document.getElementById('file-upload-anamnez').click();"> ğŸ“¥ Import JSON DosyasÄ± </button>
        <input type="file" id="file-upload-anamnez" class="hidden" accept=".json" onchange="handleFileImport(event, 'anamnez')">
        <button onclick="closeSettingsSection()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"> Kapat </button>
       </div>
      </div>
     </div>
     <div id="test-templates-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
       <h3 class="text-2xl font-bold mb-4">ğŸ§ª Tetkik ÅablonlarÄ±</h3>
       <div id="test-templates-settings-list" class="space-y-4 mb-4">
        <!-- Test templates will be rendered here -->
       </div>
       <div class="flex gap-3 flex-wrap">
        <button id="add-test-template-btn-modal" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> + Yeni Åablon Ekle </button>
        <!-- Dosya Export Butonu (1. Ä°stenen) -->
        <button id="export-test-templates" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" onclick="exportTemplateDataToFile('test')"> ğŸ“¤ Export JSON DosyasÄ± </button>
        <!-- Dosya Import Butonu (1. Ä°stenen) -->
        <button id="import-test-templates" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700" onclick="document.getElementById('file-upload-test').click();"> ğŸ“¥ Import JSON DosyasÄ± </button>
        <input type="file" id="file-upload-test" class="hidden" accept=".json" onchange="handleFileImport(event, 'test')">
        <button onclick="closeSettingsSection()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"> Kapat </button>
       </div>
      </div>
     </div>
     <!-- Fizik Muayene ÅablonlarÄ± Modal -->
     <div id="physical-exam-templates-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[90%] overflow-y-auto">
       <h3 class="text-2xl font-bold mb-4">ğŸ©º Fizik Muayene ÅablonlarÄ±</h3>
       <p class="text-sm text-gray-600 mb-4">Her muayene bÃ¶lgesinin normal bulgularÄ±nÄ± Ã¶zelleÅŸtirin. Bu ÅŸablonlar detay panelinde muayene alanÄ±na eklenecektir.</p>
       <div id="physical-exam-templates-settings-list" class="space-y-4 mb-4">
        <!-- Physical exam templates will be rendered here -->
       </div>
       <div class="flex gap-3 flex-wrap">
        <button onclick="closeSettingsSection()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"> Kapat </button>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
    <!-- Hasta Ekleme Modal (FotoÄŸraf tabanlÄ± OCR + Manuel) -->
    <div id="scan-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
     <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
         <h3 class="text-xl font-bold">ğŸ“· Hasta Ekle (FotoÄŸraf ile otomatik doldurma veya Manuel)</h3>
         <button id="scan-cancel" class="px-3 py-1 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 text-sm">âœ•</button>
        </div>

        <div class="flex gap-2 mb-4 border-b">
         <button id="tab-photo" class="px-4 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">ğŸ“¸ FotoÄŸraf</button>
         <button id="tab-manual" class="px-4 py-2 font-semibold text-gray-600 hover:text-gray-800">âœï¸ Manuel</button>
        </div>

        <!-- FotoÄŸraf Sekmesi -->
        <div id="scan-tab-photo" class="space-y-3">
         <p class="text-sm text-gray-600">Telefon kamerasÄ±yla barkod/etiket/fotoÄŸraf Ã§ekin veya galeriden yÃ¼kleyin. Yapay zeka fotoÄŸrafÄ± analiz edip formu dolduracaktÄ±r.</p>
         <div id="photo-actions" class="grid grid-cols-2 gap-2">
            <button id="camera-start" class="px-3 py-2 bg-blue-600 text-white rounded-lg">ğŸ“· Kamera ile Ã§ek</button>
            <label class="px-3 py-2 bg-gray-100 border rounded-lg text-center cursor-pointer">
                ğŸ“ Galeriden yÃ¼kle
                <input id="photo-file-input" type="file" accept="image/*" class="hidden">
            </label>
         </div>

         <div id="camera-preview" class="bg-gray-900 rounded-lg overflow-hidden relative" style="height:280px; display:none">
            <video id="camera-stream" autoplay playsinline style="width:100%; height:100%; object-fit:cover"></video>
            <button id="camera-capture" class="absolute bottom-3 left-1/2 -translate-x-1/2 px-4 py-2 bg-white text-black rounded-full">ğŸ“¸ Ã‡ek</button>
         </div>

         <div id="photo-preview-img" class="rounded-lg overflow-hidden" style="display:none">
            <img id="preview-img" src="" alt="Preview" style="width:100%; height:auto; display:block" />
         </div>

         <div class="flex gap-2">
            <button id="analyze-photo" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg">Yapay Zeka ile Analiz Et</button>
            <button id="clear-photo" class="px-4 py-2 bg-gray-200 rounded-lg">Temizle</button>
         </div>

         <div id="ocr-result" class="p-3 mt-2 bg-gray-50 rounded hidden">
            <p class="font-semibold">AlgÄ±lanan Bilgiler</p>
            <div id="ocr-result-content" class="text-sm text-gray-700 mt-2"></div>
         </div>
        </div>

        <!-- Manuel GiriÅŸ Sekmesi -->
        <div id="scan-tab-manual" class="space-y-3 hidden">
         <input id="scan-name" type="text" placeholder="Hasta AdÄ± SoyadÄ±" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
         <input id="scan-file-number" type="text" placeholder="Dosya NumarasÄ±" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
         <input id="scan-age" type="number" placeholder="YaÅŸ" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
         <select id="scan-gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg"> 
            <option value="">Cinsiyet SeÃ§in</option> 
            <option value="Erkek">Erkek</option> 
            <option value="KadÄ±n">KadÄ±n</option> 
         </select>
         <select id="scan-area" class="w-full px-3 py-2 border border-gray-300 rounded-lg"> 
            <option value="">Alan SeÃ§in (Opsiyonel)</option>
            <option value="ResÃ¼sitasyon">ResÃ¼sitasyon</option>
            <option value="KÄ±rmÄ±zÄ±">KÄ±rmÄ±zÄ± Alan</option>
            <option value="SarÄ±">SarÄ± Alan</option>
            <option value="YeÅŸil">YeÅŸil Alan</option>
            <option value="MÃ¼ÅŸahade">MÃ¼ÅŸahade</option>
            <option value="DiÄŸer">DiÄŸer</option>
         </select>
         <input id="scan-bed-number" type="text" placeholder="Oda/Yatak No (Opsiyonel)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
        <textarea id="scan-complaint" placeholder="GeliÅŸ ÅŸikayeti (Opsiyonel)" class="w-full px-4 py-2 border border-gray-300 rounded-lg resize-y text-sm" rows="2"></textarea>
        </div>

        <!-- Butonlar -->
        <div class="flex gap-3 mt-6">
         <button id="scan-confirm" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">âœ… Ekle</button>
        </div>
     </div>
    </div>
  <!-- Template Modal (Tetkik Åablonu OluÅŸtur) -->
  <div id="template-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
    <h3 class="text-xl font-bold mb-4">Tetkik Åablonu OluÅŸtur</h3>
    <div class="space-y-4">
     <div>
      <label class="block text-sm font-semibold mb-2">Åablon AdÄ±</label>
      <input id="template-name" type="text" placeholder="Ã–rn: GIS Kanama ProtokolÃ¼" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
     </div>
     <div>
      <label class="block text-sm font-semibold mb-2">Ã–n TanÄ±</label>
      <input id="template-diagnosis" type="text" placeholder="Ã–rn: GIS Kanama" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
     </div>
     <div>
      <label class="block text-sm font-semibold mb-2">Tetkikler</label>
      <div id="template-tests-list" class="space-y-2 mb-3">
       <!-- Test items will be added here -->
      </div>
      <button id="add-test-item" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm"> + Tetkik Ekle </button>
     </div>
    </div>
    <div class="flex gap-3 mt-6">
     <button id="template-save" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Kaydet</button>
     <button id="template-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Ä°ptal</button>
    </div>
   </div>
  </div>
  <!-- Anamnez Template Modal (HEM AYARLARDAN HEM DETAY PANELLERÄ°NDEN ERÄ°ÅÄ°M Ä°Ã‡Ä°N) -->
  <div id="anamnez-template-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4" id="anam-template-modal-title">Anamnez Åablonu Ekle/DÃ¼zenle</h3>
    <div class="space-y-3">
     <div>
      <label class="block text-sm font-semibold mb-2">Åablon AdÄ±</label>
      <input id="anam-template-name" type="text" placeholder="Ã–rn: GÃ¶ÄŸÃ¼s AÄŸrÄ±sÄ± Åablonu" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
     </div>
     <div>
      <label class="block text-sm font-semibold mb-2">BÃ¶lÃ¼m</label>
      <select id="anam-template-section" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="complaint">GeliÅŸ Åikayeti</option> <option value="history">Hikayesi</option> <option value="examination">Fizik Muayene</option> <option value="procedures">YapÄ±lan Ä°ÅŸlemler</option> <option value="decision">Karar</option> </select>
     </div>
     <div>
      <label class="block text-sm font-semibold mb-2">Åablon Metni</label>
      <textarea id="anam-template-text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="6"></textarea>
     </div>
    </div>
    <div class="flex gap-3 mt-6">
     <button id="anam-template-save" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Kaydet</button>
     <button id="anam-template-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Ä°ptal</button>
    </div>
   </div>
  </div>
  <!-- Import JSON Modal (KALDIRILDI - ArtÄ±k Dosya YÃ¼kleniyor) -->

  <!-- Template Selector Modal (Issue 2/7: Anamnez Åablonu SeÃ§ici) -->
  <div id="template-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80%] overflow-y-auto">
    <h3 class="text-xl font-bold mb-4">Anamnez Åablonu SeÃ§ (BÃ¶lÃ¼m: <span id="current-template-section-name" class="text-indigo-600"></span>)</h3>
    <div id="template-selector-list" class="space-y-2 mb-4">
     <!-- Template options will be rendered here -->
    </div>
    <!-- 1. Ä°steÄŸe Eklenen Buton -->
    <button id="create-new-anamnesis-template" class="w-full mt-3 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" onclick="openAnamnesisTemplateModal(true)">
        + Yeni Åablon OluÅŸtur
    </button>
    <button id="template-selector-close" class="w-full mt-3 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="document.getElementById('template-selector-modal').classList.add('hidden')">Kapat</button>
   </div>
  </div>
  <!-- Test SonuÃ§ GiriÅŸi Modal -->
  <div id="test-result-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 id="test-result-title" class="text-xl font-bold mb-4">Tetkik Sonucu Girin</h3>
    <p id="test-result-info" class="text-sm text-gray-600 mb-4"></p>
    <textarea id="test-result-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="4" placeholder="Sonucu buraya girin..."></textarea>
    <div class="flex gap-3 mt-6">
     <button id="test-result-save" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Kaydet</button>
     <button onclick="document.getElementById('test-result-modal').classList.add('hidden')" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Ä°ptal</button>
    </div>
   </div>
  </div>
  <!-- Madde 1: Favori Kategori Modal -->
  <div id="favorite-category-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80%] overflow-y-auto">
    <h3 class="text-xl font-bold mb-4">Favori Kategorisi SeÃ§ / OluÅŸtur</h3>
    <p class="text-sm text-gray-600 mb-4">HastayÄ± eklemek istediÄŸiniz kategoriyi seÃ§in veya yeni bir kategori oluÅŸturun.</p>
    <div id="existing-categories-list" class="space-y-2 mb-4 max-h-40 overflow-y-auto border p-2 rounded">
     <!-- Existing categories will be rendered here -->
    </div>
    <div class="border-t pt-4 mt-4">
     <h4 class="font-semibold mb-2">Yeni Kategori OluÅŸtur</h4>
     <input id="new-category-name" type="text" placeholder="Kategori adÄ± (Ã¶rn: Kardiyoloji)" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-2">
     <button id="create-category-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"> OluÅŸtur ve KategorileÅŸtir </button>
    </div>
    <button id="favorite-category-close" class="w-full mt-3 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="document.getElementById('favorite-category-modal').classList.add('hidden')">Ä°ptal</button>
   </div>
  </div>

  <!-- Madde 2: Anamnez BÃ¼yÃ¼tme/Okuma ModalÄ± -->
  <div id="anamnesis-reader-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90%] overflow-y-auto">
    <div class="flex justify-between items-start mb-4">
     <h3 id="anam-reader-title" class="text-2xl font-bold text-indigo-700"></h3>
     <button onclick="document.getElementById('anamnesis-reader-modal').classList.add('hidden')" class="px-3 py-1 bg-gray-300 rounded-lg hover:bg-gray-400 text-sm"> âœ• Kapat </button>
    </div>
    <div class="bg-gray-50 p-4 rounded-lg">
     <pre id="anam-reader-content" class="whitespace-pre-wrap text-lg text-gray-800"></pre>
    </div>
   </div>
  </div>

  <!-- DiÄŸer Modallar (Korundu) -->
  <div id="anamnesis-detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90%] overflow-y-auto">
    <div class="flex justify-between items-start mb-4">
     <div>
      <h3 id="anam-detail-title" class="text-2xl font-bold"></h3>
      <p id="anam-detail-info" class="text-sm text-gray-600"></p>
     </div>
     <button id="anam-detail-close" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400"> âœ• Kapat </button>
    </div>
    <div id="anam-detail-content" class="space-y-4">
     <!-- Content will be rendered here -->
    </div>
   </div>
  </div>
  <div id="diagnosis-template-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Ã–n TanÄ± Åablonu</h3>
    <div class="space-y-3">
     <input id="diagnosis-template-name" type="text" placeholder="Ã–n TanÄ± AdÄ± (Ã¶rn: Akut Koroner Sendrom)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
    </div>
    <div class="flex gap-3 mt-6">
     <button id="diagnosis-template-save" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Kaydet</button>
     <button id="diagnosis-template-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Ä°ptal</button>
    </div>
   </div>
  </div>
  <div id="diagnosis-selector-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80%] overflow-y-auto">
    <h3 class="text-xl font-bold mb-4">Ã–n TanÄ± Åablonu SeÃ§</h3>
    <div id="diagnosis-selector-list" class="space-y-2 mb-4">
     <!-- Diagnosis templates will be rendered here -->
    </div>
    <button id="diagnosis-selector-close" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400" onclick="document.getElementById('diagnosis-selector-modal').classList.add('hidden')">Kapat</button>
   </div>
  </div>
  <div id="scoring-system-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
    <h3 class="text-xl font-bold mb-4">Skorlama Sistemi Ekle</h3>
    <div class="space-y-3">
     <div>
      <label class="block text-sm font-semibold mb-2">Skor AdÄ±</label>
      <input id="scoring-name" type="text" placeholder="Ã¶rn: HEART Skoru" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
     </div>
     <div>
      <label class="block text-sm font-semibold mb-2">Ã–n TanÄ± SeÃ§</label>
      <select id="scoring-diagnosis" class="w-full px-4 py-2 border border-gray-300 rounded-lg"> <option value="">Ã–n TanÄ± SeÃ§in</option> </select>
     </div>
    </div>
    <div class="flex gap-3 mt-6">
     <button id="scoring-system-save" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Kaydet</button>
     <button id="scoring-system-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Ä°ptal</button>
    </div>
   </div>
  </div>
  <div id="score-calculator-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90%] overflow-y-auto">
    <h3 id="score-calculator-title" class="text-xl font-bold mb-4"></h3>
    <div id="score-calculator-content" class="space-y-4">
     <!-- Calculator content will be rendered here -->
    </div>
    <div class="flex gap-3 mt-6">
     <button id="score-calculator-close" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Kapat</button>
    </div>
   </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification-container" class="fixed top-20 right-4 space-y-2 z-50" style="max-width: 400px;">
   <!-- Notifications will appear here -->
  </div>
  <script>
        const defaultConfig = {
            app_title: "Acil Hasta Takip Sistemi",
            scan_button_text: "Hasta Ekle"
        };

        /**
         * DÄ±ÅŸarÄ±dan ÅŸablon ve hesaplama motoru yÃ¼kleme (isteÄŸe baÄŸlÄ±).
         * KlasÃ¶r yapÄ±sÄ±: ./external/templates/*.json ve ./external/engines/*.js
         * EÄŸer bu dosyalar bulunursa yerel template'leri/engine'leri override eder.
         */
        async function loadExternalResources() {
            // JSON template dosyalarÄ±
            const base = './external';
            try {
                // anamnez
                const aResp = await fetch(`${base}/templates/anamnez_templates.json`);
                if (aResp.ok) {
                    const aJson = await aResp.json();
                    if (Array.isArray(aJson)) {
                        anamnezTemplates = aJson;
                        localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
                        console.info('External anamnez templates yÃ¼klendi.');
                    }
                }
            } catch (e) { console.info('anamnez_templates yok veya yÃ¼klenemedi'); }

            try {
                const tResp = await fetch(`${base}/templates/test_templates.json`);
                if (tResp.ok) {
                    const tJson = await tResp.json();
                    if (Array.isArray(tJson)) {
                        testTemplates = tJson;
                        localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
                        console.info('External test templates yÃ¼klendi.');
                    }
                }
            } catch (e) { console.info('test_templates yok veya yÃ¼klenemedi'); }

            try {
                const dResp = await fetch(`${base}/templates/diagnosis_templates.json`);
                if (dResp.ok) {
                    const dJson = await dResp.json();
                    if (Array.isArray(dJson)) {
                        diagnosisTemplates = dJson;
                        localStorage.setItem('diagnosisTemplates', JSON.stringify(diagnosisTemplates));
                        console.info('External diagnosis templates yÃ¼klendi.');
                    }
                }
            } catch (e) { console.info('diagnosis_templates yok veya yÃ¼klenemedi'); }

            try {
                const sResp = await fetch(`${base}/templates/scoring_systems.json`);
                if (sResp.ok) {
                    const sJson = await sResp.json();
                    if (Array.isArray(sJson)) {
                        scoringSystems = sJson;
                        localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
                        console.info('External scoring systems yÃ¼klendi.');
                    }
                }
            } catch (e) { console.info('scoring_systems yok veya yÃ¼klenemedi'); }

            // Fizik muayene ÅŸablonlarÄ±
            try {
                const peResp = await fetch(`${base}/templates/physical_exam_templates.json`);
                if (peResp.ok) {
                    const peJson = await peResp.json();
                    if (peJson.templates) {
                        physicalExamTemplates = peJson.templates;
                        localStorage.setItem('physicalExamTemplates', JSON.stringify(physicalExamTemplates));
                        console.info('External physical exam templates yÃ¼klendi.');
                    }
                }
            } catch (e) { console.info('physical_exam_templates yok veya yÃ¼klenemedi'); }

            // Hesaplama motorlarÄ± (JS modÃ¼lleri). Ã–rn: ./external/engines/heart.js
            try {
                // Kalp (HEART) motoru
                const heartModule = await import('./external/engines/heart.js');
                if (heartModule && typeof heartModule.calculateHEARTScore === 'function') {
                    window.calculateHEARTScore = heartModule.calculateHEARTScore;
                    console.info('External HEART engine yÃ¼klendi ve override edildi.');
                }
            } catch (e) { console.info('heart engine yok veya yÃ¼klenemedi'); }

            try {
                const edacsModule = await import('./external/engines/edacs.js');
                if (edacsModule && typeof edacsModule.calculateEDACSScore === 'function') {
                    window.calculateEDACSScore = edacsModule.calculateEDACSScore;
                    console.info('External EDACS engine yÃ¼klendi ve override edildi.');
                }
            } catch (e) { console.info('edacs engine yok veya yÃ¼klenemedi'); }

            try {
                const newsModule = await import('./external/engines/news.js');
                if (newsModule && typeof newsModule.calculateNEWS === 'function') {
                    window.calculateNEWS = newsModule.calculateNEWS;
                    console.info('External NEWS engine yÃ¼klendi ve override edildi.');
                }
            } catch (e) { console.info('news engine yok veya yÃ¼klenemedi'); }
        }

        let patients = [];
        let testTemplates = [];
        let anamnezTemplates = [];
        let diagnosisTemplates = [];
        let scoringSystems = [];
        let selectedPatient = null;
        let currentView = 'patients';
        let currentFilter = 'all';
        let currentAreaFilter = 'all'; 
        let currentAnamnesisStatusFilter = 'active'; // Yeni filtre iÃ§in varsayÄ±lan deÄŸer
        let physicalExamTemplates = {}; // Fizik muayene ÅŸablonlarÄ± (external/templates/physical_exam_templates.json'dan yÃ¼klenir)
        let currentSort = 'time';
        let testCheckInterval = null;
        let currentTemplateSection = ''; 
        let editingTemplateId = null;
        let currentResultEditTestIndex = -1; 
        
        // Local Storage AnahtarÄ±
        const LOCAL_STORAGE_PATIENT_KEY = 'patientRecords';

        // Issue 5: VarsayÄ±lan Vital deÄŸerleri
        const DEFAULT_VITALS = {
            vitals_temp: 36.5,
            vitals_pulse: 80,
            vitals_bp_systolic: 120,
            vitals_bp_diastolic: 80,
            vitals_resp_rate: 16,
            vitals_spo2: 98,
            vitals_gcs: 15,
            vitals_glucose: 100
        };

        // Issue 9: Alanlar iÃ§in renk ve ikon tanÄ±mlarÄ±
        const AREA_COLORS = {
            'ResÃ¼sitasyon': { color: '#ef4444', text: 'RESÃœSÄ°TASYON', icon: 'âš¡' }, 
            'KÄ±rmÄ±zÄ±': { color: '#f87171', text: 'KIRMIZI ALAN', icon: 'ğŸš¨' },
            'SarÄ±': { color: '#fbbf24', text: 'SARI ALAN', icon: 'âš ï¸' },
            'YeÅŸil': { color: '#34d399', text: 'YEÅÄ°L ALAN', icon: 'ğŸŸ¢' },
            'MÃ¼ÅŸahade': { color: '#60a5fa', text: 'MÃœÅAHADE', icon: 'ğŸ›Œ' },
            'DiÄŸer': { color: '#9ca3af', text: 'DÄ°ÄER', icon: 'ğŸ ' },
            'yok': { color: '#9ca3af', text: 'Alan BelirtilmemiÅŸ', icon: 'â“' }
        };

        const commonComplaints = [
            "GÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ±", "Nefes darlÄ±ÄŸÄ±", "KarÄ±n aÄŸrÄ±sÄ±", "BaÅŸ aÄŸrÄ±sÄ±", 
            "AteÅŸ", "BulantÄ±-kusma", "BaÅŸ dÃ¶nmesi", "BayÄ±lma", "Travma"
        ];

        const differentialDiagnoses = {
            "GÃ¶ÄŸÃ¼s aÄŸrÄ±sÄ±": "Akut koroner sendrom, Pulmoner emboli, Aort diseksiyonu, PnÃ¶motoraks, PnÃ¶moni, GERD, Kas-iskelet sistemi aÄŸrÄ±sÄ±",
            "Nefes darlÄ±ÄŸÄ±": "Akut kalp yetmezliÄŸi, AstÄ±m/KOAH alevlenmesi, Pulmoner emboli, PnÃ¶moni, PnÃ¶motoraks, Anafilaksi",
            "KarÄ±n aÄŸrÄ±sÄ±": "Akut apandisit, Kolesistit, Pankreatit, Perforasyon, BaÄŸÄ±rsak tÄ±kanÄ±klÄ±ÄŸÄ±, Ãœriner sistem taÅŸÄ±, Ektopik gebelik",
            "BaÅŸ aÄŸrÄ±sÄ±": "Migren, Gerilim tipi baÅŸaÄŸrÄ±sÄ±, SAK, Ä°ntrakraniyal kitle, Temporal arterit, Menenjit, Hipertansif acil",
            "AteÅŸ": "Bakteriyel/viral enfeksiyon, Sepsis, PnÃ¶moni, Ãœriner sistem enfeksiyonu, Menenjit, COVID-19",
            "BayÄ±lma": "Vazovagal senkop, Kardiyak aritmi, Ortostatik hipotansiyon, Strukturel kalp hastalÄ±ÄŸÄ±, NÃ¶rolojik nedenler"
        };

        const statusLabels = {
            "active": "Aktif", "discharged": "Taburcu", "admitted": "YatÄ±ÅŸ Verildi",
            "deceased": "Eksitus", "left_without_permission": "Ä°zinsiz Terk", "signed_discharge": "Ä°mzalÄ± Taburcu"
        };

        // Madde 1: TÃ¼m favori kategorilerini almak iÃ§in yardÄ±mcÄ± fonksiyon
        function getAllFavoriteCategories() {
            const categories = patients
                .filter(p => p.is_favorite && p.favorite_category)
                .map(p => p.favorite_category)
                .filter((value, index, self) => self.indexOf(value) === index) // Unique
                .sort();
            return categories;
        }

        // --- LOCAL STORAGE YÃ–NETÄ°MÄ° ---
        function dataUpdatedHandler() {
            if (currentView === 'patients') {
                renderPatientCards();
                if (selectedPatient) {
                    selectedPatient = patients.find(p => p.__backendId === selectedPatient.__backendId);
                    if (selectedPatient) {
                        renderDetailPanel(); 
                    } else {
                        closeDetailPanel();
                    }
                }
            } else if (currentView === 'favorites') {
                renderFavoritesView();
            } else if (currentView === 'anamnesis') {
                renderAnamnesisView();
            }
        }
        
        function savePatientsToLocalStorage() {
            localStorage.setItem(LOCAL_STORAGE_PATIENT_KEY, JSON.stringify(patients));
            dataUpdatedHandler(); 
        }

        function loadPatientsFromLocalStorage() {
            const data = localStorage.getItem(LOCAL_STORAGE_PATIENT_KEY);
            try {
                patients = data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Local storage'dan hasta verisi yÃ¼klenirken hata:", e);
                patients = [];
            }
            patients.forEach(p => {
                if (!p.__backendId) {
                    p.__backendId = Date.now().toString() + Math.random().toString(36).substring(2, 9);
                }
                // Issue 5: Vital deÄŸerlerini atama (Yeni eklenenler iÃ§in)
                if (!p.vitals_temp) {
                    Object.assign(p, DEFAULT_VITALS);
                }
                // Adli durum varsayÄ±lanÄ±
                if (typeof p.is_forensic === 'undefined') {
                    p.is_forensic = false;
                }
            });
            return patients;
        }
        
        function createPatientInLocalStorage(newPatient) {
            newPatient.__backendId = Date.now().toString() + Math.random().toString(36).substring(2, 9);
            // Issue 5: VarsayÄ±lan vitalleri ekle
            Object.assign(newPatient, DEFAULT_VITALS);
            // Yeni: Adli durum varsayÄ±lanÄ±
            newPatient.is_forensic = false; 

            patients.push(newPatient);
            savePatientsToLocalStorage();
            return { isOk: true, record: newPatient };
        }

        function updatePatientInLocalStorage(patientToUpdate) {
            const index = patients.findIndex(p => p.__backendId === patientToUpdate.__backendId);
            if (index !== -1) {
                patients[index] = patientToUpdate; 
                savePatientsToLocalStorage();
                return { isOk: true, record: patientToUpdate };
            } else {
                console.error("GÃ¼ncellenecek hasta bulunamadÄ±:", patientToUpdate);
                return { isOk: false, error: "Hasta bulunamadÄ±." };
            }
        }

        function deletePatientFromLocalStorage(patientToDelete) {
            patients = patients.filter(p => p.__backendId !== patientToDelete.__backendId);
            savePatientsToLocalStorage();
            return { isOk: true };
        }
        // --- LOCAL STORAGE YÃ–NETÄ°MÄ° SONU ---


        // --- YARDIMCI VE INIT FONKSÄ°YONLARI ---

        /**
         * HEART Skorunu hesaplar ve hastaya ekler, yorumu dÃ¶ndÃ¼rÃ¼r.
         */
        function calculateHEARTScore(patient, inputs) {
            let score = 0;
            score += parseInt(inputs.history_score || 0); 
            score += parseInt(inputs.ekg_score || 0);
            score += parseInt(inputs.age_score || 0); 
            score += parseInt(inputs.risk_score || 0); 
            score += parseInt(inputs.troponin_score || 0); 

            patient.heart_score = score;
            patient.heart_risk = score <= 3 ? 'DÃ¼ÅŸÃ¼k' : score <= 6 ? 'Orta' : 'YÃ¼ksek';
            
            const riskText = `(Risk: ${patient.heart_risk})`;

            // Skor yorumlarÄ±nÄ± otomatik olarak karara ekleme
            const decisionAnamnesisEl = document.getElementById('detail-anam-decision');
            if (decisionAnamnesisEl) {
                const scoreResultText = `HEART Skoru: ${score} - ${riskText}.`;
                let existingText = decisionAnamnesisEl.value || '';
                
                // Skor desenini kullanarak Ã¶nceki skoru bul ve deÄŸiÅŸtir
                const scorePattern = /HEART Skoru:.*?\.\s*(\n|$)/;
                
                if (existingText.includes('HEART Skoru:')) {
                    // Mevcut skor metnini gÃ¼ncelle
                    existingText = existingText.replace(scorePattern, scoreResultText + '\n').trim();
                } else {
                    // Score metnini en Ã¼ste ekle
                    existingText = scoreResultText + '\n\n' + existingText;
                }
                
                decisionAnamnesisEl.value = existingText.trim();
                selectedPatient.anamnesis_decision = existingText.trim();
            }
            
            return { score, riskText };
        }

        /**
         * EDACS Skoru (variant A): numeric age input, troponin excluded.
         * Uses an MDCalc-style age mapping and common EDACS components.
         * Please verify the point-table/thresholds against your reference.
         */
        function calculateEDACSScore(patient, inputs) {
            try {
                function toInt(v, fallback = 0) {
                    const n = parseInt(v);
                    return Number.isNaN(n) ? fallback : n;
                }

                const age = toInt(inputs.age, 0);
                // Age points mapping (MDCalc-like): <40:0, 40-49:2, 50-59:4, 60-69:6, >=70:8
                let agePoints = 0;
                if (age >= 70) agePoints = 8;
                else if (age >= 60) agePoints = 6;
                else if (age >= 50) agePoints = 4;
                else if (age >= 40) agePoints = 2;
                else agePoints = 0;

                const malePoints = toInt(inputs.male, 0) ? 1 : 0;
                const radiationPoints = toInt(inputs.radiation, 0) ? 1 : 0;
                const diaphoresisPoints = toInt(inputs.diaphoresis, 0) ? 1 : 0;
                const painSeverityPoints = Math.min(Math.max(toInt(inputs.pain_severity, 0), 0), 3);
                const riskFactorsPoints = Math.min(Math.max(toInt(inputs.risk_factors_count, 0), 0), 3);

                const score = agePoints + malePoints + radiationPoints + diaphoresisPoints + painSeverityPoints + riskFactorsPoints;

                let riskText = 'Bilinmiyor';
                if (score <= 8) riskText = 'DÃ¼ÅŸÃ¼k';
                else if (score <= 15) riskText = 'Orta';
                else riskText = 'YÃ¼ksek';

                if (patient) {
                    patient.edacs_score = score;
                    patient.edacs_risk = riskText;
                }

                appendScoreToDecision('EDACS Skoru', `EDACS Skoru: ${score} - ${riskText}.`);
                return { score, riskText };
            } catch (e) {
                console.error('calculateEDACSScore hata', e);
                return { score: 0, riskText: 'Bilinmiyor' };
            }
        }

        /**
         * YardÄ±mcÄ±: Skor sonucunu anamnez Karar bÃ¶lÃ¼mÃ¼ne ekle/gÃ¼ncelle
         * @param {string} scoreLabel - Skor adÄ± (Ã¶rn. "HEART Skoru", "TIMI Skoru")
         * @param {string} scoreText - Eklenecek tam metin (Ã¶rn. "HEART Skoru: 5 - YÃ¼ksek. ...")
         */
        function appendScoreToDecision(scoreLabel, scoreText) {
            try {
                const decisionEl = document.getElementById('detail-anam-decision');
                if (!decisionEl) return;
                
                let existingText = decisionEl.value || '';
                // Mevcut skor desenini bul (Ã¶rn. "HEART Skoru:" ile baÅŸlayan satÄ±r)
                const pattern = new RegExp(`${scoreLabel}:.*?\\.(\\n|$)`);
                
                if (existingText.includes(scoreLabel + ':')) {
                    // Varsa eski satÄ±rÄ± yeni ile deÄŸiÅŸtir
                    existingText = existingText.replace(pattern, scoreText + '\n');
                } else {
                    // Yoksa Ã¼ste ekle
                    existingText = scoreText + '\n\n' + existingText;
                }
                
                decisionEl.value = existingText.trim();
                if (selectedPatient) selectedPatient.anamnesis_decision = existingText.trim();
            } catch (e) {
                console.warn(`Score append error for ${scoreLabel}:`, e);
            }
        }

        /**
         * Skor Hesaplama ModalÄ±nÄ± aÃ§ar.
         */
        window.openScoreCalculator = function(scoreName) { 
            const modal = document.getElementById('score-calculator-modal');
            const titleEl = document.getElementById('score-calculator-title');
            const contentEl = document.getElementById('score-calculator-content');
            
            titleEl.textContent = `${scoreName} Hesaplama`;
            contentEl.innerHTML = '';
            
            if (scoreName === 'HEART Skoru') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <!-- History -->
                        <div>
                            <label class="block font-semibold mb-1">H - Hikaye/Anamnez (0-2 Puan)</label>
                            <select id="heart-history" class="w-full px-3 py-2 border rounded">
                                <option value="0">0 Puan: Belirgin DÃ¼ÅŸÃ¼k OlasÄ±lÄ±k</option>
                                <option value="1">1 Puan: Orta Derece OlasÄ±lÄ±k</option>
                                <option value="2">2 Puan: YÃ¼ksek OlasÄ±lÄ±k</option>
                            </select>
                        </div>
                        <!-- EKG -->
                        <div>
                            <label class="block font-semibold mb-1">E - EKG (0-2 Puan)</label>
                            <select id="heart-ekg" class="w-full px-3 py-2 border rounded">
                                <option value="0">0 Puan: Normal</option>
                                <option value="1">1 Puan: Non-spesifik deÄŸiÅŸiklikler</option>
                                <option value="2">2 Puan: Belirgin ST/T deÄŸiÅŸikliÄŸi</option>
                            </select>
                        </div>
                        <!-- Age -->
                        <div>
                            <label class="block font-semibold mb-1">A - YaÅŸ (0-2 Puan)</label>
                            <select id="heart-age" class="w-full px-3 py-2 border rounded">
                                <option value="0">0 Puan: < 65 yaÅŸ</option>
                                <option value="1">1 Puan: 65 - 80 yaÅŸ</option>
                                <option value="2">2 Puan: > 80 yaÅŸ</option>
                            </select>
                        </div>
                        <!-- Risk Factors -->
                        <div>
                            <label class="block font-semibold mb-1">R - Risk FaktÃ¶rleri (0-2 Puan)</label>
                            <select id="heart-risk" class="w-full px-3 py-2 border rounded">
                                <option value="0">0 Puan: Risk faktÃ¶rÃ¼ yok</option>
                                <option value="1">1 Puan: 1-2 risk faktÃ¶rÃ¼</option>
                                <option value="2">2 Puan: > 3 risk faktÃ¶rÃ¼ veya ciddi risk (DM, HT, Hiperlipidemi, Sigara, Aile Hikayesi)</option>
                            </select>
                        </div>
                        <!-- Troponin -->
                        <div>
                            <label class="block font-semibold mb-1">T - Troponin (0-2 Puan)</label>
                            <select id="heart-troponin" class="w-full px-3 py-2 border rounded">
                                <option value="0">0 Puan: Normal sÄ±nÄ±rlarda</option>
                                <option value="1">1 Puan: 1-3 kat arasÄ± yÃ¼ksek</option>
                                <option value="2">2 Puan: > 3 kat yÃ¼ksek</option>
                            </select>
                        </div>
                        
                        <div class="mt-4 flex flex-col gap-2">
                            <button id="calculate-heart" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Skoru Hesapla ve Karara Ekle</button>
                            <div id="heart-result" class="p-3 mt-2 bg-gray-100 rounded font-bold hidden"></div>
                        </div>
                    </div>
                `;
                
                document.getElementById('calculate-heart').addEventListener('click', () => {
                    const inputs = {
                        history_score: document.getElementById('heart-history').value,
                        ekg_score: document.getElementById('heart-ekg').value,
                        age_score: document.getElementById('heart-age').value,
                        risk_score: document.getElementById('heart-risk').value,
                        troponin_score: document.getElementById('heart-troponin').value
                    };
                    const result = calculateHEARTScore(selectedPatient, inputs); 
                    const resultEl = document.getElementById('heart-result');
                    
                    // Ã–n tanÄ±yÄ± otomatik olarak gÃ¼ncelle (EÄŸer boÅŸsa veya skorla uyumluysa)
                    if (!selectedPatient.preliminary_diagnosis || selectedPatient.preliminary_diagnosis === '') {
                        selectedPatient.preliminary_diagnosis = 'Akut Koroner Sendrom'; 
                        document.getElementById('detail-diagnosis').value = 'Akut Koroner Sendrom';
                    }
                    
                    selectedPatient.last_score = `${result.score} ${result.riskText}`; 

                    // Anamnez zaten calculateHEARTScore iÃ§inde gÃ¼ncellendi, ÅŸimdi kalanÄ± kaydedelim.
                    updatePatientInLocalStorage(selectedPatient); 

                    resultEl.textContent = `HEART Skoru: ${result.score} - Risk: ${selectedPatient.heart_risk}. Kaydedildi ve Karara eklendi.`;
                    resultEl.classList.remove('hidden');

                    // Ensure a single, correct HEART line is present in the decision/anamnesis
                    appendScoreToDecision('HEART Skoru', `HEART Skoru: ${result.score} - ${selectedPatient.heart_risk}.`);
                    renderDetailPanel(); 
                    showNotification('âœ… HEART Skoru hesaplandÄ±, karara eklendi ve kaydedildi!', 'success');
                });
                
                } else if (scoreName === 'EDACS Skoru') {
                    contentEl.innerHTML = `
                        <div class="space-y-3 text-sm">
                            <p class="text-xs text-gray-600">EDACS (Variant A): YaÅŸ giriniz, troponin bu varyantta hariÃ§ tutulmuÅŸtur.</p>
                            <div>
                                <label class="block font-semibold mb-1">YaÅŸ (yÄ±l)</label>
                                <input id="edacs-age" type="number" min="0" max="120" class="w-full px-3 py-2 border rounded" placeholder="Ã–rn: 57">
                            </div>
                            <div class="flex items-center gap-2">
                                <input id="edacs-male" type="checkbox" /> <label for="edacs-male" class="text-sm">Erkek (1 puan)</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input id="edacs-radiation" type="checkbox" /> <label for="edacs-radiation" class="text-sm">AÄŸrÄ±nÄ±n yayÄ±lmasÄ± (kol/Ã§ene/omuz) (1 puan)</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <input id="edacs-diaphoresis" type="checkbox" /> <label for="edacs-diaphoresis" class="text-sm">Terleme/soÄŸuk terleme (1 puan)</label>
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">AÄŸrÄ± ÅŸiddeti (0-3)</label>
                                <input id="edacs-painsev" type="number" min="0" max="3" value="0" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block font-semibold mb-1">Risk faktÃ¶rleri sayÄ±sÄ± (0-3)</label>
                                <input id="edacs-riskf" type="number" min="0" max="3" value="0" class="w-full px-3 py-2 border rounded">
                            </div>
                            <div class="mt-3">
                                <button id="calculate-edacs" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Skoru Hesapla ve Karara Ekle</button>
                                <div id="edacs-result" class="p-3 mt-2 bg-gray-100 rounded font-bold hidden"></div>
                            </div>
                        </div>
                    `;

                    document.getElementById('calculate-edacs').addEventListener('click', () => {
                        const inputs = {
                            age: document.getElementById('edacs-age').value,
                            male: document.getElementById('edacs-male').checked ? 1 : 0,
                            radiation: document.getElementById('edacs-radiation').checked ? 1 : 0,
                            diaphoresis: document.getElementById('edacs-diaphoresis').checked ? 1 : 0,
                            pain_severity: document.getElementById('edacs-painsev').value,
                            risk_factors_count: document.getElementById('edacs-riskf').value
                        };

                        const result = (typeof calculateEDACSScore === 'function') ? calculateEDACSScore(selectedPatient, inputs) : { score: 0, riskText: 'Bilinmiyor' };
                        const resultEl = document.getElementById('edacs-result');

                        if (!selectedPatient.preliminary_diagnosis || selectedPatient.preliminary_diagnosis === '') {
                            selectedPatient.preliminary_diagnosis = 'Akut Koroner Sendrom';
                            document.getElementById('detail-diagnosis').value = 'Akut Koroner Sendrom';
                        }

                        selectedPatient.last_score = `${result.score} ${result.riskText}`;
                        updatePatientInLocalStorage(selectedPatient);

                        resultEl.textContent = `EDACS Skoru: ${result.score} - Risk: ${result.riskText}. Kaydedildi ve Karara eklendi.`;
                        resultEl.classList.remove('hidden');

                        appendScoreToDecision('EDACS Skoru', `EDACS Skoru: ${result.score} - ${result.riskText}.`);
                        renderDetailPanel();
                        showNotification('âœ… EDACS Skoru hesaplandÄ±, karara eklendi ve kaydedildi!', 'success');
                    });

                } else if (scoreName === 'TIMI Skoru (ACS)') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">YaÅŸ â‰¥ 65 yaÅŸ mÄ±?</label>
                        <select id="timi-age" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0 puan)</option><option value="1">Evet (1 puan)</option></select></div>
                        <div><label class="block font-semibold mb-1">Risk faktÃ¶rleri var mÄ±? (HT, Kol, DM, Aile Hikayesi)</label>
                        <select id="timi-risk" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0 puan)</option><option value="1">Evet (1 puan)</option></select></div>
                        <div><label class="block font-semibold mb-1">Aspirin aldÄ± mÄ±?</label>
                        <select id="timi-aspirin" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0 puan)</option><option value="1">Evet (1 puan)</option></select></div>
                        <div><label class="block font-semibold mb-1">BaÅŸlangÄ±Ã§ ÅŸiddeti</label>
                        <select id="timi-severity" class="w-full px-3 py-2 border rounded"><option value="0">â‰¥ 2 episode ÅŸikayet iÃ§inde (0)</option><option value="1">1 episode (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">EKG deÄŸiÅŸiklikleri</label>
                        <select id="timi-ekg" class="w-full px-3 py-2 border rounded"><option value="0">Yok (0)</option><option value="1">ST deÄŸiÅŸikliÄŸi (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Kardiyak biyomarker yÃ¼ksek mi?</label>
                        <select id="timi-enzyme" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="1">Evet (1)</option></select></div>
                        <button id="calculate-timi" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="timi-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-timi').addEventListener('click', async () => {
                    try {
                        const timiModule = await import('./external/engines/timi.js');
                        const inputs = {
                            age_65_above: document.getElementById('timi-age').value,
                            risk_factors: document.getElementById('timi-risk').value,
                            aspirin_use: document.getElementById('timi-aspirin').value,
                            severity: document.getElementById('timi-severity').value,
                            ekg_changes: document.getElementById('timi-ekg').value,
                            enzyme_elevation: document.getElementById('timi-enzyme').value
                        };
                        const result = timiModule.calculateTIMIScore(inputs);
                        const resultEl = document.getElementById('timi-result');
                        resultEl.innerHTML = `<strong>TIMI Skoru: ${result.score}</strong><br/>Risk: ${result.risk}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');

                        // Append relevant results safely using helper. Only add lines when properties exist.
                        try {
                            if (result && typeof result === 'object') {
                                if (result.shockIndex !== undefined) {
                                    appendScoreToDecision('Shock Index', `Shock Index: ${result.shockIndex}${result.severity ? ' - ' + result.severity : ''}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                }
                                if (result.score !== undefined && result.risk !== undefined) {
                                    // TIMI primary line
                                    appendScoreToDecision('TIMI Skoru', `TIMI Skoru: ${result.score}${result.risk ? ' - ' + result.risk : ''}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                } else if (result.score !== undefined) {
                                    appendScoreToDecision('TIMI Skoru', `TIMI Skoru: ${result.score}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                }
                                if (result.qsofa !== undefined || result.qSOFA !== undefined || result.q_sofa !== undefined) {
                                    const q = result.qsofa ?? result.qSOFA ?? result.q_sofa;
                                    appendScoreToDecision('qSOFA', `qSOFA: ${q}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                } else if (result.qsofa_score !== undefined) {
                                    appendScoreToDecision('qSOFA', `qSOFA: ${result.qsofa_score}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                }
                                if (result.gcs !== undefined || result.category !== undefined) {
                                    const gcsVal = result.gcs ?? result.score;
                                    appendScoreToDecision('GCS', `GCS: ${gcsVal}/15${result.category ? ' - ' + result.category : ''}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                }
                                if (result.nihss !== undefined) {
                                    appendScoreToDecision('NIHSS Skoru', `NIHSS Skoru: ${result.nihss}${result.severity ? ' - ' + result.severity : ''}${result.interpretation ? '. ' + result.interpretation : ''}`);
                                }
                            }
                        } catch (e) { console.warn('TIMI-related decision append error:', e); }
                        // store last score summary if available
                        try { selectedPatient.last_score = `TIMI: ${result.score} (${result.risk || 'N/A'})`; } catch(e){}
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('TIMI hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'Wells Skoru (PE)') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">Klinik PE ÅŸÃ¼phesi</label>
                        <select id="wells-suspicion" class="w-full px-3 py-2 border rounded"><option value="0">DÃ¼ÅŸÃ¼k (0)</option><option value="1.5">Orta (1.5)</option><option value="3">YÃ¼ksek (3)</option></select></div>
                        <div><label class="block font-semibold mb-1">Kalp hÄ±zÄ± > 100 m/d</label>
                        <select id="wells-hr" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="1.5">Evet (1.5)</option></select></div>
                        <div><label class="block font-semibold mb-1">Ä°mobilizasyon/Cerrah (4 hafta iÃ§inde)</label>
                        <select id="wells-imob" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="1.5">Evet (1.5)</option></select></div>
                        <div><label class="block font-semibold mb-1">Hemoptizi</label>
                        <select id="wells-hemopt" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Klinik DVT belirtileri</label>
                        <select id="wells-dvt" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="3">Evet (3)</option></select></div>
                        <div><label class="block font-semibold mb-1">PE daha muhtemel tanÄ± (diÄŸerine gÃ¶re)</label>
                        <select id="wells-pe-likely" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r (0)</option><option value="3">Evet (3)</option></select></div>
                        <button id="calculate-wells" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="wells-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-wells').addEventListener('click', async () => {
                    try {
                        const wellsModule = await import('./external/engines/wells.js');
                        const inputs = {
                            clinical_suspicion: document.getElementById('wells-suspicion').value,
                            heart_rate: document.getElementById('wells-hr').value,
                            immobilization: document.getElementById('wells-imob').value,
                            hemoptysis: document.getElementById('wells-hemopt').value,
                            dvt_symptoms: document.getElementById('wells-dvt').value,
                            pe_diagnosis: document.getElementById('wells-pe-likely').value
                        };
                        const result = wellsModule.calculateWellsScore(inputs);
                        const resultEl = document.getElementById('wells-result');
                        resultEl.innerHTML = `<strong>Wells Skoru: ${result.score}</strong><br/>Risk: ${result.risk}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        try {
                            appendScoreToDecision('Wells Skoru', `Wells Skoru: ${result.score}${result.risk ? ' - ' + result.risk : ''}${result.interpretation ? '. ' + result.interpretation : ''}`);
                        } catch (e) { console.warn('Wells append error:', e); }
                        try { selectedPatient.last_score = `Wells: ${result.score} (${result.risk || 'N/A'})`; } catch(e){}
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('Wells hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'NIHSS Skoru') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">1a. BilinÃ§lilik (0-3)</label>
                        <select id="nihss-consciousness" class="w-full px-3 py-2 border rounded">
                            <option value="0">Alert, kesin</option><option value="1">Nicht alert, uyandÄ±rÄ±labilir</option><option value="2">UyandÄ±rÄ±lmaz, spinal reflex</option><option value="3">Unreactive</option>
                        </select></div>
                        <div><label class="block font-semibold mb-1">Sorulara cevap (0-2)</label>
                        <select id="nihss-questions" class="w-full px-3 py-2 border rounded"><option value="0">DoÄŸru cevap</option><option value="1">Partial cevap</option><option value="2">YanlÄ±ÅŸ cevap</option></select></div>
                        <div><label class="block font-semibold mb-1">Komutlara uyum (0-2)</label>
                        <select id="nihss-commands" class="w-full px-3 py-2 border rounded"><option value="0">Uyar</option><option value="1">Partial uyum</option><option value="2">Uyar deÄŸil</option></select></div>
                        <div><label class="block font-semibold mb-1">4. BakÄ±ÅŸ sapmasÄ± (0-2)</label>
                        <select id="nihss-gaze" class="w-full px-3 py-2 border rounded"><option value="0">Normal</option><option value="1">KÄ±smi sapma</option><option value="2">Tam sapma</option></select></div>
                        <div><label class="block font-semibold mb-1">5. GÃ¶rme alanÄ± (0-3)</label>
                        <select id="nihss-visual" class="w-full px-3 py-2 border rounded"><option value="0">Normal</option><option value="1">Quadrantanopsia</option><option value="2">Hemianopsia</option><option value="3">Bilateral gÃ¶rme kaybÄ±</option></select></div>
                        <button id="calculate-nihss" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="nihss-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-nihss').addEventListener('click', async () => {
                    try {
                        const nihssModule = await import('./external/engines/nihss.js');
                        const inputs = {
                            consciousness: document.getElementById('nihss-consciousness').value,
                            consciousness_questions: document.getElementById('nihss-questions').value,
                            consciousness_commands: document.getElementById('nihss-commands').value,
                            gaze: document.getElementById('nihss-gaze').value,
                            visual_fields: document.getElementById('nihss-visual').value
                        };
                        const result = nihssModule.calculateNIHSSScore(inputs);
                        const resultEl = document.getElementById('nihss-result');
                        resultEl.innerHTML = `<strong>NIHSS Skoru: ${result.score}</strong><br/>Åiddet: ${result.severity}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        // Append NIHSS to decision safely
                        try { appendScoreToDecision('NIHSS Skoru', `NIHSS Skoru: ${result.score}${result.severity ? ' - ' + result.severity : ''}${result.interpretation ? '. ' + result.interpretation : ''}`); } catch(e){}
                        selectedPatient.last_score = `NIHSS: ${result.score} (${result.severity})`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('NIHSS hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'Glasgow Koma SkalasÄ± (GCS)') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">E - GÃ¶z aÃ§ma (1-4)</label>
                        <select id="gcs-eye" class="w-full px-3 py-2 border rounded">
                            <option value="1">1 - HiÃ§</option><option value="2">2 - AÄŸrÄ±ya</option><option value="3">3 - Sese</option><option value="4">4 - Spontan</option>
                        </select></div>
                        <div><label class="block font-semibold mb-1">V - SÃ¶zel cevap (1-5)</label>
                        <select id="gcs-verbal" class="w-full px-3 py-2 border rounded">
                            <option value="1">1 - HiÃ§</option><option value="2">2 - GÃ¼rÃ¼ltÃ¼lÃ¼</option><option value="3">3 - Uygunsuz</option><option value="4">4 - Kafa karÄ±ÅŸÄ±klÄ±ÄŸÄ±</option><option value="5">5 - Oryante</option>
                        </select></div>
                        <div><label class="block font-semibold mb-1">M - Motor cevap (1-6)</label>
                        <select id="gcs-motor" class="w-full px-3 py-2 border rounded">
                            <option value="1">1 - HiÃ§</option><option value="2">2 - Ekstensor</option><option value="3">3 - FleksÃ¶r</option><option value="4">4 - AÄŸrÄ±dan Ã§ekme</option><option value="5">5 - Lokalize aÄŸrÄ±</option><option value="6">6 - UyarÄ±ya obey</option>
                        </select></div>
                        <button id="calculate-gcs" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="gcs-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-gcs').addEventListener('click', async () => {
                    try {
                        const gcsModule = await import('./external/engines/gcs.js');
                        const inputs = {
                            eye_opening: document.getElementById('gcs-eye').value,
                            verbal_response: document.getElementById('gcs-verbal').value,
                            motor_response: document.getElementById('gcs-motor').value
                        };
                        const result = gcsModule.calculateGCS(inputs);
                        const resultEl = document.getElementById('gcs-result');
                        resultEl.innerHTML = `<strong>GCS: ${result.score}/15</strong><br/>Kategori: ${result.category}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        try { appendScoreToDecision('GCS', `GCS: ${result.score}/15${result.category ? ' - ' + result.category : ''}${result.interpretation ? '. ' + result.interpretation : ''}`); } catch(e){}
                        selectedPatient.last_score = `GCS: ${result.score}`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('GCS hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'qSOFA Skoru') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">DÃ¼zensiz mentasyon/ÅŸuur azlÄ±ÄŸÄ±</label>
                        <select id="qsofa-mentation" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1 puan)</option></select></div>
                        <div><label class="block font-semibold mb-1">Sistolik TA < 100 mmHg</label>
                        <select id="qsofa-bp" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1 puan)</option></select></div>
                        <div><label class="block font-semibold mb-1">Solunum hÄ±zÄ± â‰¥ 22/dk</label>
                        <select id="qsofa-rr" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1 puan)</option></select></div>
                        <button id="calculate-qsofa" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="qsofa-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-qsofa').addEventListener('click', async () => {
                    try {
                        const qsofaModule = await import('./external/engines/qsofa.js');
                        const inputs = {
                            altered_mentation: document.getElementById('qsofa-mentation').value,
                            systolic_bp_below_100: document.getElementById('qsofa-bp').value,
                            respiratory_rate_above_22: document.getElementById('qsofa-rr').value
                        };
                        const result = qsofaModule.calculateQSOFA(inputs);
                        const resultEl = document.getElementById('qsofa-result');
                        resultEl.innerHTML = `<strong>qSOFA: ${result.score}/3</strong><br/>Risk: ${result.risk}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        try { appendScoreToDecision('qSOFA', `qSOFA: ${result.score}${result.risk ? ' - ' + result.risk : ''}${result.interpretation ? '. ' + result.interpretation : ''}`); } catch(e){}
                        selectedPatient.last_score = `qSOFA: ${result.score}`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('qSOFA hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'CURB-65 Skoru') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">KarmaÅŸÄ±klÄ±k (yeni ÅŸuur deÄŸiÅŸikliÄŸi)</label>
                        <select id="curb-confusion" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Ãœre > 7 mmol/L</label>
                        <select id="curb-urea" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Solunum hÄ±zÄ± â‰¥ 30/dk</label>
                        <select id="curb-rr" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Sistolik TA < 90 veya Diyastolik < 60</label>
                        <select id="curb-bp" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">YaÅŸ â‰¥ 65 yaÅŸ</label>
                        <select id="curb-age" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <button id="calculate-curb" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="curb-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-curb').addEventListener('click', async () => {
                    try {
                        const curbModule = await import('./external/engines/curb65.js');
                        const inputs = {
                            confusion: document.getElementById('curb-confusion').value,
                            urea_above_7: document.getElementById('curb-urea').value,
                            respiratory_rate_above_30: document.getElementById('curb-rr').value,
                            bp_low: document.getElementById('curb-bp').value,
                            age_above_65: document.getElementById('curb-age').value
                        };
                        const result = curbModule.calculateCURB65(inputs);
                        const resultEl = document.getElementById('curb-result');
                        resultEl.innerHTML = `<strong>CURB-65: ${result.score}/5</strong><br/>Åiddet: ${result.severity}<br/>Mortalite: ${result.mortality}<br/><div class="text-xs mt-2 text-gray-700">${result.recommendation}</div>`;
                        resultEl.classList.remove('hidden');
                        try { appendScoreToDecision('CURB-65', `CURB-65: ${result.score}${result.severity ? ' - ' + result.severity : ''}${result.recommendation ? '. ' + result.recommendation : ''}`); } catch(e){}
                        selectedPatient.last_score = `CURB-65: ${result.score}`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('CURB-65 hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'Glasgow-Blatchford Skoru') {
                contentEl.innerHTML = `
                        <div class="space-y-4 text-sm">
                            <div><label class="block font-semibold mb-1">Kan kusma (hematemez) puanÄ±</label>
                            <select id="gbs-blood_in_pr" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select></div>
                            <div><label class="block font-semibold mb-1">Melena puanÄ±</label>
                            <select id="gbs-melena" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option></select></div>
                            <div><label class="block font-semibold mb-1">Sistolik TA skoru (puan)</label>
                            <select id="gbs-sbp" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select></div>
                            <div><label class="block font-semibold mb-1">NabÄ±z skoru (puan)</label>
                            <select id="gbs-pulse" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option></select></div>
                            <div><label class="block font-semibold mb-1">Taze kan/FFP ihtiyacÄ± (puan)</label>
                            <select id="gbs-ffp" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option></select></div>
                            <div><label class="block font-semibold mb-1">Hemoglobin skoru (puan)</label>
                            <select id="gbs-hb" class="w-full px-3 py-2 border rounded"><option value="0">0</option><option value="1">1</option><option value="2">2</option></select></div>
                            <button id="calculate-gbs" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla ve Karara Ekle</button>
                            <div id="gbs-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                        </div>
                    `;

                    document.getElementById('calculate-gbs').addEventListener('click', async () => {
                        try {
                            const gbsModule = await import('./external/engines/glasgow_blatchford.js');
                            const inputs = {
                                blood_in_pr: document.getElementById('gbs-blood_in_pr').value,
                                melena: document.getElementById('gbs-melena').value,
                                systolic_bp: document.getElementById('gbs-sbp').value,
                                pulse_rate: document.getElementById('gbs-pulse').value,
                                fresh_frozen_plasma: document.getElementById('gbs-ffp').value,
                                hemoglobin: document.getElementById('gbs-hb').value
                            };
                            const result = gbsModule.calculateGlasgowBlatchford(inputs);
                            const resultEl = document.getElementById('gbs-result');
                            resultEl.innerHTML = `<strong>Glasgow-Blatchford Skoru: ${result.score}</strong><br/>Risk: ${result.risk}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                            resultEl.classList.remove('hidden');

                            // Karar bÃ¶lÃ¼mÃ¼ne ekle
                            const gbsText = `Glasgow-Blatchford Skoru: ${result.score} - ${result.risk}. ${result.interpretation}`;
                            appendScoreToDecision('Glasgow-Blatchford Skoru', gbsText);

                            selectedPatient.last_score = `GBS: ${result.score} (${result.risk})`;
                            updatePatientInLocalStorage(selectedPatient);
                            renderDetailPanel();
                            showNotification('âœ… Glasgow-Blatchford hesabÄ± yapÄ±ldÄ± ve karara eklendi!', 'success');
                        } catch (e) {
                            console.error('Glasgow-Blatchford hesaplama hatasÄ±:', e);
                            showNotification('âŒ Glasgow-Blatchford engine yÃ¼klenemedi veya hata oluÅŸtu.', 'error');
                        }
                    });

            } else if (scoreName === 'Alvarado Skoru') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">AÄŸrÄ±nÄ±n saÄŸ iliak bÃ¶lgeye gÃ¶Ã§Ã¼</label>
                        <select id="alv-migration" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">Ä°ÅŸtahsÄ±zlÄ±k</label>
                        <select id="alv-anorexia" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">BulantÄ±/Kusma</label>
                        <select id="alv-nausea" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">SaÄŸ iliak bÃ¶lge hassasiyeti</label>
                        <select id="alv-tenderness" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="2">Evet (2)</option></select></div>
                        <div><label class="block font-semibold mb-1">Rebound aÄŸrÄ±sÄ±</label>
                        <select id="alv-rebound" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">YÃ¼ksek ateÅŸ (â‰¥ 38.5Â°C)</label>
                        <select id="alv-temp" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="1">Evet (1)</option></select></div>
                        <div><label class="block font-semibold mb-1">LÃ¶kositoz (> 10,000)</label>
                        <select id="alv-wbc" class="w-full px-3 py-2 border rounded"><option value="0">HayÄ±r</option><option value="2">Evet (2)</option></select></div>
                        <button id="calculate-alvarado" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="alvarado-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-alvarado').addEventListener('click', async () => {
                    try {
                        const alvModule = await import('./external/engines/alvarado.js');
                        const inputs = {
                            migration_to_right_iliac: document.getElementById('alv-migration').value,
                            anorexia: document.getElementById('alv-anorexia').value,
                            nausea_vomiting: document.getElementById('alv-nausea').value,
                            tenderness_right_iliac: document.getElementById('alv-tenderness').value,
                            rebound_pain: document.getElementById('alv-rebound').value,
                            elevated_temperature: document.getElementById('alv-temp').value,
                            leukocytosis: document.getElementById('alv-wbc').value
                        };
                        const result = alvModule.calculateAlvarado(inputs);
                        const resultEl = document.getElementById('alvarado-result');
                        resultEl.innerHTML = `<strong>Alvarado: ${result.score}/10</strong><br/>OlasÄ±lÄ±k: ${result.likelihood}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        try { appendScoreToDecision('Alvarado Skoru', `Alvarado Skoru: ${result.score}${result.likelihood ? ' - ' + result.likelihood : ''}${result.interpretation ? '. ' + result.interpretation : ''}`); } catch(e){}
                        selectedPatient.last_score = `Alvarado: ${result.score}`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('Alvarado hesaplama hatasÄ±:', e); }
                });

            } else if (scoreName === 'Shock Index') {
                contentEl.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <div><label class="block font-semibold mb-1">Sistolik Tansiyon (mmHg)</label>
                        <input id="shock-sys" type="number" placeholder="120" class="w-full px-3 py-2 border rounded"></div>
                        <div><label class="block font-semibold mb-1">Kalp HÄ±zÄ± (atÄ±m/dk)</label>
                        <input id="shock-hr" type="number" placeholder="80" class="w-full px-3 py-2 border rounded"></div>
                        <button id="calculate-shock" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-4">Hesapla</button>
                        <div id="shock-result" class="p-3 mt-2 bg-blue-50 rounded hidden"></div>
                    </div>
                `;
                document.getElementById('calculate-shock').addEventListener('click', async () => {
                    try {
                        const shockModule = await import('./external/engines/shock_index.js');
                        const sys = parseFloat(document.getElementById('shock-sys').value);
                        const hr = parseFloat(document.getElementById('shock-hr').value);
                        const result = shockModule.calculateShockIndex(sys, hr);
                        const resultEl = document.getElementById('shock-result');
                        resultEl.innerHTML = `<strong>Shock Index: ${result.shockIndex}</strong><br/>Åiddet: ${result.severity}<br/><div class="text-xs mt-2 text-gray-700">${result.interpretation}</div>`;
                        resultEl.classList.remove('hidden');
                        try { appendScoreToDecision('Shock Index', `Shock Index: ${result.shockIndex}${result.severity ? ' - ' + result.severity : ''}${result.interpretation ? '. ' + result.interpretation : ''}`); } catch(e){}
                        selectedPatient.last_score = `Shock Index: ${result.shockIndex}`;
                        updatePatientInLocalStorage(selectedPatient);
                    } catch (e) { console.error('Shock Index hesaplama hatasÄ±:', e); }
                });

            } else {
                contentEl.innerHTML = `<p class="text-gray-600">Bu skor iÃ§in henÃ¼z hesaplama motoru tanÄ±mlanmamÄ±ÅŸtÄ±r.</p>`;
            }
            
            modal.classList.remove('hidden');
        };

        function getAllSettings() {
            return {
                testTemplates: testTemplates,
                anamnezTemplates: anamnezTemplates,
                diagnosisTemplates: diagnosisTemplates,
                scoringSystems: scoringSystems,
            };
        }
        
        /**
         * 1. Ä°stenen: JSON verilerini dosyaya indirme
         * @param {string} mode 'all', 'anamnez', 'test'
         */
        window.exportTemplateDataToFile = (mode) => {
            let dataToExport = {};
            let fileName = "";

            if (mode === 'anamnez') {
                dataToExport.anamnezTemplates = anamnezTemplates;
                fileName = "anamnez_sablonlari.json";
            } else if (mode === 'test') {
                dataToExport.testTemplates = testTemplates;
                fileName = "tetkik_sablonlari.json";
            } else {
                showNotification('âŒ GeÃ§ersiz dÄ±ÅŸa aktarma modu!', 'error');
                return;
            }

            const json = JSON.stringify(dataToExport, null, 2);
            downloadFile(json, fileName);
            showNotification(`âœ… ${fileName} dosyasÄ± indirildi!`, 'success');
        };

        window.exportAllDataToFile = () => {
            try {
                const allPatients = loadPatientsFromLocalStorage();
                const allSettings = getAllSettings();

                const exportData = {
                    metadata: {
                        app: defaultConfig.app_title,
                        version: '2.5', // SÃ¼rÃ¼m gÃ¼ncellendi
                        export_date: new Date().toISOString()
                    },
                    patients: allPatients.map(p => {
                        // __backendId alanÄ±nÄ± dÄ±ÅŸa aktarÄ±rken Ã§Ä±kar
                        const { __backendId, ...rest } = p;
                        return rest;
                    }),
                    settings: allSettings
                };

                const json = JSON.stringify(exportData, null, 2);
                const filename = 'acil_takip_yedek.json';
                downloadFile(json, filename);
                recordLastExportFilename(filename);
                showNotification('âœ… TÃ¼m veriler (Hastalar + Ayarlar) indirildi!', 'success');
            } catch (error) {
                console.error("TÃ¼m verileri dÄ±ÅŸa aktarma hatasÄ±:", error);
                showNotification('âŒ Veriler dÄ±ÅŸa aktarÄ±lamadÄ±!', 'error');
            }
        };

        /**
         * JSON verisini indirilebilir bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r.
         */
        function downloadFile(data, filename) {
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Record last exported filename for reuse
        function recordLastExportFilename(filename) {
            try { localStorage.setItem('lastExportFilename', filename); } catch (e) { console.warn('Could not save lastExportFilename', e); }
        }

        // Prepare export JSON string (same as exportAllDataToFile but returns string)
        function prepareExportJsonString() {
            const allPatients = loadPatientsFromLocalStorage();
            const allSettings = getAllSettings();
            const exportData = {
                metadata: {
                    app: defaultConfig.app_title,
                    version: '2.5',
                    export_date: new Date().toISOString()
                },
                patients: allPatients.map(p => {
                    const { __backendId, ...rest } = p; return rest;
                }),
                settings: allSettings
            };
            return JSON.stringify(exportData, null, 2);
        }

        // Share helpers: try Web Share API with file, fallback to URL schemes or copy-to-clipboard
        async function shareAllData(method) {
            try {
                const json = prepareExportJsonString();
                const filename = 'acil_takip_yedek.json';

                // Try Web Share with file if available
                if (navigator.canShare && navigator.canShare({ files: [new File([json], filename, { type: 'application/json' })] })) {
                    const file = new File([json], filename, { type: 'application/json' });
                    await navigator.share({ files: [file], title: 'Acil Takip YedeÄŸi', text: 'Acil Takip uygulamasÄ± yedeÄŸi' });
                    showNotification('âœ… PaylaÅŸÄ±m aracÄ± aÃ§Ä±ldÄ±.', 'success');
                    return;
                }

                // Fallbacks per method
                const encoded = encodeURIComponent(json);
                if (method === 'whatsapp') {
                    // WhatsApp: use wa.me link with text (may be large; browser will attempt)
                    const waUrl = `https://wa.me/?text=${encodeURIComponent('Acil Takip yedeÄŸi:\n')}` + '%0A' + encodeURIComponent(json);
                    window.open(waUrl, '_blank');
                    return;
                }
                if (method === 'mail') {
                    const subject = encodeURIComponent('Acil Takip YedeÄŸi');
                    // mailto body may be limited length â€” attach as inline text
                    const body = encodeURIComponent('Acil Takip uygulamasÄ± yedeÄŸi (JSON).\n--\n') + encoded;
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                    return;
                }
                if (method === 'signal') {
                    // Signal does not have a reliable web share URL across platforms.
                    // Try common deep link on Android; otherwise fallback to copying JSON to clipboard and instructing user to paste into Signal.
                    const signalUrl = `sgnl://send?text=${encoded}`;
                    // attempt open
                    const newWin = window.open(signalUrl, '_blank');
                    if (!newWin) {
                        // fallback: copy to clipboard
                        await copyToClipboard(json);
                        showNotification('ğŸ“‹ JSON panoya kopyalandÄ±. Signal uygulamasÄ±na yapÄ±ÅŸtÄ±rarak gÃ¶nderin.', 'info');
                    }
                    return;
                }

                // Default fallback: copy to clipboard
                await copyToClipboard(json);
                showNotification('ğŸ“‹ JSON iÃ§eriÄŸi panoya kopyalandÄ±. Ä°stediÄŸiniz uygulamaya yapÄ±ÅŸtÄ±rÄ±n.', 'info');
            } catch (e) {
                console.error('PaylaÅŸÄ±m hatasÄ±:', e);
                // As a last fallback, trigger download
                try { downloadFile(prepareExportJsonString(), 'acil_takip_yedek.json'); showNotification('âœ… JSON indirildi (fallback).', 'success'); } catch (err) { showNotification('âŒ PaylaÅŸÄ±m/indirme baÅŸarÄ±sÄ±z.', 'error'); }
            }
        }

        async function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            }
            // fallback
            const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); } finally { ta.remove(); }
        }

        // --- Auto-backup logic ---
        window._autoBackupTimer = null;
        window._autoBackupSettings = {
            enabled: false,
            intervalMinutes: 60,
            filename: 'acil_takip_yedek.json',
            mode: 'new' // 'new' or 'reuse'
        };

        function loadAutoBackupSettings() {
            try {
                const s = JSON.parse(localStorage.getItem('autoBackupSettings') || 'null');
                if (s) window._autoBackupSettings = Object.assign(window._autoBackupSettings, s);
            } catch (e) { console.warn('loadAutoBackupSettings', e); }
            // populate UI
            const en = document.getElementById('auto-backup-enabled'); if (en) en.checked = !!window._autoBackupSettings.enabled;
            const iv = document.getElementById('auto-backup-interval'); if (iv) iv.value = String(window._autoBackupSettings.intervalMinutes);
            const fn = document.getElementById('auto-backup-filename'); if (fn) fn.value = window._autoBackupSettings.filename || '';
            const modeNew = document.getElementById('auto-backup-mode-new'); const modeReuse = document.getElementById('auto-backup-mode-reuse');
            if (modeNew && modeReuse) { if (window._autoBackupSettings.mode === 'reuse') modeReuse.checked = true; else modeNew.checked = true; }
        }

        function saveAutoBackupSettings() {
            try {
                const en = document.getElementById('auto-backup-enabled'); window._autoBackupSettings.enabled = !!(en && en.checked);
                const iv = document.getElementById('auto-backup-interval'); window._autoBackupSettings.intervalMinutes = parseInt(iv ? iv.value : 60) || 60;
                const fn = document.getElementById('auto-backup-filename'); window._autoBackupSettings.filename = (fn && fn.value.trim()) ? fn.value.trim() : 'acil_takip_yedek.json';
                const modeNew = document.getElementById('auto-backup-mode-new'); window._autoBackupSettings.mode = (modeNew && modeNew.checked) ? 'new' : 'reuse';
                localStorage.setItem('autoBackupSettings', JSON.stringify(window._autoBackupSettings));
            } catch (e) { console.warn('saveAutoBackupSettings', e); }
        }

        function startAutoBackup() {
            stopAutoBackup();
            saveAutoBackupSettings();
            if (!window._autoBackupSettings.enabled) { showNotification('Otomatik yedekleme devre dÄ±ÅŸÄ±.', 'info'); return; }
            const mins = window._autoBackupSettings.intervalMinutes || 60;
            const ms = mins * 60 * 1000;
            window._autoBackupTimer = setInterval(() => { performAutoBackup(); }, ms);
            showNotification(`âœ… Otomatik yedekleme baÅŸlatÄ±ldÄ± (${mins} dakika aralÄ±klarla).`, 'success');
        }

        function stopAutoBackup() {
            if (window._autoBackupTimer) { clearInterval(window._autoBackupTimer); window._autoBackupTimer = null; showNotification('â¸ï¸ Otomatik yedekleme durduruldu.', 'info'); }
        }

        function performAutoBackup() {
            try {
                const json = prepareExportJsonString();
                let filename = 'acil_takip_yedek_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.json';
                if (window._autoBackupSettings.mode === 'reuse') {
                    const last = localStorage.getItem('lastExportFilename');
                    if (last) filename = last;
                    else filename = window._autoBackupSettings.filename || filename;
                } else {
                    // if user provided a filename template, use it (or fallback to timestamped)
                    const fn = window._autoBackupSettings.filename;
                    filename = fn && fn.trim() ? fn.trim() : filename;
                    // if using 'new' ensure uniqueness by suffixing timestamp
                    const nameParts = filename.split('.');
                    if (nameParts.length > 1) {
                        const ext = nameParts.pop();
                        const base = nameParts.join('.');
                        filename = `${base}_${(new Date()).toISOString().replace(/[:.]/g,'-')}.${ext}`;
                    } else {
                        filename = `${filename}_${(new Date()).toISOString().replace(/[:.]/g,'-')}`;
                    }
                }
                downloadFile(json, filename);
                recordLastExportFilename(filename);
                showNotification(`âœ… Otomatik yedekleme tamamlandÄ±: ${filename}`, 'success');
            } catch (e) {
                console.error('performAutoBackup hata', e);
                showNotification('âŒ Otomatik yedekleme baÅŸarÄ±sÄ±z oldu.', 'error');
            }
        }

        /**
         * 1. Ä°stenen: JSON dosyasÄ±ndan verileri iÃ§e aktarma
         */
        window.handleFileImport = (event, mode) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = e.target.result;
                    const data = JSON.parse(json);
                    
                    if (mode === 'all') {
                        importAllData(data);
                    } else if (mode === 'anamnez') {
                        if (data.anamnezTemplates && Array.isArray(data.anamnezTemplates)) {
                            anamnezTemplates = data.anamnezTemplates;
                            localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
                            window.renderAnamnesisSettings();
                            showNotification(`âœ… ${anamnezTemplates.length} Anamnez Åablonu iÃ§e aktarÄ±ldÄ±!`, 'success');
                        } else {
                            showNotification('âŒ GeÃ§ersiz Anamnez Åablonu JSON formatÄ±!', 'error');
                        }
                    } else if (mode === 'test') {
                        if (data.testTemplates && Array.isArray(data.testTemplates)) {
                            testTemplates = data.testTemplates;
                            localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
                            window.renderTestTemplatesSettings();
                            showNotification(`âœ… ${testTemplates.length} Tetkik Åablonu iÃ§e aktarÄ±ldÄ±!`, 'success');
                        } else {
                            showNotification('âŒ GeÃ§ersiz Tetkik Åablonu JSON formatÄ±!', 'error');
                        }
                    }
                } catch (error) {
                    console.error("Dosya iÅŸleme hatasÄ±:", error);
                    showNotification('âŒ Dosya okuma veya JSON ayrÄ±ÅŸtÄ±rma hatasÄ±!', 'error');
                }
            };
            reader.readAsText(file);
            // Input'u sÄ±fÄ±rla ki aynÄ± dosya tekrar yÃ¼klenebilsin
            event.target.value = ''; 
        };
        
        function importAllData(data) {
            if (data.settings) {
                importAllSettings(data.settings);
            } else {
                 showNotification('âš ï¸ Ayar verisi bulunamadÄ±, sadece hastalar aktarÄ±lacak.', 'info');
            }

            if (data.patients && Array.isArray(data.patients)) {
                patients = []; 
                const newPatients = data.patients.map(p => ({
                    // Yeni bir backendId oluÅŸturarak Ã§akÄ±ÅŸmalarÄ± engelle
                    __backendId: Date.now().toString() + Math.random().toString(36).substring(2, 9),
                    ...p,
                    created_at: p.created_at || new Date().toISOString(),
                    created_date: p.created_date || new Date().toLocaleDateString('tr-TR')
                }));
                
                patients = newPatients;
                savePatientsToLocalStorage();
                showNotification(`âœ… TÃ¼m veriler (Hastalar: ${newPatients.length} adet) baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!`, 'success');
            } else if (data.patients && data.patients.length === 0) {
                showNotification('âš ï¸ Ä°Ã§e aktarÄ±lacak hasta kaydÄ± bulunamadÄ±.', 'info');
            } else if (data.patients && !Array.isArray(data.patients)) {
                showNotification('âŒ Hasta verisi formatÄ± geÃ§ersiz (beklenen Array).', 'error');
            }
        }

        function importAllSettings(settingsData) {
            if (settingsData.testTemplates) {
                testTemplates = settingsData.testTemplates;
                localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
            }
            if (settingsData.anamnezTemplates) {
                anamnezTemplates = settingsData.anamnezTemplates;
                localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
            }
            if (settingsData.diagnosisTemplates) {
                diagnosisTemplates = settingsData.diagnosisTemplates;
                localStorage.setItem('diagnosisTemplates', JSON.stringify(diagnosisTemplates));
            }
            if (settingsData.scoringSystems) {
                scoringSystems = settingsData.scoringSystems;
                localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
            }
            
            window.renderSettingsSections();
            if (currentView === 'patients') renderDetailPanel();
        }

        function calculateNEWS(vitals) {
            let score = 0;
            const rr = parseInt(vitals.vitals_resp_rate);
            if (rr <= 8) score += 3; else if (rr <= 11) score += 1; else if (rr <= 20) score += 0; else if (rr <= 24) score += 2; else score += 3;
            const spo2 = parseInt(vitals.vitals_spo2);
            if (spo2 <= 91) score += 3; else if (spo2 <= 93) score += 2; else if (spo2 <= 95) score += 1;
            const systolic = parseInt(vitals.vitals_bp_systolic);
            if (systolic <= 90) score += 3; else if (systolic <= 100) score += 2; else if (systolic <= 110) score += 1; else if (systolic <= 219) score += 0; else score += 3;
            const pulse = parseInt(vitals.vitals_pulse);
            if (pulse <= 40) score += 3; else if (pulse <= 50) score += 1; else if (pulse <= 90) score += 0; else if (pulse <= 110) score += 1; else if (pulse <= 130) score += 2; else score += 3;
            const temp = parseFloat(vitals.vitals_temp);
            if (temp <= 35) score += 3; else if (temp <= 36) score += 1; else if (temp <= 38) score += 0; else if (temp <= 39) score += 1; else score += 2;
            const gcs = parseInt(vitals.vitals_gcs);
            if (gcs <= 8) score += 3; else if (gcs <= 14) score += (15 - gcs);
            return score;
        }

        function getNEWSRisk(score) {
            if (score === 0) return { level: 'DÃ¼ÅŸÃ¼k', class: 'news-low' };
            if (score <= 4) return { level: 'DÃ¼ÅŸÃ¼k-Orta', class: 'news-medium' };
            if (score <= 6) return { level: 'Orta', class: 'news-medium' };
            return { level: 'YÃ¼ksek', class: 'news-high' };
        }

        function getAbnormalVitalsWithValues(patient) {
            const abnormal = [];
            const rr = parseInt(patient.vitals_resp_rate);
            const spo2 = parseInt(patient.vitals_spo2);
            const systolic = parseInt(patient.vitals_bp_systolic);
            const diastolic = parseInt(patient.vitals_bp_diastolic);
            const pulse = parseInt(patient.vitals_pulse);
            const temp = parseFloat(patient.vitals_temp);
            const gcs = parseInt(patient.vitals_gcs);
            
            if (rr && (rr <= 8 || rr >= 25)) abnormal.push(`Solunum: ${rr}/dk`);
            if (spo2 && spo2 <= 95) abnormal.push(`SpO2: ${spo2}%`);
            if (systolic && (systolic <= 90 || systolic >= 220)) {
                const taStr = diastolic ? `${systolic}/${diastolic}` : `${systolic}`;
                abnormal.push(`TA: ${taStr} mmHg`);
            }
            if (pulse && (pulse <= 40 || pulse >= 131)) abnormal.push(`NabÄ±z: ${pulse}/dk`);
            if (temp && (temp <= 35 || temp >= 39.1)) abnormal.push(`AteÅŸ: ${temp}Â°C`);
            if (gcs && gcs < 15) abnormal.push(`GCS: ${gcs}`);
            
            return abnormal;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `px-4 py-3 rounded-lg shadow-lg text-white text-sm ${
                type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            }`;
            notification.style.wordWrap = 'break-word';
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => notification.remove(), 5000);
        }

        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showNotification('âœ… KopyalandÄ±!', 'success');
            } catch (err) {
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('âœ… KopyalandÄ± (Clipboard API)!', 'success');
                }).catch(() => {
                    showNotification('âŒ Kopyalama baÅŸarÄ±sÄ±z!', 'error');
                });
            }
            document.body.removeChild(textarea);
        }

        function checkTestTimings() {
            const now = Date.now();
            patients.forEach(patient => {
                if (patient.discharge_status !== 'active') return; 

                if (patient.tests_json) {
                    try {
                        const tests = JSON.parse(patient.tests_json);
                        let updated = false;
                        tests.forEach(test => {
                            if (!test.completed) {
                                const dueTime = new Date(test.dueTime).getTime();
                                const timeDiff = dueTime - now;
                                
                                if (timeDiff <= 0 && !test.notified) {
                                    showNotification(`â° ${patient.patient_name} - ${test.name} tetkik zamanÄ± geldi!`, 'info');
                                    test.notified = true;
                                    updated = true;
                                }
                                
                                if (test.resultCheckTimes) {
                                    test.resultCheckTimes.forEach(checkTime => {
                                        const checkTimeMs = new Date(checkTime.time).getTime();
                                        const checkDiff = checkTimeMs - now;
                                        if (checkDiff <= 0 && checkDiff > -60000 && !checkTime.notified) {
                                            showNotification(`ğŸ“‹ ${patient.patient_name} - ${test.name} sonuÃ§larÄ±nÄ± kontrol edin!`, 'info');
                                            checkTime.notified = true;
                                            updated = true;
                                        }
                                    });
                                }
                            }
                        });
                        if (updated) {
                            patient.tests_json = JSON.stringify(tests);
                            updatePatientInLocalStorage(patient);
                        }
                    } catch (e) { console.error("Test kontrol hatasÄ±:", e); }
                }
            });
        }

        function renderPatientCards() {
            const container = document.getElementById('patient-cards');
            let filteredPatients = [...patients];
            
            // Alan Filtrelemesi
            currentAreaFilter = document.getElementById('filter-area-select').value;
            if (currentAreaFilter !== 'all') {
                if (currentAreaFilter === 'yok') {
                    filteredPatients = filteredPatients.filter(p => !p.area_name || p.area_name === '');
                } else {
                    filteredPatients = filteredPatients.filter(p => p.area_name === currentAreaFilter);
                }
            }

            // Durum Filtrelemesi
            currentFilter = document.getElementById('filter-select').value;
            if (currentFilter === 'active') {
                filteredPatients = filteredPatients.filter(p => p.discharge_status === 'active');
            } else if (currentFilter === 'discharged') {
                filteredPatients = filteredPatients.filter(p => p.discharge_status === 'discharged');
            } else if (currentFilter === 'admitted') {
                filteredPatients = filteredPatients.filter(p => p.discharge_status === 'admitted');
            } else if (currentFilter === 'favorites') {
                filteredPatients = filteredPatients.filter(p => p.is_favorite);
            } else if (currentFilter === 'forensic') { // Yeni Adli Vaka Filtresi
                filteredPatients = filteredPatients.filter(p => p.is_forensic);
            }
            
            // YaÅŸa GÃ¶re SÄ±ralama
            currentSort = document.getElementById('sort-select').value;
            if (currentSort === 'name') {
                filteredPatients.sort((a, b) => a.patient_name.localeCompare(b.patient_name));
            } else if (currentSort === 'bed') {
                // Sort by bed number: try numeric part first then lexicographic
                const bedKey = (s) => {
                    const b = (s && s.bed_number) ? s.bed_number.toString().trim() : '';
                    const m = b.match(/(\d+)/);
                    const n = m ? parseInt(m[0], 10) : 9999;
                    return { num: n, raw: b };
                };
                filteredPatients.sort((a, b) => {
                    const A = bedKey(a), B = bedKey(b);
                    if (A.num !== B.num) return A.num - B.num;
                    return (A.raw || '').localeCompare(B.raw || '');
                });
            } else if (currentSort === 'age_desc') {
                filteredPatients.sort((a, b) => (b.age || 0) - (a.age || 0));
            } else if (currentSort === 'age_asc') {
                 filteredPatients.sort((a, b) => (a.age || 0) - (b.age || 0));
            } else if (currentSort === 'complaint') {
                filteredPatients.sort((a, b) => (a.chief_complaint || '').localeCompare(b.chief_complaint || ''));
            } else {
                filteredPatients.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            
            container.innerHTML = filteredPatients.map(patient => {
                const cardClass = `status-${patient.discharge_status || 'active'}`;
                const date = new Date(patient.created_at);
                const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const dateStr = patient.created_date;
                
                let pendingTests = 0;
                let dueTests = 0;
                let importantResults = [];
                let resultsDisplay = '';
                
                if (patient.tests_json) {
                    try {
                        const tests = JSON.parse(patient.tests_json);
                        const now = Date.now();
                        tests.forEach(test => {
                            if (!test.completed) {
                                pendingTests++;
                                if (new Date(test.dueTime).getTime() <= now) {
                                    dueTests++;
                                }
                            }
                            // Issue 4: SonuÃ§lar hasta kartÄ±nda gÃ¶rÃ¼nsÃ¼n
                            if (test.result && test.result.trim()) {
                                importantResults.push({ name: test.name, result: test.result });
                            }
                        });
                        
                        // Ä°mzalÄ± Taburcu ve Ä°zinsiz Terk metin rengini beyaz yaptÄ±ÄŸÄ±mÄ±z iÃ§in 
                        // sonuÃ§ div'inin arka planÄ±nÄ± da deÄŸiÅŸtirmeliyiz ki okunabilsin.
                        const isDarkStatus = patient.discharge_status === 'left_without_permission' || patient.discharge_status === 'signed_discharge';
                        const resultBgClass = isDarkStatus ? 'bg-white' : 'bg-purple-50';
                        const resultTextColor = isDarkStatus ? 'text-gray-800' : 'text-purple-700';

                        if (importantResults.length > 0) {
                            resultsDisplay = importantResults.map(r => 
                                `<div class="text-xs ${resultBgClass} p-2 rounded line-clamp-2">
                                    <span class="font-semibold text-purple-900">${r.name}:</span>
                                    <span class="${resultTextColor}">${r.result}</span>
                                </div>`
                            ).join('');
                        }
                    } catch (e) { console.error("Patient Card Test JSON hatasÄ±:", e); }
                }
                
                // Alan ve Yatak GÃ¶sterimi
                const area = patient.area_name || 'yok';
                const bed = patient.bed_number || '';
                const areaInfo = AREA_COLORS[area] || AREA_COLORS['DiÄŸer'];
                
                // Koyu zeminli kartlar iÃ§in alan bilgisinin renklerini ayarla
                const isDarkStatus = patient.discharge_status === 'left_without_permission' || patient.discharge_status === 'signed_discharge';
                const areaTextColor = isDarkStatus ? 'text-white' : 'text-gray-500';
                
                const areaHtml = area !== 'yok' ? `
                    <div style="background-color: ${areaInfo.color}20; color: ${isDarkStatus ? areaInfo.color : '#000000'}; border: 1px solid ${areaInfo.color};"
                        class="px-2 py-0.5 rounded-full text-xs font-bold flex items-center gap-1 mt-2">
                        ${areaInfo.icon} ${areaInfo.text} ${bed ? `(${bed})` : ''}
                    </div>
                ` : `<span class="text-xs ${areaTextColor} mt-2">${areaInfo.icon} ${areaInfo.text}</span>`;
                
                // Adli Vaka Ä°konu
                const forensicIcon = patient.is_forensic ? 
                    `<span class="forensic-icon" title="Adli Vaka (Polis)">ğŸš¨</span>` : '';

                return `
                    <div class="patient-card ${cardClass} rounded-lg p-4 cursor-pointer shadow-md" data-id="${patient.__backendId}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-2 flex-wrap">
                                    <h3 class="text-lg font-bold text-gray-800 truncate">${patient.patient_name}</h3>
                                    <span class="text-sm text-gray-600">${patient.age ? patient.age + ' yaÅŸ' : ''} ${patient.gender || ''}</span>
                                    <button class="text-yellow-500 hover:text-yellow-600 favorite-btn flex-shrink-0" data-id="${patient.__backendId}">
                                        ${patient.is_favorite ? 'â­' : 'â˜†'}
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600 mb-1 truncate">Dosya No: ${patient.file_number}</p>
                                <p class="text-sm text-gray-700 font-medium truncate">${patient.chief_complaint || 'Åikayet girilmedi'}</p>
                                <p class="text-xs text-gray-500 mt-2">${dateStr} - ${timeStr}</p>
                                ${areaHtml} 
                                ${pendingTests > 0 || importantResults.length > 0 ? `
                                    <div class="mt-2 flex flex-wrap gap-2 items-center">
                                        ${pendingTests > 0 ? `
                                            <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">
                                                ğŸ“‹ ${pendingTests} bekleyen tetkik
                                            </span>
                                        ` : ''}
                                        ${dueTests > 0 ? `
                                            <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs test-notification">
                                                â° ${dueTests} zamanÄ± geldi
                                            </span>
                                        ` : ''}
                                        ${importantResults.length > 0 ? `
                                            <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                                                ğŸ“ ${importantResults.length} sonuÃ§
                                            </span>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex flex-col gap-2 items-end flex-shrink-0">
                                ${patient.news_score > 0 ? `
                                    <div class="score-badge px-3 py-1 rounded-full text-sm font-bold ${getNEWSRisk(patient.news_score).class}">
                                        NEWS: ${patient.news_score}
                                    </div>
                                    ${getAbnormalVitalsWithValues(patient).length > 0 ? `
                                        <div class="text-xs text-red-600 font-semibold text-right max-w-xs">
                                            ${getAbnormalVitalsWithValues(patient).map(v => `âš ï¸ ${v}`).join('<br>')}
                                        </div>
                                    ` : ''}
                                ` : ''}
                                <span class="text-xs font-semibold text-gray-600">${statusLabels[patient.discharge_status || 'active']}</span>
                                ${resultsDisplay ? `
                                    <div class="mt-2 space-y-1 text-right max-w-xs">
                                        ${resultsDisplay}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        ${forensicIcon} 
                    </div>
                `;
            }).join('');
            
            container.querySelectorAll('.patient-card').forEach(card => {
                // long-press to enter multi-select; click toggles selection when in multi-select mode
                let longPressTimer = null;
                const id = card.dataset.id;

                const startLongPress = (ev) => {
                    if (window.multiSelectMode) return; // already in mode
                    longPressTimer = setTimeout(() => {
                        window.enterMultiSelectMode(id);
                    }, 600);
                };
                const cancelLongPress = (ev) => { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } };

                card.addEventListener('mousedown', startLongPress);
                card.addEventListener('touchstart', startLongPress, { passive: true });
                card.addEventListener('mouseup', cancelLongPress);
                card.addEventListener('mouseleave', cancelLongPress);
                card.addEventListener('touchend', cancelLongPress);

                card.addEventListener('click', (e) => {
                        if (e.target.classList.contains('favorite-btn')) return; // favorite handled separately
                        // Shift+click to start/ toggle multi-select on desktop without long-press
                        if (e.shiftKey) {
                            e.stopPropagation();
                            if (!window.multiSelectMode) window.enterMultiSelectMode(id);
                            window.toggleSelectCard(id);
                            return;
                        }
                        if (window.multiSelectMode) {
                            e.stopPropagation();
                            window.toggleSelectCard(id);
                            return;
                        }
                        const pid = card.dataset.id;
                        selectedPatient = patients.find(p => p.__backendId === pid);
                        renderDetailPanel();
                });
            });
            
            container.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.dataset.id;
                    const patient = patients.find(p => p.__backendId === id);
                    if (patient) {
                        if (patient.is_favorite) {
                            patient.is_favorite = false;
                            patient.favorite_category = '';
                            updatePatientInLocalStorage(patient);
                        } else {
                            window.openFavoriteCategorySelector(id); 
                        }
                    }
                });
            });
        }

        function renderScoringButtons() {
            const container = document.getElementById('scoring-buttons');
            if (!container || !selectedPatient) return;
            
            const diagnosis = document.getElementById('detail-diagnosis').value;
            const relevantScores = scoringSystems.filter(s => s.diagnosis === diagnosis);
            
            if (relevantScores.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-500">Bu Ã¶n tanÄ± iÃ§in skorlama sistemi tanÄ±mlanmamÄ±ÅŸ.</p>`;
                return;
            }
            
            container.innerHTML = relevantScores.map(score => `
                <button onclick="openScoreCalculator('${score.name}')" 
                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">
                    ğŸ“Š ${score.name}
                </button>
            `).join('');
        }

        // Multi-select state
        window.multiSelectMode = false;
        window.multiSelected = new Set();

        window.enterMultiSelectMode = (initialId) => {
            window.multiSelectMode = true;
            if (initialId) window.multiSelected.add(initialId);
            document.getElementById('multi-action-toolbar').style.display = 'flex';
            updateMultiSelectionUI();
        };

        window.exitMultiSelectMode = () => {
            window.multiSelectMode = false;
            window.multiSelected.clear();
            document.getElementById('multi-action-toolbar').style.display = 'none';
            updateMultiSelectionUI();
        };

        window.toggleSelectCard = (id) => {
            if (!window.multiSelectMode) return;
            if (window.multiSelected.has(id)) window.multiSelected.delete(id); else window.multiSelected.add(id);
            updateMultiSelectionUI();
        };

        // Select or toggle all currently visible patient cards
        window.selectAllVisible = () => {
            // ensure we're in multi-select mode
            if (!window.multiSelectMode) window.enterMultiSelectMode();

            const cards = Array.from(document.querySelectorAll('.patient-card'));
            const visibleCards = cards.filter(card => {
                if (!card) return false;
                if (card.offsetParent === null) return false;
                const s = window.getComputedStyle(card);
                if (s.display === 'none' || s.visibility === 'hidden' || s.opacity === '0') return false;
                return true;
            });

            const visibleIds = visibleCards.map(c => c.dataset.id).filter(Boolean);
            if (visibleIds.length === 0) return;

            // Toggle behavior: if all visible already selected, unselect them; otherwise select all
            const allSelected = visibleIds.every(id => window.multiSelected.has(id));
            if (allSelected) {
                visibleIds.forEach(id => window.multiSelected.delete(id));
            } else {
                visibleIds.forEach(id => window.multiSelected.add(id));
            }

            updateMultiSelectionUI();
        };

        function updateMultiSelectionUI() {
            // update toolbar count
            const count = window.multiSelected.size;
            const countEl = document.getElementById('multi-count');
            if (countEl) countEl.textContent = `${count} seÃ§ildi`;

            // update card visuals
            document.querySelectorAll('.patient-card').forEach(card => {
                const id = card.dataset.id;
                if (window.multiSelected.has(id)) {
                    card.classList.add('selected-card');
                    if (!card.querySelector('.select-badge')) {
                        const badge = document.createElement('div'); badge.className = 'select-badge'; badge.textContent = 'âœ“'; card.appendChild(badge);
                    }
                } else {
                    card.classList.remove('selected-card');
                    const b = card.querySelector('.select-badge'); if (b) b.remove();
                }
            });
            // show/hide toolbar
            const toolbar = document.getElementById('multi-action-toolbar');
            if (toolbar) toolbar.style.display = count > 0 || window.multiSelectMode ? 'flex' : 'none';
        }

        // Actions: delete and discharge
        window.deleteSelectedPatients = () => {
            if (window.multiSelected.size === 0) return;
            if (!confirm(`${window.multiSelected.size} hasta kalÄ±cÄ± olarak silinsin mi?`)) return;
            const ids = Array.from(window.multiSelected);
            // keep a temporary backup for undo
            window._bulkDeleteBackup = patients.filter(p => ids.includes(p.__backendId));
            // remove now
            patients = patients.filter(p => !ids.includes(p.__backendId));
            savePatientsToLocalStorage();
            exitMultiSelectMode();
            renderPatientCards();
            showNotification('âœ… SeÃ§ili hastalar silindi.', 'success');

            // Show undo toast for 6 seconds
            const toast = document.getElementById('bulk-undo-toast');
            const text = document.getElementById('bulk-undo-text');
            if (text) text.textContent = `${window._bulkDeleteBackup.length} hasta silindi. Geri almak iÃ§in 'Geri Al' butonuna basÄ±n.`;
            if (toast) toast.style.display = 'block';
            // set timeout to clear backup
            if (window._bulkDeleteTimeout) clearTimeout(window._bulkDeleteTimeout);
            window._bulkDeleteTimeout = setTimeout(() => {
                window._bulkDeleteBackup = null;
                if (toast) toast.style.display = 'none';
            }, 6000);
        };

        window.dischargeSelectedPatients = () => {
            if (window.multiSelected.size === 0) return;
            if (!confirm(`${window.multiSelected.size} hasta taburcu edilsin mi?`)) return;
            const ids = Array.from(window.multiSelected);
            patients.forEach(p => { if (ids.includes(p.__backendId)) { p.discharge_status = 'discharged'; } });
            savePatientsToLocalStorage();
            exitMultiSelectMode();
            renderPatientCards();
            showNotification('âœ… SeÃ§ili hastalar taburcu edildi.', 'success');
        };

        // Attach toolbar buttons
        document.addEventListener('click', (e) => {
            const del = document.getElementById('multi-delete');
            const dis = document.getElementById('multi-discharge');
            const cancel = document.getElementById('multi-cancel');
            const selectVisible = document.getElementById('multi-select-visible');
            if (del && e.target === del) { e.preventDefault(); window.deleteSelectedPatients(); }
            if (dis && e.target === dis) { e.preventDefault(); window.dischargeSelectedPatients(); }
            if (cancel && e.target === cancel) { e.preventDefault(); window.exitMultiSelectMode(); }
            if (selectVisible && e.target === selectVisible) { e.preventDefault(); window.selectAllVisible(); }
        });

        // Bulk undo handler
        document.getElementById('bulk-undo-btn').addEventListener('click', (e) => {
            e.preventDefault();
            const toast = document.getElementById('bulk-undo-toast');
            if (window._bulkDeleteBackup && Array.isArray(window._bulkDeleteBackup)) {
                // restore
                const restored = window._bulkDeleteBackup;
                patients = patients.concat(restored);
                // optional: sort by created_at to restore order roughly
                patients.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
                savePatientsToLocalStorage();
                renderPatientCards();
                showNotification('â†©ï¸ Silinen hastalar geri alÄ±ndÄ±.', 'success');
            }
            window._bulkDeleteBackup = null;
            if (window._bulkDeleteTimeout) { clearTimeout(window._bulkDeleteTimeout); window._bulkDeleteTimeout = null; }
            if (toast) toast.style.display = 'none';
        });
        
        // Issue 5: Ä°nteraktif Vital GiriÅŸi iÃ§in yardÄ±mcÄ± fonksiyon
        function setupInteractiveVitals() {
            const sliders = document.querySelectorAll('.vital-slider');
            sliders.forEach(slider => {
                if (slider.dataset.listenersAdded) return;
                slider.dataset.listenersAdded = 'true';

                const min = parseFloat(slider.min || slider.getAttribute('min')) || 0;
                const max = parseFloat(slider.max || slider.getAttribute('max')) || 100;

                const display = document.getElementById(slider.id + '-display');
                const updateDisplay = (val) => {
                    if (display) display.textContent = val;
                    const pct = ((parseFloat(val) - min) / (max - min)) * 100;
                    slider.style.setProperty('--pct', pct + '%');
                    slider.classList.add('filled');
                    slider.style.background = `linear-gradient(90deg, #2563eb ${pct}%, #e5e7eb ${pct}%)`;
                };

                // initialize
                updateDisplay(slider.value);

                // live update while dragging
                slider.addEventListener('input', (e) => {
                    updateDisplay(e.target.value);
                });

                // save when user releases (change fires on release for range inputs)
                slider.addEventListener('change', (e) => {
                    updateDisplay(e.target.value);
                    try { window.calculateAndSaveVitals(false); } catch (err) { console.warn('calculateAndSaveVitals hata:', err); }
                });
            });
        }

        function renderDetailPanel() {
            if (!selectedPatient) {
                document.getElementById('detail-panel').classList.add('hidden');
                return;
            }
            
            const panel = document.getElementById('detail-panel');
            panel.classList.remove('hidden');

            if (window.innerWidth <= 768) {
                panel.classList.add('mobile-full-screen');
            } else {
                panel.classList.remove('mobile-full-screen');
            }
            
            const diffDiag = differentialDiagnoses[selectedPatient.chief_complaint] || '';
            
            
            
            let testsHtml = '';
            if (selectedPatient.tests_json) {
                try {
                    const tests = JSON.parse(selectedPatient.tests_json);
                    const now = Date.now();
                    testsHtml = tests.map((test, index) => {
                        const dueTime = new Date(test.dueTime);
                        const isPast = dueTime.getTime() <= now;
                        const statusClass = test.completed ? 'completed' : (isPast ? 'due' : '');
                        
                        let resultChecksHtml = '';
                        if (test.resultCheckTimes && test.resultCheckTimes.length > 0) {
                            resultChecksHtml = `
                                <div class="ml-4 mt-2 space-y-1">
                                    ${test.resultCheckTimes.map((check, checkIndex) => `
                                        <div class="flex items-center gap-2 text-xs">
                                            <input type="checkbox" ${check.checked ? 'checked' : ''} 
                                                onchange="toggleResultCheck('${selectedPatient.__backendId}', ${index}, ${checkIndex})"
                                                class="w-4 h-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500">
                                            <span class="${check.checked ? 'line-through text-gray-400' : 'text-gray-600'}">
                                                SonuÃ§ kontrolÃ¼: ${new Date(check.time).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="test-item ${statusClass} p-3 rounded mb-2 shadow-sm">
                                <div class="flex justify-between items-center flex-wrap">
                                    <div class="flex-1 min-w-[50%]">
                                        <div class="flex items-center gap-2">
                                            <input type="checkbox" ${test.completed ? 'checked' : ''} 
                                                onchange="toggleTestComplete('${selectedPatient.__backendId}', ${index})"
                                                class="w-4 h-4 rounded text-green-600 border-gray-300 focus:ring-green-500">
                                            <span class="font-semibold ${test.completed ? 'line-through text-gray-400' : 'text-gray-800'}">${test.name}</span>
                                            ${isPast && !test.completed ? '<span class="text-red-600 text-xs font-bold">â° ZAMANI GELDÄ°</span>' : ''}
                                        </div>
                                        <div class="text-xs text-gray-600 ml-6">
                                            Saat: ${dueTime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                        </div>
                                        ${test.result ? `
                                            <div class="ml-6 mt-1 text-sm text-purple-700 font-medium bg-purple-50 p-1 rounded">
                                                ğŸ“ SonuÃ§: ${test.result}
                                            </div>
                                        ` : ''}
                                        ${resultChecksHtml}
                                    </div>
                                    <button onclick="openTestResultModal('${selectedPatient.__backendId}', ${index})" 
                                        class="px-3 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-700 mt-2 md:mt-0">
                                        ${test.result ? 'DÃ¼zenle' : 'SonuÃ§ Ekle'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (e) { console.error("Detail Panel Test JSON hatasÄ±:", e); }
            }
            
            panel.innerHTML = `
                <div class="relative mb-4 md:mb-6">
                    <div class="pr-12"> 
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">${selectedPatient.patient_name}</h2>
                        <p class="text-sm text-gray-600">${selectedPatient.age} yaÅŸ, ${selectedPatient.gender} - Dosya: ${selectedPatient.file_number}</p>
                    </div>
                    <button onclick="closeDetailPanel()" style="position:absolute; top:1cm; right:0.6rem; z-index:50;" class="inline-flex items-center justify-center w-10 h-10 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-700">
                        âœ•
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <!-- Chief Complaint -->
                        <div style="position:relative;">
                            <label class="block font-semibold mb-2">GeliÅŸ Åikayeti</label>
                            <div class="flex gap-2 mb-2 flex-wrap">
                                ${commonComplaints.map(c => `
                                    <button onclick="setComplaint('${c}')" 
                                        class="quick-complaint-btn px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-xs hover:bg-blue-200 shadow-sm">
                                        ${c}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="detail-complaint" value="${selectedPatient.chief_complaint || ''}" 
                                    onchange="autoUpdateAnamnesisAndSave()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                <button id="detail-complaint-presets-btn" onclick="toggleComplaintPresets(event)" title="HazÄ±r ÅŸikayetler" class="px-2 py-1 bg-gray-100 rounded-md hover:bg-gray-200">â‹¯</button>
                            </div>
                            <div id="complaint-presets" class="complaint-presets hidden" style="display:none;">
                                ${commonComplaints.map(c => `
                                    <button onclick="setComplaint('${c}'); document.getElementById('complaint-presets').style.display='none'">${c}</button>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Vitals (collapsible, default collapsed) -->
                        <div class="collapsible" data-section="vitals">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title text-blue-700">ğŸ“Š Vital Bulgular</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="space-y-3 bg-blue-50 p-3 rounded-lg">
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸŒ¡ï¸ AteÅŸ (Â°C)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-temp" class="vital-slider" type="range" min="30" max="42" step="0.1" value="${selectedPatient.vitals_temp || DEFAULT_VITALS.vitals_temp}" />
                                            <div id="detail-temp-display" class="vital-value">${selectedPatient.vitals_temp || DEFAULT_VITALS.vitals_temp}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ’“ NabÄ±z (/dk)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-pulse" class="vital-slider" type="range" min="0" max="250" step="1" value="${selectedPatient.vitals_pulse || DEFAULT_VITALS.vitals_pulse}" />
                                            <div id="detail-pulse-display" class="vital-value">${selectedPatient.vitals_pulse || DEFAULT_VITALS.vitals_pulse}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ’¨ Sistolik TA (mmHg)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-bp-sys" class="vital-slider" type="range" min="40" max="250" step="1" value="${selectedPatient.vitals_bp_systolic || DEFAULT_VITALS.vitals_bp_systolic}" />
                                            <div id="detail-bp-sys-display" class="vital-value">${selectedPatient.vitals_bp_systolic || DEFAULT_VITALS.vitals_bp_systolic}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ’¨ Diastol TA (mmHg)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-bp-dia" class="vital-slider" type="range" min="30" max="200" step="1" value="${selectedPatient.vitals_bp_diastolic || DEFAULT_VITALS.vitals_bp_diastolic}" />
                                            <div id="detail-bp-dia-display" class="vital-value">${selectedPatient.vitals_bp_diastolic || DEFAULT_VITALS.vitals_bp_diastolic}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ« Solunum (/dk)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-resp" class="vital-slider" type="range" min="4" max="40" step="1" value="${selectedPatient.vitals_resp_rate || DEFAULT_VITALS.vitals_resp_rate}" />
                                            <div id="detail-resp-display" class="vital-value">${selectedPatient.vitals_resp_rate || DEFAULT_VITALS.vitals_resp_rate}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ« SpOâ‚‚ (%)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-spo2" class="vital-slider" type="range" min="70" max="100" step="1" value="${selectedPatient.vitals_spo2 || DEFAULT_VITALS.vitals_spo2}" />
                                            <div id="detail-spo2-display" class="vital-value">${selectedPatient.vitals_spo2 || DEFAULT_VITALS.vitals_spo2}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ§  GCS (15)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-gcs" class="vital-slider" type="range" min="3" max="15" step="1" value="${selectedPatient.vitals_gcs || DEFAULT_VITALS.vitals_gcs}" />
                                            <div id="detail-gcs-display" class="vital-value">${selectedPatient.vitals_gcs || DEFAULT_VITALS.vitals_gcs}</div>
                                        </div>
                                    </div>
                                    <div class="vital-row">
                                        <div class="vital-label">ğŸ¬ Kan Åekeri (mg/dL)</div>
                                        <div class="slider-wrapper">
                                            <input id="detail-glucose" class="vital-slider" type="range" min="40" max="500" step="5" value="${selectedPatient.vitals_glucose || DEFAULT_VITALS.vitals_glucose}" />
                                            <div id="detail-glucose-display" class="vital-value">${selectedPatient.vitals_glucose || DEFAULT_VITALS.vitals_glucose}</div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="calculateAndSaveVitals()" 
                                    class="mt-2 w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    âœ… Vitalleri Kaydet
                                </button>
                            </div>
                        </div>

                        <!-- NEWS Skoru Hesapla -->
                        <div class="bg-gradient-to-r from-indigo-50 to-blue-50 p-4 rounded-lg border-2 border-indigo-300">
                            <label class="block font-semibold mb-3 text-indigo-700">ğŸ“ˆ NEWS (National Early Warning Score)</label>
                            <button onclick="calculateAndSaveVitals(true)" 
                                class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold text-base">
                                ğŸ”„ NEWS Hesapla & Kaydet
                            </button>
                            <div id="news-result" class="mt-3 p-3 bg-white rounded-lg border border-indigo-200 text-sm" style="display: none;">
                                <p class="font-semibold text-indigo-800"><span id="news-score-value">-</span> Puan</p>
                                <p class="text-gray-700 mt-1"><span id="news-risk-level">-</span></p>
                            </div>
                        </div>

                        <!-- Ã–zgeÃ§miÅŸ (Medical History) - parent collapsible -->
                        <div class="collapsible" data-section="medical-history">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title font-semibold">ğŸ§¾ Ã–zgeÃ§miÅŸ</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">

                                <!-- Ek HastalÄ±klar (Comorbidities) -->
                                <div class="collapsible" data-section="comorbidities">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title text-red-700">ğŸ¥ Ek HastalÄ±klar</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    ${['Diyabetes', 'Hipertansiyon', 'KAH', 'KOAH', 'AstÄ±m', 'BÃ¶brek HastalÄ±ÄŸÄ±', 'KaraciÄŸer HastalÄ±ÄŸÄ±', 'Kanser', 'Epilepsi', 'Parkinson', 'Alzheimer'].map(c => `
                                        <button onclick="toggleComorbidity('${c}')" 
                                            class="comorbidity-btn px-3 py-1 bg-red-100 text-red-700 rounded-lg text-xs hover:bg-red-200 shadow-sm transition"
                                            data-comorbidity="${c}">
                                            ${c}
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="text" id="detail-comorbidities" placeholder="DiÄŸer hastalÄ±klar (virgÃ¼lle ayÄ±rarak)" 
                                    value="${selectedPatient.comorbidities || ''}"
                                    onchange="updateAnamnesisField()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Ä°laÃ§lar (Medications) -->
                        <div class="collapsible" data-section="medications">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title text-green-700">ğŸ’Š KullanÄ±lan Ä°laÃ§lar</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    ${['Aspirin', 'Metoprolol', 'Lisinopril', 'Metformin', 'Ä°nsulin', 'Statin', 'Warfarin', 'Omeprazol'].map(c => `
                                        <button onclick="toggleMedication('${c}')" 
                                            class="medication-btn px-3 py-1 bg-green-100 text-green-700 rounded-lg text-xs hover:bg-green-200 shadow-sm transition"
                                            data-medication="${c}">
                                            ${c}
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="text" id="detail-medications" placeholder="DiÄŸer ilaÃ§lar (virgÃ¼lle ayÄ±rarak)" 
                                    value="${selectedPatient.medications || ''}"
                                    onchange="updateAnamnesisField()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Operasyonlar (Surgeries) -->
                        <div class="collapsible" data-section="surgeries">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title text-yellow-700">ğŸ”ª GeÃ§irilen Operasyonlar</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    ${['Apendektomi', 'Kolesistektomi', 'Histerektomi', 'Prostatektomi', 'By-pass', 'Stent', 'Vasektomi'].map(c => `
                                        <button onclick="toggleSurgery('${c}')" 
                                            class="surgery-btn px-3 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-xs hover:bg-yellow-200 shadow-sm transition"
                                            data-surgery="${c}">
                                            ${c}
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="text" id="detail-surgeries" placeholder="DiÄŸer operasyonlar (virgÃ¼lle ayÄ±rarak)" 
                                    value="${selectedPatient.surgeries || ''}"
                                    onchange="updateAnamnesisField()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Ä°laÃ§ Alerjileri (Drug Allergies) -->
                        <div class="collapsible" data-section="allergies">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title text-purple-700">âš ï¸ Ä°laÃ§ Alerjileri</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    ${['Penisilin', 'Sulfa', 'Aspirin', 'NSAID', 'ACE InhibitÃ¶r', 'Statin', 'KontrastlÄ± Madde'].map(c => `
                                        <button onclick="toggleAllergy('${c}')" 
                                            class="allergy-btn px-3 py-1 bg-purple-100 text-purple-700 rounded-lg text-xs hover:bg-purple-200 shadow-sm transition"
                                            data-allergy="${c}">
                                            ${c}
                                        </button>
                                    `).join('')}
                                </div>
                                <input type="text" id="detail-allergies" placeholder="DiÄŸer alerjiler (virgÃ¼lle ayÄ±rarak)" 
                                    value="${selectedPatient.allergies || ''}"
                                    onchange="updateAnamnesisField()"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>
                            </div>
                        </div>
                                    </button>
                                </div>
                            </div>
                            ${selectedPatient.news_score > 0 ? `
                                <div class="mt-2 p-3 ${getNEWSRisk(selectedPatient.news_score).class} rounded-lg shadow-md">
                                    <div class="font-bold">NEWS Skoru: ${selectedPatient.news_score}</div>
                                    <div class="text-sm">Risk: ${getNEWSRisk(selectedPatient.news_score).level}</div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- Preliminary Diagnosis (collapsible) -->
                        <div class="collapsible" data-section="preliminary-diagnosis">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title">Ã–n TanÄ± (Skor Motoru)</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="detail-diagnosis" value="${selectedPatient.preliminary_diagnosis || ''}"
                                        onchange="renderScoringButtons(); savePatientDetails();"
                                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <button onclick="openDiagnosisTemplateSelector()" 
                                        class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-sm">
                                        ğŸ“‹
                                    </button>
                                </div>
                                ${diffDiag ? `
                                    <div class="text-xs text-gray-600 p-2 bg-gray-50 rounded shadow-sm">
                                        <strong>AyÄ±rÄ±cÄ± tanÄ±:</strong> ${diffDiag}
                                    </div>
                                ` : ''}
                                <div id="scoring-buttons" class="mt-2 flex flex-wrap gap-2">
                                    <!-- Scoring buttons will be rendered here (Issue 1) -->
                                </div>
                            </div>
                        </div>

                        <!-- Test Templates and Active Tests (collapsible) -->
                        <div class="collapsible" data-section="tests">
                            <div class="collapsible-header" onclick="toggleCollapsible(event, this)">
                                <span class="title">Tetkik Åablonu Uygula</span>
                                <button class="collapsible-toggle" aria-expanded="false">â–¸</button>
                            </div>
                            <div class="collapsible-content">
                                <div class="flex gap-2 mb-2">
                                    <select id="test-template-select" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                        <option value="">Åablon SeÃ§in</option>
                                        ${testTemplates.map((t, i) => `<option value="${i}">${t.name}</option>`).join('')}
                                    </select>
                                    <button onclick="applyTestTemplate()" 
                                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                        Uygula
                                    </button>
                                </div>
                               <div class="mb-2">
                                   <label class="block text-sm font-semibold mb-1">Yeni Tetkikler (her satÄ±r yeni bir tetkik)</label>
                                   <textarea id="detail-tests-free" rows="3" placeholder="Ã–rnek:\nEKG\nTroponin" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"></textarea>
                                   <div class="mt-2 flex gap-2">
                                       <button id="detail-add-tests" onclick="addFreeTextTests()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">+ Ekle</button>
                                       <button onclick="document.getElementById('detail-tests-free').value=''" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">Temizle</button>
                                   </div>
                               </div>
                            </div>
                        </div>
                        
                        ${testsHtml ? `
                            <div>
                                <label class="block font-semibold mb-2">Aktif Tetkikler</label>
                                <div class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-lg bg-gray-50">
                                    ${testsHtml}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Right Column (Anamnesis & Karar - Issue 4) -->
                    <div class="space-y-4">
                        <!-- Adli Vaka KontrolÃ¼ -->
                        <div class="p-3 bg-red-50 rounded-lg border border-red-200 flex items-center justify-between">
                            <label for="detail-is-forensic" class="font-semibold text-red-700 flex items-center gap-2 cursor-pointer">
                                ğŸš¨ Adli Vaka (Polis)
                            </label>
                            <input type="checkbox" id="detail-is-forensic" ${selectedPatient.is_forensic ? 'checked' : ''} 
                                onchange="savePatientDetails()"
                                class="w-6 h-6 rounded text-red-600 border-red-300 focus:ring-red-500">
                        </div>

                        <!-- Issue 4: Yeni 5 Anamnez KutucuÄŸu GÃ¶rÃ¼nÃ¼mÃ¼ (Grid) -->
                        <div class="anamnez-sections-grid gap-4">
                            ${['complaint', 'history', 'examination', 'procedures', 'decision'].map(section => {
                                    const labelMap = {
                                        'complaint': 'GeliÅŸ Åikayeti',
                                        'history': 'Hikayesi',
                                        'examination': 'Fizik Muayene',
                                        'procedures': 'YapÄ±lan Ä°ÅŸlemler',
                                        'decision': 'Karar'
                                    };
                                    const fieldName = `anamnesis_${section}`;
                                    // Issue 4: Her kutuya kopyalama butonu
                                    return `
                                        <div class="bg-gray-50 p-3 rounded-lg shadow-inner border border-gray-200 flex flex-col h-full">
                                            <div class="flex justify-between items-start mb-1">
                                                <span class="text-xs font-semibold text-gray-600">${labelMap[section]}</span>
                                                <div class="flex gap-2">
                                                    <!-- 1. Ä°stenen DeÄŸiÅŸiklik: Åablon Ekle/SeÃ§ Butonu -->
                                                    <button onclick="openTemplateSelector('${section}')" 
                                                        class="template-icon text-purple-600 hover:text-purple-800 text-xs flex-shrink-0" title="Åablon Ekle">
                                                        ğŸ“
                                                    </button>
                                                    <button onclick="copyAnamnesisSection('${fieldName}')" 
                                                        class="template-icon text-gray-500 hover:text-gray-700 text-xs flex-shrink-0" title="Bu BÃ¶lÃ¼mÃ¼ Kopyala">
                                                        ğŸ“‹
                                                    </button>
                                                    <button onclick="toggleSpeechToText('detail-anam-${section}', event)" 
                                                        data-mic-target="detail-anam-${section}"
                                                        class="template-icon mic-btn text-green-600 hover:text-green-800 text-xs flex-shrink-0" title="KonuÅŸarak yaz">
                                                        ğŸ¤
                                                    </button>
                                                    <button onclick="refineTextWithAI('detail-anam-${section}', '${labelMap[section]}')" 
                                                    class="template-icon text-indigo-600 hover:text-indigo-800 text-xs flex-shrink-0 ml-1" title="Yapay Zeka ile DÃ¼zenle (TÄ±bbi & Hukuki)">
                                                    ğŸ§ 
                                                    </button>
                                                    <span id="mic-indicator-detail-anam-${section}" class="mic-indicator hidden" style="display:none; align-items:center; gap:6px;">
                                                        <span class="mic-dot" aria-hidden="true"></span>
                                                        <span class="mic-wave" aria-hidden="true">
                                                            <span class="bar b1"></span>
                                                            <span class="bar b2"></span>
                                                            <span class="bar b3"></span>
                                                            <span class="bar b4"></span>
                                                            <span class="bar b5"></span>
                                                        </span>
                                                        <button class="mic-small-btn" onclick="stopSpeechToText('detail-anam-${section}'); event.stopPropagation();" title="Durdur">â¹</button>
                                                        <button class="mic-small-btn" onclick="clearAnamnesisField('detail-anam-${section}'); event.stopPropagation();" title="Temizle">âœ–</button>
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="flex gap-2 flex-1">
                                                <textarea id="detail-anam-${section}" 
                                                    class="flex-1 px-2 py-1 border border-gray-300 rounded-lg text-sm resize-none" rows="6"
                                                    onchange="saveDetailAnamnesis()">${selectedPatient[fieldName] || ''}</textarea>
                                                ${section === 'examination' ? `
                                                    <div class="flex flex-col gap-1 justify-start pt-1">
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm" onclick="insertExamTemplate('head', 'detail-anam-examination')" title="Kafa muayenesi">ğŸ§ </button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm" onclick="insertExamTemplate('thorax', 'detail-anam-examination')" title="Toraks muayenesi">ğŸ«€</button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-cyan-100 text-cyan-700 rounded hover:bg-cyan-200 text-sm" onclick="insertExamTemplate('lungs', 'detail-anam-examination')" title="AkciÄŸer muayenesi">ğŸ’¨</button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200 text-sm" onclick="insertExamTemplate('abdomen', 'detail-anam-examination')" title="Abdomen muayenesi">ğŸ«”</button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm" onclick="insertExamTemplate('extremities', 'detail-anam-examination')" title="Ekstremite muayenesi">ğŸ¦µ</button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-pink-100 text-pink-700 rounded hover:bg-pink-200 text-sm" onclick="insertExamTemplate('skin', 'detail-anam-examination')" title="Cilt muayenesi">ğŸ©¹</button>
                                                        <button type="button" class="exam-region-btn px-2 py-1 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-sm" onclick="insertExamTemplate('oropharynx', 'detail-anam-examination')" title="Orofarenks muayenesi">ğŸ‘„</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                        </div>
                        <!-- Issue 4: TÃ¼m Anamnezi Kopyala Butonu -->
                        <button onclick="copyAllAnamnesisFromDetail()" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 shadow-lg mt-4">
                            ğŸ“‹ TÃ¼m Anamnezi Tek Metin Olarak Kopyala
                        </button>
                        
                        <!-- Discharge Status / Category -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block font-semibold mb-2">Hasta Durumu</label>
                                <select id="detail-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="active" ${selectedPatient.discharge_status === 'active' ? 'selected' : ''}>Aktif</option>
                                    <option value="discharged" ${selectedPatient.discharge_status === 'discharged' ? 'selected' : ''}>Taburcu</option>
                                    <option value="admitted" ${selectedPatient.discharge_status === 'admitted' ? 'selected' : ''}>YatÄ±ÅŸ Verildi</option>
                                    <option value="deceased" ${selectedPatient.discharge_status === 'deceased' ? 'selected' : ''}>Eksitus</option>
                                    <option value="left_without_permission" ${selectedPatient.discharge_status === 'left_without_permission' ? 'selected' : ''}>Ä°zinsiz Terk</option>
                                    <option value="signed_discharge" ${selectedPatient.discharge_status === 'signed_discharge' ? 'selected' : ''}>Ä°mzalÄ± Taburcu</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Favori Kategorisi</label>
                                <input type="text" id="detail-category" value="${selectedPatient.favorite_category || ''}"
                                    placeholder="Kardiyoloji, GIS, NÃ¶roloji"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <!-- Issue 9: Alan ve Yatak GÃ¼ncelleme -->
                            <div>
                                <label class="block font-semibold mb-2">Alan</label>
                                <select id="detail-area" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="">Alan SeÃ§in (Opsiyonel)</option>
                                    ${Object.keys(AREA_COLORS).filter(k => k !== 'DiÄŸer').map(area => `<option value="${area}" ${selectedPatient.area_name === area ? 'selected' : ''}>${AREA_COLORS[area].text}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Yatak/Oda No</label>
                                <input type="text" id="detail-bed-number" value="${selectedPatient.bed_number || ''}"
                                    placeholder="Oda/Yatak No"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                        </div>

                        <!-- Save & Delete Buttons -->
                        <button onclick="savePatientDetails()" 
                            class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 shadow-lg mt-4">
                            ğŸ’¾ DeÄŸiÅŸiklikleri Kaydet
                        </button>
                        <button onclick="deletePatient()" 
                            class="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 shadow-lg">
                            ğŸ—‘ï¸ HastayÄ± Sil
                        </button>
                    </div>
                </div>
            `;
            
            // Issue 5: Ä°nteraktif inputlarÄ± baÄŸla
            setupInteractiveVitals();

            // Skor butonlarÄ±nÄ± render etmeyi unutmayalÄ±m.
            renderScoringButtons(); 

            // Preserve which collapsible sections were open across re-renders
            try {
                const prevOpen = Array.from(panel.querySelectorAll('.collapsible.open')).map(c => c.dataset.section).filter(Boolean);
                // After rendering, restore open state.
                // Priority: if the user explicitly toggled a section, honor that (userCollapsibleState)
                panel.querySelectorAll('.collapsible').forEach(c => {
                    const section = c.dataset.section;
                    const btn = c.querySelector('.collapsible-toggle');
                    const userState = window.userCollapsibleState && Object.prototype.hasOwnProperty.call(window.userCollapsibleState, section) ? window.userCollapsibleState[section] : null;
                    const shouldBeOpen = userState !== null ? !!userState : prevOpen.includes(section);
                    if (shouldBeOpen) {
                        c.classList.add('open');
                        if (btn) { btn.setAttribute('aria-expanded', 'true'); btn.textContent = 'â–¾'; }
                    } else {
                        c.classList.remove('open');
                        if (btn) { btn.setAttribute('aria-expanded', 'false'); btn.textContent = 'â–¸'; }
                    }
                });
            } catch (e) { console.warn('Could not restore collapsible state', e); }

            // preserve panel scroll (we won't forcibly reset to top)
        }

        
        // Issue 5: Vital veya Åikayet deÄŸiÅŸtiÄŸinde Anamnez'i otomatik gÃ¼ncelle ve kaydet.
        window.autoUpdateAnamnesisAndSave = () => {
            if (!selectedPatient) return;

            const newComplaint = document.getElementById('detail-complaint').value;
            selectedPatient.chief_complaint = newComplaint;
            
            const complaintAnamnesisEl = document.getElementById('detail-anam-complaint');
            if (complaintAnamnesisEl) {
                // Åikayet bilgisini anamnez metninin en baÅŸÄ±na ekle/gÃ¼ncelle
                let existingText = complaintAnamnesisEl.value.trim();
                const vitalPattern = /(AteÅŸ:.*NEWS Skoru:.*?\)).*/s; // Vital bilgisini iÃ§eren patern
                
                let updatedText = newComplaint;
                
                // EÄŸer mevcut metin vital bilgisini iÃ§eriyorsa, onu koru ve ÅŸikayeti en Ã¼ste koy
                const match = existingText.match(vitalPattern);
                if (match) {
                     // Vital bilgisi zaten varsa, onu koruyarak ÅŸikayeti ayÄ±r
                    updatedText = newComplaint + '\n\n' + match[0].trim();
                } else if (existingText.includes('AteÅŸ:')) {
                     // Sadece vital varsa, yeni ÅŸikayeti en Ã¼ste koy
                     updatedText = newComplaint + '\n\n' + existingText.substring(existingText.indexOf('AteÅŸ:')).trim();
                } else {
                     updatedText = newComplaint;
                }

                complaintAnamnesisEl.value = updatedText.trim();
                selectedPatient.anamnesis_complaint = updatedText.trim();
            }

            updatePatientInLocalStorage(selectedPatient);
            showNotification('âœ… Åikayet gÃ¼ncellendi ve Anamneze aktarÄ±ldÄ±!', 'success');
        };

        // Issue 5: Vitals artÄ±k GeliÅŸ Åikayetine (anamnesis_complaint) ekleniyor.
        window.calculateAndSaveVitals = (showNotificationFlag = true) => {
            if (!selectedPatient) return;
            
            // Inputlardan deÄŸerleri al ve boÅŸsa varsayÄ±lanÄ± kullan (ancak inputta boÅŸ gÃ¶rÃ¼nÃ¼rse kalsÄ±n)
            selectedPatient.vitals_temp = document.getElementById('detail-temp').value || DEFAULT_VITALS.vitals_temp;
            selectedPatient.vitals_pulse = document.getElementById('detail-pulse').value || DEFAULT_VITALS.vitals_pulse;
            selectedPatient.vitals_bp_systolic = document.getElementById('detail-bp-sys').value || DEFAULT_VITALS.vitals_bp_systolic;
            selectedPatient.vitals_bp_diastolic = document.getElementById('detail-bp-dia').value || DEFAULT_VITALS.vitals_bp_diastolic;
            selectedPatient.vitals_resp_rate = document.getElementById('detail-resp').value || DEFAULT_VITALS.vitals_resp_rate;
            selectedPatient.vitals_spo2 = document.getElementById('detail-spo2').value || DEFAULT_VITALS.vitals_spo2;
            selectedPatient.vitals_gcs = document.getElementById('detail-gcs').value || DEFAULT_VITALS.vitals_gcs;
            selectedPatient.vitals_glucose = document.getElementById('detail-glucose').value || DEFAULT_VITALS.vitals_glucose;
            
            selectedPatient.news_score = calculateNEWS(selectedPatient);

            const vitalsText = `AteÅŸ: ${selectedPatient.vitals_temp || '-'}Â°C, NabÄ±z: ${selectedPatient.vitals_pulse || '-'}, TA: ${selectedPatient.vitals_bp_systolic || '-'}/${selectedPatient.vitals_bp_diastolic || '-'} mmHg, SS: ${selectedPatient.vitals_resp_rate || '-'}, SpO2: ${selectedPatient.vitals_spo2 || '-'}%, GCS: ${selectedPatient.vitals_gcs || '-'}, Kan Åekeri: ${selectedPatient.vitals_glucose || '-'}. NEWS Skoru: ${selectedPatient.news_score} (${getNEWSRisk(selectedPatient.news_score).level} Risk).`;
            
            const complaintAnamnesisEl = document.getElementById('detail-anam-complaint'); 
            if (complaintAnamnesisEl) {
                let existingText = complaintAnamnesisEl.value.trim();
                const complaintText = selectedPatient.chief_complaint || '';
                
                // Vital metninin baÅŸlangÄ±Ã§ noktasÄ±
                const vitalStartPattern = /(AteÅŸ:.*NEWS Skoru:.*?\)).*/s;

                if (existingText.includes('AteÅŸ:')) {
                    // Mevcut vital metni varsa, onu gÃ¼ncelle
                    complaintAnamnesisEl.value = existingText.replace(vitalStartPattern, vitalsText).trim();
                } else if (existingText.includes(complaintText) && complaintText.length > 0) {
                    // Mevcut ÅŸikayet metni varsa, altÄ±na ekle
                    complaintAnamnesisEl.value = existingText + '\n\n' + vitalsText;
                } else {
                    // Åikayet metni boÅŸsa, sadece vital ekle
                    complaintAnamnesisEl.value = vitalsText;
                }
                
                selectedPatient.anamnesis_complaint = complaintAnamnesisEl.value;
            }
            
            updatePatientInLocalStorage(selectedPatient);
            renderPatientCards(); // KartÄ± gÃ¼ncelle
            renderDetailPanel(); // Skor gÃ¼ncellenmesi iÃ§in render et
            if (showNotificationFlag) {
                showNotification('âœ… Vital bulgular kaydedildi!', 'success');
            }
        };

        // Ek hastalÄ±klar, ilaÃ§lar, operasyon, alerji toggle ve update fonksiyonlarÄ±
        window.toggleComorbidity = (item) => {
            if (!selectedPatient) return;
            const btn = event.target;
            const items = (selectedPatient.comorbidities || '').split(',').map(s => s.trim()).filter(s => s);
            
            if (items.includes(item)) {
                items.splice(items.indexOf(item), 1);
                btn.classList.remove('bg-red-300', 'text-red-900', 'font-bold');
                btn.classList.add('bg-red-100', 'text-red-700');
            } else {
                items.push(item);
                btn.classList.add('bg-red-300', 'text-red-900', 'font-bold');
                btn.classList.remove('bg-red-100', 'text-red-700');
            }
            
            selectedPatient.comorbidities = items.join(', ');
            document.getElementById('detail-comorbidities').value = selectedPatient.comorbidities;
            updateAnamnesisField();
        };

        window.toggleMedication = (item) => {
            if (!selectedPatient) return;
            const btn = event.target;
            const items = (selectedPatient.medications || '').split(',').map(s => s.trim()).filter(s => s);
            
            if (items.includes(item)) {
                items.splice(items.indexOf(item), 1);
                btn.classList.remove('bg-green-300', 'text-green-900', 'font-bold');
                btn.classList.add('bg-green-100', 'text-green-700');
            } else {
                items.push(item);
                btn.classList.add('bg-green-300', 'text-green-900', 'font-bold');
                btn.classList.remove('bg-green-100', 'text-green-700');
            }
            
            selectedPatient.medications = items.join(', ');
            document.getElementById('detail-medications').value = selectedPatient.medications;
            updateAnamnesisField();
        };

        window.toggleSurgery = (item) => {
            if (!selectedPatient) return;
            const btn = event.target;
            const items = (selectedPatient.surgeries || '').split(',').map(s => s.trim()).filter(s => s);
            
            if (items.includes(item)) {
                items.splice(items.indexOf(item), 1);
                btn.classList.remove('bg-yellow-300', 'text-yellow-900', 'font-bold');
                btn.classList.add('bg-yellow-100', 'text-yellow-700');
            } else {
                items.push(item);
                btn.classList.add('bg-yellow-300', 'text-yellow-900', 'font-bold');
                btn.classList.remove('bg-yellow-100', 'text-yellow-700');
            }
            
            selectedPatient.surgeries = items.join(', ');
            document.getElementById('detail-surgeries').value = selectedPatient.surgeries;
            updateAnamnesisField();
        };

        window.toggleAllergy = (item) => {
            if (!selectedPatient) return;
            const btn = event.target;
            const items = (selectedPatient.allergies || '').split(',').map(s => s.trim()).filter(s => s);
            
            if (items.includes(item)) {
                items.splice(items.indexOf(item), 1);
                btn.classList.remove('bg-purple-300', 'text-purple-900', 'font-bold');
                btn.classList.add('bg-purple-100', 'text-purple-700');
            } else {
                items.push(item);
                btn.classList.add('bg-purple-300', 'text-purple-900', 'font-bold');
                btn.classList.remove('bg-purple-100', 'text-purple-700');
            }
            
            selectedPatient.allergies = items.join(', ');
            document.getElementById('detail-allergies').value = selectedPatient.allergies;
            updateAnamnesisField();
        };

        window.updateAnamnesisField = () => {
            if (!selectedPatient) return;
            
            const complaintAnamnesisEl = document.getElementById('detail-anam-complaint');
            if (!complaintAnamnesisEl) return;
            
            let text = complaintAnamnesisEl.value.trim();
            
            // Ek hastalÄ±klar, ilaÃ§lar, operasyon, alerji satÄ±rlarÄ±nÄ± kaldÄ±r (varsa)
            text = text.replace(/\nEH:.*$/m, '').replace(/\nKi:.*$/m, '').replace(/\nOp:.*$/m, '').replace(/\nIA:.*$/m, '').trim();
            
            // Yeni satÄ±rlar ekle
            if (selectedPatient.comorbidities) {
                text += `\nEH: ${selectedPatient.comorbidities}`;
            }
            if (selectedPatient.medications) {
                text += `\nKi: ${selectedPatient.medications}`;
            }
            if (selectedPatient.surgeries) {
                text += `\nOp: ${selectedPatient.surgeries}`;
            }
            if (selectedPatient.allergies) {
                text += `\nIA: ${selectedPatient.allergies}`;
            }
            
            complaintAnamnesisEl.value = text;
            selectedPatient.anamnesis_complaint = text;
            updatePatientInLocalStorage(selectedPatient);
        };

        /**
         * Hata DÃ¼zeltme iÃ§in eklenen fonksiyon: Hasta detay panelindeki durum, Ã¶n tanÄ± ve diÄŸer 
         * metin alanlarÄ±ndaki manuel deÄŸiÅŸiklikleri kaydeder.
         * applyDiagnosisTemplate ve Kaydet butonu tarafÄ±ndan Ã§aÄŸrÄ±lÄ±r.
         */
        window.savePatientDetails = function() {
            if (!selectedPatient) return;

            // capture scroll positions to avoid jumping
            const prevWindowScroll = window.scrollY || document.documentElement.scrollTop || 0;
            const detailPanelEl = document.getElementById('detail-panel');
            const prevPanelScroll = detailPanelEl ? detailPanelEl.scrollTop : 0;

            // Anamnez alanlarÄ± saveDetailAnamnesis() tarafÄ±ndan iÅŸlenir.
            
            selectedPatient.preliminary_diagnosis = document.getElementById('detail-diagnosis').value.trim();
            selectedPatient.discharge_status = document.getElementById('detail-status').value;
            selectedPatient.is_favorite = selectedPatient.is_favorite && document.getElementById('detail-category').value.trim() ? true : false;
            selectedPatient.favorite_category = document.getElementById('detail-category').value.trim();
            selectedPatient.area_name = document.getElementById('detail-area').value;
            selectedPatient.bed_number = document.getElementById('detail-bed-number').value.trim();
            // Yeni: Adli Vaka Durumu Kaydedildi
            selectedPatient.is_forensic = document.getElementById('detail-is-forensic').checked;

            updatePatientInLocalStorage(selectedPatient); 
            renderPatientCards(); // Listeyi gÃ¼ncelle
            renderDetailPanel(); // Detay paneli gÃ¼ncelle

            // restore scroll positions (use timeout to wait for reflow)
            setTimeout(() => {
                try { window.scrollTo(0, prevWindowScroll); } catch(e){}
                const panelNow = document.getElementById('detail-panel');
                if (panelNow) panelNow.scrollTop = prevPanelScroll;
            }, 0);

            showNotification('âœ… Detaylar ve durum kaydedildi!', 'success');
        };

        
        window.deletePatient = () => {
            if (!selectedPatient) return;
            // BurasÄ± tarayÄ±cÄ±nÄ±n yerleÅŸik onay kutusunu kullanÄ±r, bu yÃ¼zden Custom modal Ã¶nerilir.
            if (!confirm(`${selectedPatient.patient_name} isimli hastayÄ± silmek istediÄŸinizden emin misiniz?`)) return;
            
            deletePatientFromLocalStorage(selectedPatient);
            showNotification('âœ… Hasta silindi!', 'success');
            selectedPatient = null;
            document.getElementById('detail-panel').classList.add('hidden');
            renderPatientCards(); 
        };

        // Collapsible helpers
        // Track user-controlled collapsible state so re-renders don't auto-close sections
        window.userCollapsibleState = window.userCollapsibleState || {};
        window.toggleCollapsible = (evt, headerEl) => {
            // prevent accidental form submissions
            evt && evt.stopPropagation();
            const container = headerEl.closest('.collapsible');
            if (!container) return;
            const section = container.dataset.section || null;
            const isOpen = container.classList.toggle('open');
            const toggleBtn = headerEl.querySelector('.collapsible-toggle');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                toggleBtn.textContent = isOpen ? 'â–¾' : 'â–¸';
            }
            // remember that the user explicitly opened/closed this section
            if (section) {
                window.userCollapsibleState[section] = !!isOpen;
            }
        };

        window.initCollapsibles = () => {
            document.querySelectorAll('.collapsible').forEach(c => {
                c.classList.remove('open');
                const btn = c.querySelector('.collapsible-toggle');
                if (btn) btn.textContent = 'â–¸';
            });
        };

        // Complaint presets popup
        window.toggleComplaintPresets = (e) => {
            e && e.stopPropagation();
            const el = document.getElementById('complaint-presets');
            if (!el) return;
            if (el.style.display === 'none' || el.classList.contains('hidden')) {
                el.style.display = 'block';
                el.classList.remove('hidden');
            } else {
                el.style.display = 'none';
                el.classList.add('hidden');
            }
        };

        // Close complaint presets when clicking outside
        document.addEventListener('click', (e) => {
            const presets = document.getElementById('complaint-presets');
            const btn = document.getElementById('detail-complaint-presets-btn');
            if (!presets) return;
            if (e.target === btn) return;
            if (!presets.contains(e.target)) {
                presets.style.display = 'none';
                presets.classList.add('hidden');
            }
        });

        window.setComplaint = (complaint) => {
            if (!selectedPatient) return;
            document.getElementById('detail-complaint').value = complaint;
            window.autoUpdateAnamnesisAndSave();
        };

        window.closeDetailPanel = () => {
            selectedPatient = null;
            document.getElementById('detail-panel').classList.add('hidden');
            if (window.innerWidth <= 768) {
                document.getElementById('detail-panel').classList.remove('mobile-full-screen');
            }
        };
        
        // Issue 1: Ã–n tanÄ± seÃ§ildiÄŸinde hemen uygulanÄ±r ve skor butonlarÄ± gelir.
        window.applyDiagnosisTemplate = (diagnosisName) => {
            if (selectedPatient) {
                document.getElementById('detail-diagnosis').value = diagnosisName;
                document.getElementById('diagnosis-selector-modal').classList.add('hidden');
                
                // Issue 1: Hemen skor butonlarÄ±nÄ± render et ve kaydet
                renderScoringButtons();
                window.savePatientDetails(); // <-- ArtÄ±k tanÄ±mlÄ±
                showNotification(`âœ… Ã–n tanÄ± ÅŸablonu uygulandÄ±: ${diagnosisName}`, 'success');
            }
        };
        
        window.openDiagnosisTemplateSelector = function() {
            const modal = document.getElementById('diagnosis-selector-modal');
            const listEl = document.getElementById('diagnosis-selector-list');
            
            listEl.innerHTML = diagnosisTemplates.map(d => `
                <button onclick="applyDiagnosisTemplate('${d.name}')" 
                    class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
                    <div class="font-semibold">${d.name}</div>
                </button>
            `).join('');
            
            modal.classList.remove('hidden');
        };

        // Madde 2: Tek bir anamnez bÃ¶lÃ¼mÃ¼nÃ¼ kopyalar (Detay panelinde)
        window.copyAnamnesisSection = (fieldName) => {
            if (!selectedPatient) return;
            const fieldId = fieldName.replace('anamnesis_', 'detail-anam-');
            const textarea = document.getElementById(fieldId);
            const text = textarea ? textarea.value : selectedPatient[fieldName] || '';
            copyToClipboard(text);
        };
        
        // Madde 2: Anamnez gÃ¶rÃ¼nÃ¼mÃ¼nden tek bÃ¶lÃ¼m kopyalama
        window.copyAnamnesisSectionFromView = (patientId, section) => {
            const patient = patients.find(p => p.__backendId === patientId);
            if (!patient) return;
            const text = patient[`anamnesis_${section}`] || '';
            copyToClipboard(text);
        };

        // Madde 2: TÃ¼m anamnez bÃ¶lÃ¼mlerini tek metin olarak kopyalar (2 satÄ±r boÅŸluk)
        window.copyAllAnamnesisFromDetail = () => {
            if (!selectedPatient) return;
            const sections = ['complaint', 'history', 'examination', 'procedures', 'decision'];
            let fullText = '';
            
            sections.forEach(section => {
                const fieldName = `anamnesis_${section}`;
                // Metin alanÄ±ndaki gÃ¼ncel veriyi al
                const textarea = document.getElementById(`detail-anam-${section}`);
                const text = textarea ? textarea.value : selectedPatient[fieldName] || '';

                if (text.trim()) {
                    const title = {
                        'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
                    }[section];
                    // Ä°stenen format: BaÅŸlÄ±k: \n Metin \n\n (iki satÄ±r boÅŸluk)
                    fullText += `**${title}:**\n${text.trim()}\n\n`; 
                }
            });
            
            copyToClipboard(fullText.trim());
        };
        
        // Madde 2: Anamnez gÃ¶rÃ¼nÃ¼mÃ¼nden tek hastanÄ±n tÃ¼m anamnezini kopyalar (HÄ±zlÄ± Kopyalama iÃ§in)
        window.copyAllAnamnesisForPatient = (patientId) => {
            const patient = patients.find(p => p.__backendId === patientId);
            if (!patient) return;

            const sections = ['complaint', 'history', 'examination', 'procedures', 'decision'];
            let fullText = '';
            
            sections.forEach(section => {
                const fieldName = `anamnesis_${section}`;
                const text = patient[fieldName] || '';
                if (text.trim()) {
                    const title = {
                        'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
                    }[section];
                    // Ä°stenen format: BaÅŸlÄ±k: \n Metin \n\n (iki satÄ±r boÅŸluk)
                    fullText += `**${title}:**\n${text.trim()}\n\n`; 
                }
            });
            
            copyToClipboard(fullText.trim());
        };

        // Issue 2: Anamnez ÅŸablonu seÃ§iciyi aÃ§ar (Karar metinleri dahil)
        window.openTemplateSelector = (section) => {
            currentTemplateSection = section;
            const modal = document.getElementById('template-selector-modal');
            const listEl = document.getElementById('template-selector-list');
            
            const sectionLabels = {
                'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
            };

            document.getElementById('current-template-section-name').textContent = sectionLabels[section] || 'Bilinmiyor';

            // Issue 2: DoÄŸru ÅŸablonlarÄ± filtrele
            const filteredTemplates = anamnezTemplates.filter(t => t.section === section);

            listEl.innerHTML = filteredTemplates.map((t, index) => `
                <button onclick="applyAnamnesisTemplate('${t.name}', '${t.text}')" 
                    class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-purple-200 rounded-lg">
                    <div class="font-semibold">${t.name}</div>
                    <div class="text-xs text-gray-500 line-clamp-2">${t.text}</div>
                </button>
            `).join('') || '<p class="text-gray-500 text-sm p-2">Bu bÃ¶lÃ¼m iÃ§in ÅŸablon yok. Ayarlardan veya aÅŸaÄŸÄ±daki butondan ekleyebilirsiniz.</p>';

            // Yeni ÅŸablon oluÅŸtur butonuna doÄŸru bÃ¶lÃ¼mÃ¼ atama
            document.getElementById('create-new-anamnesis-template').setAttribute('data-section', section);
            document.getElementById('create-new-anamnesis-template').textContent = `+ Yeni ${sectionLabels[section]} Åablonu OluÅŸtur`;


            modal.classList.remove('hidden');
        };

        // Yeni: Detay Panelinden Yeni Åablon OluÅŸturma ModalÄ±nÄ± AÃ§ar
        window.openAnamnesisTemplateModal = (fromSelector = false, templateIndex = null) => {
            const modalTitle = document.getElementById('anam-template-modal-title');
            const nameInput = document.getElementById('anam-template-name');
            const sectionSelect = document.getElementById('anam-template-section');
            const textInput = document.getElementById('anam-template-text');
            
            editingTemplateId = templateIndex;
            nameInput.value = '';
            textInput.value = '';

            // Åablon seÃ§ici aÃ§Ä±ksa kapat
            document.getElementById('template-selector-modal').classList.add('hidden');

            if (templateIndex !== null) {
                // DÃ¼zenleme modu
                const template = anamnezTemplates[templateIndex];
                modalTitle.textContent = `Anamnez Åablonu DÃ¼zenle: ${template.name}`;
                nameInput.value = template.name;
                sectionSelect.value = template.section;
                textInput.value = template.text;
                sectionSelect.disabled = true; // DÃ¼zenlerken bÃ¶lÃ¼m deÄŸiÅŸtirilmesin
            } else {
                // Yeni oluÅŸturma modu
                modalTitle.textContent = "Anamnez Åablonu Ekle";
                sectionSelect.disabled = false;
                
                // EÄŸer ÅŸablon seÃ§iciden geliyorsa, o bÃ¶lÃ¼mÃ¼ seÃ§
                if (fromSelector) {
                    const section = document.getElementById('create-new-anamnesis-template').getAttribute('data-section');
                    if (section) {
                        sectionSelect.value = section;
                    }
                } else {
                     sectionSelect.value = 'complaint'; // Ayarlardan geliyorsa varsayÄ±lan deÄŸer
                }
            }

            document.getElementById('anamnez-template-modal').classList.remove('hidden');
        };


        // Issue 2: SeÃ§ilen ÅŸablonu anamnez alanÄ±na ekler
        window.applyAnamnesisTemplate = (name, text) => {
            if (!selectedPatient || !currentTemplateSection) return;

            const fieldId = `detail-anam-${currentTemplateSection}`;
            const textarea = document.getElementById(fieldId);
            
            if (textarea) {
                const newText = textarea.value.trim() === '' ? text : textarea.value.trim() + '\n\n' + text;
                textarea.value = newText;
                
                selectedPatient[`anamnesis_${currentTemplateSection}`] = newText;
                updatePatientInLocalStorage(selectedPatient); 
                document.getElementById('template-selector-modal').classList.add('hidden');
                showNotification(`âœ… ${name} ÅŸablonu eklendi!`, 'success');
            }
        };

        window.saveDetailAnamnesis = () => { 
            if (!selectedPatient) return;
            
            selectedPatient.anamnesis_complaint = document.getElementById('detail-anam-complaint').value;
            selectedPatient.anamnesis_history = document.getElementById('detail-anam-history').value;
            selectedPatient.anamnesis_examination = document.getElementById('detail-anam-examination').value;
            selectedPatient.anamnesis_procedures = document.getElementById('detail-anam-procedures').value;
            selectedPatient.anamnesis_decision = document.getElementById('detail-anam-decision').value;
            
            updatePatientInLocalStorage(selectedPatient);
            showNotification('âœ… Anamnez bilgileri kaydedildi!', 'success');
        };

        // Fizik muayene ÅŸablonlarÄ±nÄ± yÃ¼kle (localStorage'dan veya varsayÄ±lanlarÄ± kullan)
        window.loadPhysicalExamTemplates = () => {
            try {
                const stored = localStorage.getItem('physicalExamTemplates');
                if (stored) physicalExamTemplates = JSON.parse(stored);
            } catch (e) { console.warn('Fizik muayene ÅŸablonlarÄ± yÃ¼klenemedi:', e); }
        };

        // Muayene alanÄ±na seÃ§ilen bÃ¶lge ÅŸablonunu ekle
        window.insertExamTemplate = (region, targetFieldId) => {
            if (!physicalExamTemplates || !physicalExamTemplates[region]) {
                showNotification('âŒ ' + region + ' ÅŸablonu bulunamadÄ±.', 'error');
                return;
            }
            const template = physicalExamTemplates[region];
            const textarea = document.getElementById(targetFieldId);
            if (!textarea) return;

            const existingText = textarea.value.trim();
            const newText = template.normalFindings;

            // EÄŸer metin boÅŸsa direkt ekle, deÄŸilse yeni satÄ±rla ayÄ±rarak ekle
            if (existingText) {
                textarea.value = existingText + '\n\n' + newText;
            } else {
                textarea.value = newText;
            }

            // Kaydet
            saveDetailAnamnesis();
            showNotification(`âœ… ${template.label} normal muayene bulgularÄ± eklendi.`, 'success');
        };

        // Simple Speech-to-Text (Web Speech API) helper for anamnesis fields
        window._speechRec = null;
        window._speechTarget = null;
        window._speechBaseText = '';
        window.toggleSpeechToText = (fieldId, evt) => {
            evt && evt.stopPropagation();
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showNotification('TarayÄ±cÄ±nÄ±z konuÅŸma tanÄ±mayÄ± desteklemiyor (Web Speech API).', 'error');
                return;
            }
            // If already active for the same field, stop it
            if (window._speechRec && window._speechTarget === fieldId) {
                try { window._speechRec.stop(); } catch(e){}
                return;
            }
            // If another field is active, stop it first
            if (window._speechRec) {
                try { window._speechRec.stop(); } catch(e){}
            }

            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            try {
                const rec = new SpeechRec();
                rec.lang = 'tr-TR';
                rec.interimResults = true;
                rec.maxAlternatives = 1;

                const btn = document.querySelector(`[data-mic-target="${fieldId}"]`);
                const textarea = document.getElementById(fieldId);
                if (!textarea) { showNotification('Hedef alan bulunamadÄ±.', 'error'); return; }

                window._speechRec = rec;
                window._speechTarget = fieldId;
                window._speechBaseText = textarea.value || '';
                if (btn) btn.classList.add('active');
                // show indicator
                const indicator = document.getElementById('mic-indicator-' + fieldId);
                if (indicator) { indicator.style.display = 'inline-flex'; }

                let finalText = '';
                rec.onresult = (e) => {
                    let interim = '';
                    for (let i = 0; i < e.results.length; i++) {
                        const res = e.results[i];
                        if (res.isFinal) finalText += res[0].transcript;
                        else interim += res[0].transcript;
                    }
                    // Compose text: base + final + interim
                    const combined = (window._speechBaseText.trim() ? window._speechBaseText.trim() + '\n' : '') + (finalText + interim).trim();
                    textarea.value = combined;
                };

                rec.onerror = (err) => {
                    console.warn('SpeechRecognition error', err);
                    showNotification('Ses tanÄ±ma hatasÄ±: ' + (err.error || err.message || ''), 'error');
                };

                rec.onend = () => {
                    // finalize
                    if (btn) btn.classList.remove('active');
                    const indicator2 = document.getElementById('mic-indicator-' + fieldId);
                    if (indicator2) { indicator2.style.display = 'none'; }
                    // ensure textarea contains base + finalText
                    const finalCombined = (window._speechBaseText.trim() ? window._speechBaseText.trim() + '\n' : '') + (finalText || '').trim();
                    if (finalCombined.trim()) textarea.value = finalCombined;
                    // cleanup
                    window._speechRec = null;
                    window._speechTarget = null;
                    window._speechBaseText = '';
                    // automatically save anamnesis
                    try { window.saveDetailAnamnesis(); } catch (e) { console.warn(e); }
                };

                rec.start();
                showNotification('ğŸ™ï¸ KonuÅŸma kaydÄ± baÅŸladÄ±. KonuÅŸun, bitince durdurun veya tekrar butona basÄ±n.', 'info');
            } catch (e) {
                console.warn('KonuÅŸma baÅŸlatÄ±lamadÄ±', e);
                showNotification('Ses tanÄ±ma baÅŸlatÄ±lamadÄ±: ' + (e.message || ''), 'error');
            }
        };

        window.stopSpeechToText = (fieldId) => {
            if (window._speechRec && window._speechTarget === fieldId) {
                try { window._speechRec.stop(); } catch(e) { console.warn(e); }
            }
            // clear UI states
            const btn = document.querySelector(`[data-mic-target="${fieldId}"]`);
            if (btn) btn.classList.remove('active');
            const indicator = document.getElementById('mic-indicator-' + fieldId);
            if (indicator) indicator.style.display = 'none';
        };

        window.clearAnamnesisField = (fieldId) => {
            const ta = document.getElementById(fieldId);
            if (!ta) return;
            if (!confirm('Bu kutucuktaki metin temizlensin mi?')) return;
            ta.value = '';
            // save change
            try { window.saveDetailAnamnesis(); } catch(e) { console.warn(e); }
            showNotification('âœ… Metin temizlendi.', 'success');
        };

        // Madde 3: Anamnez gÃ¶rÃ¼nÃ¼mÃ¼nden dÃ¼zenleme ve kaydetme
        window.toggleEditAnamnesis = (patientId, section, isEditing) => {
            const patient = patients.find(p => p.__backendId === patientId);
            if (!patient) return;
            const fieldName = `anamnesis_${section}`;
            const cardEl = document.getElementById(`anam-card-${patientId}-${section}`);
            const contentEl = document.getElementById(`anam-content-${patientId}-${section}`);
            const textareaEl = document.getElementById(`anam-textarea-${patientId}-${section}`);
            const saveBtnEl = document.getElementById(`anam-save-btn-${patientId}-${section}`);

            if (isEditing) {
                // DÃ¼zenleme moduna geÃ§
                contentEl.classList.add('hidden');
                textareaEl.classList.remove('hidden');
                saveBtnEl.classList.remove('hidden');
                textareaEl.value = patient[fieldName] || '';
                textareaEl.focus();
                
                // Kaydetme iÅŸlevini baÄŸla (onblur veya Kaydet butonu)
                const saveHandler = () => {
                    const newText = textareaEl.value;
                    patient[fieldName] = newText;
                    updatePatientInLocalStorage(patient);
                    toggleEditAnamnesis(patientId, section, false); // DÃ¼zenleme modundan Ã§Ä±k
                    renderAnamnesisView(); // GÃ¶rÃ¼nÃ¼mÃ¼ yeniden render et (daha temiz)
                    showNotification('âœ… Anamnez kartÄ± gÃ¼ncellendi!', 'success');
                };
                
                textareaEl.onblur = saveHandler;
                saveBtnEl.onclick = saveHandler;
                
                // onblur tetiklenmeden Ã¶nce baÅŸka bir kart aÃ§Ä±lÄ±rsa Ã¶nceki kartÄ± kaydetmek iÃ§in
                document.querySelectorAll('.anamnez-textarea').forEach(ta => {
                    if (ta.id !== textareaEl.id && !ta.classList.contains('hidden')) {
                        ta.blur(); 
                    }
                });

            } else {
                // GÃ¶rÃ¼ntÃ¼leme moduna geÃ§
                contentEl.classList.remove('hidden');
                textareaEl.classList.add('hidden');
                saveBtnEl.classList.add('hidden');
                textareaEl.onblur = null;
                saveBtnEl.onclick = null;
            }
        };

        // Madde 2: Ã‡ift tÄ±klama ile tam ekran okuyucuyu aÃ§
        window.openAnamnesisReader = (patientId, section) => {
             const patient = patients.find(p => p.__backendId === patientId);
             if (!patient) return;
             
             const sectionLabels = {
                 'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
             };
             const fieldName = `anamnesis_${section}`;
             const text = patient[fieldName] || '';
             
             document.getElementById('anam-reader-title').textContent = `${patient.patient_name} - ${sectionLabels[section]}`;
             document.getElementById('anam-reader-content').textContent = text;
             document.getElementById('anamnesis-reader-modal').classList.remove('hidden');
        };

        window.openSettingsSection = (section) => {
            document.querySelectorAll('div[id$="-settings-modal"]').forEach(el => el.classList.add('hidden'));
            const modal = document.getElementById(`${section}-settings-modal`);
            if (modal) {
                 modal.classList.remove('hidden');
                 window.renderSettingsSections(); 
            } else {
                console.error(`Modal bulunamadÄ±: ${section}-settings-modal`);
            }
        };

        window.closeSettingsSection = () => {
            document.querySelectorAll('div[id$="-settings-modal"]').forEach(modal => modal.classList.add('hidden'));
        };

        window.renderSettingsSections = () => {
            window.renderDiagnosisSettings();
            window.renderScoringSettings();
            window.renderAnamnesisSettings();
            window.renderTestTemplatesSettings();
            window.renderPhysicalExamTemplatesSettings();
        };

        window.renderDiagnosisSettings = () => {
             const listEl = document.getElementById('diagnosis-templates-list');
            listEl.innerHTML = diagnosisTemplates.map((d, index) => `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm">
                    <span class="font-semibold">${d.name}</span>
                    <button onclick="deleteDiagnosisTemplate(${index})" 
                        class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
                        Sil
                    </button>
                </div>
            `).join('');

            document.getElementById('add-diagnosis-template-btn-modal').onclick = () => {
                document.getElementById('diagnosis-template-name').value = '';
                document.getElementById('diagnosis-template-modal').classList.remove('hidden');
                document.getElementById('diagnosis-template-save').onclick = () => {
                    const name = document.getElementById('diagnosis-template-name').value.trim();
                    if (name && !diagnosisTemplates.some(d => d.name === name)) {
                        diagnosisTemplates.push({ name });
                        localStorage.setItem('diagnosisTemplates', JSON.stringify(diagnosisTemplates));
                        renderDiagnosisSettings();
                        document.getElementById('diagnosis-template-modal').classList.add('hidden');
                        showNotification('âœ… Ã–n tanÄ± eklendi!', 'success');
                    } else if (name) {
                        showNotification('âŒ Bu Ã¶n tanÄ± zaten var!', 'error');
                    }
                };
            };
            document.getElementById('diagnosis-template-cancel').onclick = () => document.getElementById('diagnosis-template-modal').classList.add('hidden');
        };

        window.deleteDiagnosisTemplate = (index) => {
             if (window.confirm('Bu Ã¶n tanÄ±yÄ± silmek istediÄŸinizden emin misiniz?')) {
                diagnosisTemplates.splice(index, 1);
                localStorage.setItem('diagnosisTemplates', JSON.stringify(diagnosisTemplates));
                renderDiagnosisSettings();
                showNotification('âœ… Ã–n tanÄ± silindi!', 'success');
            }
        };

        window.renderScoringSettings = () => {
            const listEl = document.getElementById('scoring-systems-list');
            listEl.innerHTML = scoringSystems.map((s, index) => `
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg shadow-sm">
                    <span class="font-bold">${s.name}</span>
                    <span class="text-sm text-gray-600">${s.diagnosis}</span>
                    <button onclick="deleteScoringSystem(${index})" 
                        class="px-3 py-1 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">
                        Sil
                    </button>
                </div>
            `).join('');

            document.getElementById('add-scoring-system-btn-modal').onclick = () => {
                const modal = document.getElementById('scoring-system-modal');
                const nameInput = document.getElementById('scoring-name');
                const diagnosisSelect = document.getElementById('scoring-diagnosis');
                
                nameInput.value = '';
                diagnosisSelect.innerHTML = '<option value="">Ã–n TanÄ± SeÃ§in</option>' + diagnosisTemplates.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
                diagnosisSelect.value = '';

                modal.classList.remove('hidden');
                
                document.getElementById('scoring-system-save').onclick = () => {
                    const name = nameInput.value.trim();
                    const diagnosis = diagnosisSelect.value;
                    if (!name || !diagnosis) {
                        showNotification('âŒ Skor adÄ± ve Ã¶n tanÄ± gerekli!', 'error');
                        return;
                    }
                    if (scoringSystems.some(s => s.name === name)) {
                        showNotification('âŒ Bu skor zaten var!', 'error');
                        return;
                    }
                    scoringSystems.push({ name, diagnosis });
                    localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
                    renderScoringSettings();
                    modal.classList.add('hidden');
                    showNotification('âœ… Skorlama sistemi eklendi!', 'success');
                };
            };
            document.getElementById('scoring-system-cancel').onclick = () => document.getElementById('scoring-system-modal').classList.add('hidden');
        };

        window.deleteScoringSystem = (index) => {
             if (window.confirm('Bu skorlama sistemini silmek istediÄŸinizden emin misiniz?')) {
                scoringSystems.splice(index, 1);
                localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
                renderScoringSettings();
                showNotification('âœ… Skorlama sistemi silindi!', 'success');
            }
        };

        // 2. Ä°stenen DÃ¼zeltme: Ayarlar ekranÄ±nda tÃ¼m ÅŸablonlarÄ± doÄŸru listeleme
        window.renderAnamnesisSettings = () => { 
             const listEl = document.getElementById('anamnez-templates-list');
             
            listEl.innerHTML = anamnezTemplates.map((t, index) => {
                const sectionLabels = {
                    'complaint': 'Åikayet', 'history': 'Hikaye', 'examination': 'FM', 'procedures': 'Ä°ÅŸlemler', 'decision': 'Karar'
                };
                const sectionDisplay = sectionLabels[t.section] || t.section;

                return `
                    <div class="p-3 bg-yellow-50 rounded-lg shadow-sm border border-yellow-200">
                        <div class="flex justify-between items-center mb-1">
                             <span class="font-bold">${t.name}</span>
                             <span class="text-xs text-gray-500 bg-yellow-100 px-2 py-0.5 rounded">${sectionDisplay}</span>
                        </div>
                        <div class="text-sm text-gray-700 line-clamp-2">${t.text}</div>
                        <div class="flex gap-2 mt-2 justify-end">
                            <button onclick="openAnamnesisTemplateModal(false, ${index})" 
                                class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600">
                                DÃ¼zenle
                            </button>
                            <button onclick="deleteAnamnezTemplate(${index})" 
                                class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600">
                                Sil
                            </button>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-sm text-gray-500">HenÃ¼z anamnez ÅŸablonu eklenmedi.</p>';

            // 1. Ä°stenen DeÄŸiÅŸiklik: Ayarlardan yeni ÅŸablon ekleme butonu
            document.getElementById('add-anamnez-template-btn-modal').onclick = () => {
                window.openAnamnesisTemplateModal(false, null);
            };
        };
        
        window.editAnamnezTemplate = (index) => {
            // openAnamnesisTemplateModal artÄ±k dÃ¼zenleme modunu da destekliyor.
            window.openAnamnesisTemplateModal(false, index);
        };

        window.deleteAnamnezTemplate = (index) => {
             if (window.confirm('Bu anamnez ÅŸablonunu silmek istediÄŸinizden emin misiniz?')) {
                anamnezTemplates.splice(index, 1);
                localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
                renderAnamnesisSettings();
                showNotification('âœ… Åablon silindi!', 'success');
            }
        };

        window.renderTestTemplatesSettings = () => {
             const listEl = document.getElementById('test-templates-settings-list');
            listEl.innerHTML = testTemplates.map((t, index) => `
                <div class="p-3 bg-red-50 rounded-lg shadow-sm border border-red-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold">${t.name}</span>
                        <span class="text-xs text-gray-500">${t.diagnosis || 'TanÄ± Yok'}</span>
                    </div>
                    <div class="text-sm text-gray-700">
                        ${t.tests.map(test => `<span class="inline-block bg-red-100 px-2 py-0.5 rounded text-xs mr-1">${test.name} (${test.delayMinutes}dk)</span>`).join('')}
                    </div>
                    <div class="flex gap-2 mt-2 justify-end">
                        <button onclick="editTestTemplate(${index})" 
                            class="px-3 py-1 bg-blue-500 text-white rounded-lg text-xs hover:bg-blue-600">
                            DÃ¼zenle
                        </button>
                        <button onclick="deleteTestTemplate(${index})" 
                            class="px-3 py-1 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600">
                            Sil
                        </button>
                    </div>
                </div>
            `).join('') || '<p class="text-sm text-gray-500">HenÃ¼z tetkik ÅŸablonu eklenmedi.</p>';

            document.getElementById('add-test-template-btn-modal').onclick = () => {
                editingTemplateId = null;
                document.getElementById('template-name').value = '';
                document.getElementById('template-diagnosis').value = '';
                document.getElementById('template-tests-list').innerHTML = ''; 
                document.getElementById('template-modal').classList.remove('hidden');
            };
        };
        
        window.editTestTemplate = (index) => {
            editingTemplateId = index;
            const template = testTemplates[index];
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-diagnosis').value = template.diagnosis || '';

            const testsListEl = document.getElementById('template-tests-list');
            testsListEl.innerHTML = ''; 

            template.tests.forEach((test, i) => {
                const testItem = document.createElement('div');
                testItem.className = 'flex gap-2 items-center';
                testItem.innerHTML = `<input type="text" id="test-name-${i}" placeholder="Tetkik adÄ±" value="${test.name}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"><input type="number" id="test-delay-${i}" placeholder="Gecikme (dk)" value="${test.delayMinutes}" class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-sm"><button onclick="this.parentElement.remove()" class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ğŸ—‘ï¸</button>`;
                testsListEl.appendChild(testItem);
            });

            document.getElementById('template-modal').classList.remove('hidden');
        };
        
        window.deleteTestTemplate = (index) => {
             if (window.confirm('Bu tetkik ÅŸablonunu silmek istediÄŸinizden emin misiniz?')) {
                testTemplates.splice(index, 1);
                localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
                renderTestTemplatesSettings();
                showNotification('âœ… Åablon silindi!', 'success');
            }
        };

        window.toggleResultCheck = (patientId, testIndex, checkIndex) => { 
             const patient = patients.find(p => p.__backendId === patientId);
             if (!patient) return;

             try {
                const tests = JSON.parse(patient.tests_json);
                if (tests[testIndex] && tests[testIndex].resultCheckTimes && tests[testIndex].resultCheckTimes[checkIndex]) {
                    tests[testIndex].resultCheckTimes[checkIndex].checked = !tests[testIndex].resultCheckTimes[checkIndex].checked;
                    patient.tests_json = JSON.stringify(tests);
                    updatePatientInLocalStorage(patient);
                 }
             } catch (e) { console.error("Toggle Result Check hatasÄ±:", e); }
        };

        // Fizik muayene ÅŸablonlarÄ±nÄ± ayarlarÄ±nda gÃ¶ster ve dÃ¼zenle
        window.renderPhysicalExamTemplatesSettings = () => {
            const listEl = document.getElementById('physical-exam-templates-settings-list');
            if (!listEl) return;

            const regions = ['head', 'thorax', 'lungs', 'abdomen', 'extremities', 'skin', 'oropharynx'];
            listEl.innerHTML = regions.map(region => {
                const template = physicalExamTemplates[region] || {};
                const label = template.label || region;
                const icon = template.icon || 'â“';
                const findings = template.normalFindings || '';
                return `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-2xl">${icon}</span>
                            <span class="font-semibold text-lg">${label}</span>
                        </div>
                        <textarea id="exam-template-${region}" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-y" rows="4"
                            placeholder="Bu bÃ¶lgenin normal muayene bulgularÄ±...">${findings}</textarea>
                        <button onclick="savePhysicalExamTemplate('${region}')" 
                            class="mt-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                            âœ… Kaydet
                        </button>
                    </div>
                `;
            }).join('');
        };

        window.savePhysicalExamTemplate = (region) => {
            const textarea = document.getElementById(`exam-template-${region}`);
            if (!textarea) return;

            const newFindings = textarea.value.trim();
            if (!physicalExamTemplates[region]) {
                physicalExamTemplates[region] = {};
            }
            physicalExamTemplates[region].normalFindings = newFindings;

            // localStorage'e kaydet
            localStorage.setItem('physicalExamTemplates', JSON.stringify(physicalExamTemplates));
            showNotification(`âœ… ${physicalExamTemplates[region].label || region} ÅŸablonu kaydedildi!`, 'success');
            console.log('Fizik muayene ÅŸablonu gÃ¼ncellendi:', region, physicalExamTemplates[region]);
        };
        
        window.toggleTestComplete = (patientId, testIndex) => {
             const patient = patients.find(p => p.__backendId === patientId);
             if (!patient) return;

             try {
                const tests = JSON.parse(patient.tests_json);
                if (tests[testIndex]) {
                    tests[testIndex].completed = !tests[testIndex].completed;
                    patient.tests_json = JSON.stringify(tests);
                    updatePatientInLocalStorage(patient);
                 }
             } catch (e) { console.error("Toggle Test Complete hatasÄ±:", e); }
        };
        
        window.openTestResultModal = (patientId, testIndex) => {
             const patient = patients.find(p => p.__backendId === patientId);
             if (!patient) return;

             try {
                 const tests = JSON.parse(patient.tests_json);
                 const test = tests[testIndex];
                 if (!test) return;
                 
                 currentResultEditTestIndex = testIndex;
                 
                 document.getElementById('test-result-title').textContent = `${test.name} Sonucu`;
                 document.getElementById('test-result-info').textContent = `Hasta: ${patient.patient_name}`;
                 document.getElementById('test-result-input').value = test.result || '';
                 document.getElementById('test-result-modal').classList.remove('hidden');
             } catch (e) { console.error("Open Test Result Modal hatasÄ±:", e); }
        };
        
        document.getElementById('test-result-save').addEventListener('click', () => {
             if (!selectedPatient || currentResultEditTestIndex === -1) return;
             
             const resultText = document.getElementById('test-result-input').value.trim();
             
             try {
                 const tests = JSON.parse(selectedPatient.tests_json);
                 tests[currentResultEditTestIndex].result = resultText;
                 
                 if (resultText && !tests[currentResultEditTestIndex].completed) {
                     // SonuÃ§ girildiÄŸinde otomatik tamamlanabilir
                     tests[currentResultEditTestIndex].completed = true;
                     showNotification(`âœ… ${tests[currentResultEditTestIndex].name} sonucu girildi ve tamamlandÄ±!`, 'success');
                 } else if (resultText) {
                     showNotification(`âœ… ${tests[currentResultEditTestIndex].name} sonucu gÃ¼ncellendi!`, 'success');
                 }
                 
                 selectedPatient.tests_json = JSON.stringify(tests);
                 updatePatientInLocalStorage(selectedPatient);
                 renderDetailPanel(); 
                 document.getElementById('test-result-modal').classList.add('hidden');
             } catch (e) { console.error("Test Result Save hatasÄ±:", e); }
        });
        
        window.applyTestTemplate = () => { 
            if (!selectedPatient) return;
            const selectEl = document.getElementById('test-template-select');
            const templateIndex = selectEl.value;

            if (templateIndex === "") {
                showNotification('âŒ LÃ¼tfen bir ÅŸablon seÃ§in.', 'error');
                return;
            }

            const template = testTemplates[parseInt(templateIndex)];
            let currentTests;
            try {
                currentTests = JSON.parse(selectedPatient.tests_json || '[]');
            } catch (e) {
                currentTests = [];
                console.error("Test JSON parse hatasÄ±:", e);
            }

            // Issue 1: EÄŸer Ã¶n tanÄ± boÅŸsa ve ÅŸablonda Ã¶n tanÄ± varsa, otomatik uygula.
            if (!selectedPatient.preliminary_diagnosis && template.diagnosis) {
                selectedPatient.preliminary_diagnosis = template.diagnosis;
                document.getElementById('detail-diagnosis').value = template.diagnosis;
                renderScoringButtons(); 
            }

            const now = new Date();
            template.tests.forEach(t => {
                const dueTime = new Date(now.getTime() + t.delayMinutes * 60000);
                
                // AynÄ± isimde aktif test varsa eklemeyi atla
                if (!currentTests.some(ct => ct.name === t.name && !ct.completed)) {
                    currentTests.push({
                        name: t.name,
                        dueTime: dueTime.toISOString(),
                        completed: false,
                        result: '',
                        notified: false,
                        // EÄŸer gecikme 0 ise, hemen kontrol edilmeli
                        resultCheckTimes: t.delayMinutes > 0 ? [{ time: dueTime.toISOString(), notified: false }] : []
                    });
                }
            });

        

            selectedPatient.tests_json = JSON.stringify(currentTests);
            updatePatientInLocalStorage(selectedPatient);
            renderDetailPanel();
            showNotification(`âœ… ${template.name} uygulandÄ±! ${template.tests.length} tetkik eklendi/kontrol edildi.`, 'success');
        };

        // Allow adding free-text tests separated by new lines (global)
        window.addFreeTextTests = () => {
            if (!selectedPatient) return;
            const raw = document.getElementById('detail-tests-free').value || '';
            const lines = raw.split(/\r?\n/).map(s => s.trim()).filter(s => s);
            if (lines.length === 0) {
                showNotification('âš ï¸ Eklemek iÃ§in en az bir tetkik yazÄ±n.', 'warning');
                return;
            }
            let currentTests = [];
            try { currentTests = JSON.parse(selectedPatient.tests_json || '[]'); } catch(e){ currentTests = []; }
            const now = new Date();
            lines.forEach(name => {
                // Avoid duplicates of same active test
                if (!currentTests.some(t => t.name === name && !t.completed)) {
                    currentTests.push({ name: name, dueTime: now.toISOString(), completed: false, result: '' });
                }
            });
            selectedPatient.tests_json = JSON.stringify(currentTests);
            updatePatientInLocalStorage(selectedPatient);
            renderDetailPanel();
            showNotification(`âœ… ${lines.length} tetkik eklendi.`, 'success');
            document.getElementById('detail-tests-free').value = '';
        };


        // Madde 1: Favori Kategori ModalÄ±nÄ± aÃ§ar
        window.openFavoriteCategorySelector = (patientId) => { 
            const patient = patients.find(p => p.__backendId === patientId);
            if (!patient) return;
            
            const modal = document.getElementById('favorite-category-modal');
            const listEl = document.getElementById('existing-categories-list');
            const categories = getAllFavoriteCategories(); 

            listEl.innerHTML = categories.map(cat => `
                <button onclick="selectFavoriteCategory('${patientId}', '${cat}')"
                    class="w-full text-left px-4 py-2 bg-gray-100 hover:bg-yellow-200 rounded-lg text-sm transition">
                    ${cat}
                </button>
            `).join('') || '<p class="text-gray-500 text-sm">HenÃ¼z oluÅŸturulmuÅŸ kategori yok.</p>';

            document.getElementById('new-category-name').value = '';
            document.getElementById('create-category-btn').onclick = () => {
                const newCat = document.getElementById('new-category-name').value.trim();
                if (newCat) {
                    selectFavoriteCategory(patientId, newCat);
                } else {
                    showNotification('âŒ LÃ¼tfen kategori adÄ± girin!', 'error');
                }
            };

            modal.classList.remove('hidden');
        };

        // Madde 1: Kategoriyi seÃ§er ve kaydeder
        window.selectFavoriteCategory = (patientId, category) => {
            const patient = patients.find(p => p.__backendId === patientId);
            if (patient) {
                patient.is_favorite = true;
                patient.favorite_category = category;
                updatePatientInLocalStorage(patient);
                document.getElementById('favorite-category-modal').classList.add('hidden');
                showNotification(`â­ ${category} kategorisine eklendi!`, 'success');
            }
        };


        window.renderFavoritesView = () => { 
             const container = document.getElementById('favorites-categories');
             const filterSelect = document.getElementById('favorite-category-filter');

             // Ã–nceki seÃ§ili deÄŸeri koru
             const previouslySelectedCategory = filterSelect.value;
             
             // Kategori filtrelerini gÃ¼ncelle
             const categories = getAllFavoriteCategories();
             
             // Kategori seÃ§eneklerini yeniden oluÅŸtur ve Ã¶nceki seÃ§imi koru
             filterSelect.innerHTML = '<option value="all">TÃ¼m Kategoriler</option>' + 
                                     categories.map(cat => 
                                         `<option value="${cat}" ${cat === previouslySelectedCategory ? 'selected' : ''}>${cat}</option>`
                                     ).join('');

             // Yeni seÃ§ili deÄŸeri al (eÄŸer Ã¶nceki seÃ§im categories'de yoksa 'all' kalÄ±r)
             const selectedCategory = filterSelect.value;
             
             let favorites = patients.filter(p => p.is_favorite);

             // Filtreleme Uygula: EÄŸer 'all' deÄŸilse, sadece seÃ§ili kategoriye ait hastalarÄ± tut.
             if (selectedCategory !== 'all' && selectedCategory !== '') {
                 favorites = favorites.filter(p => p.favorite_category === selectedCategory);
             }
             
             if (favorites.length === 0) {
                 container.innerHTML = '<p class="text-lg text-gray-500 p-4">SeÃ§ili kategoriye ait favori hasta bulunmamaktadÄ±r.</p>';
                 return;
             }
             
             // Kategoriye gÃ¶re grupla
             const grouped = favorites.reduce((acc, patient) => {
                 const category = patient.favorite_category || 'DiÄŸer';
                 if (!acc[category]) {
                     acc[category] = [];
                 }
                 acc[category].push(patient);
                 return acc;
             }, {});
             
             let html = '';
             for (const category in grouped) {
                 html += `
                     <div class="border-t border-gray-200 pt-4">
                         <h3 class="text-xl font-bold text-gray-700 mb-3">${category} (${grouped[category].length})</h3>
                         <div class="grid gap-3 mobile-grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                             ${grouped[category].map(p => `
                                 <div onclick="switchView('patients'); selectedPatient = patients.find(x => x.__backendId === '${p.__backendId}'); renderDetailPanel();" class="p-3 bg-white rounded-lg shadow-md cursor-pointer hover:bg-gray-50 transition border-l-4 border-yellow-500">
                                     <p class="font-semibold text-gray-800">${p.patient_name} (${p.age} yaÅŸ)</p>
                                     <p class="text-sm text-gray-600 line-clamp-1">${p.chief_complaint || 'Åikayet yok'}</p>
                                     ${p.is_forensic ? '<span class="text-xs text-red-500 font-semibold mt-1 block">ğŸš¨ Adli Vaka</span>' : ''}
                                 </div>
                             `).join('')}
                         </div>
                     </div>
                 `;
             }
             container.innerHTML = html;
        };

        // Madde 2 & 3: Anamnez sekmesi render fonksiyonu (HÄ±zlÄ± Kopyalama ve DÃ¼zenleme iÃ§in)
        window.renderAnamnesisView = () => { 
            const listEl = document.getElementById('anamnesis-list');
            const areaFilterSelect = document.getElementById('anamnesis-area-filter'); 
            const statusFilterSelect = document.getElementById('anamnesis-status-filter'); 
            
            // Filtreleme deÄŸerlerini al
            const selectedArea = areaFilterSelect.value;
            currentAnamnesisStatusFilter = statusFilterSelect.value;
            
            // TÃ¼m hastalardan anamnez kaydÄ± olanlarÄ± al
            let filteredPatients = patients.filter(p => 
                (p.anamnesis_complaint || p.anamnesis_history || p.anamnesis_examination || p.anamnesis_procedures || p.anamnesis_decision)
            );

            // Durum filtresini uygula
            if (currentAnamnesisStatusFilter !== 'all') {
                if (currentAnamnesisStatusFilter === 'forensic') {
                    filteredPatients = filteredPatients.filter(p => p.is_forensic);
                } else {
                    filteredPatients = filteredPatients.filter(p => p.discharge_status === currentAnamnesisStatusFilter);
                }
            }
            // Adli Vaka filtresi iÃ§in ekstra kontrol gerekebilir (EÄŸer aktif durum filtresi dÄ±ÅŸÄ±nda seÃ§ilirse)

            // Alan filtresini uygula
            if (selectedArea !== 'all') {
                if (selectedArea === 'yok') {
                    filteredPatients = filteredPatients.filter(p => !p.area_name || p.area_name === '');
                } else {
                    filteredPatients = filteredPatients.filter(p => p.area_name === selectedArea);
                }
            }
            
            if (filteredPatients.length === 0) {
                listEl.innerHTML = '<p class="text-lg text-gray-500 p-4 bg-white rounded-lg shadow-md">SeÃ§ili alana ve duruma ait kaydedilmiÅŸ anamnez bilgisi bulunmamaktadÄ±r.</p>';
                return;
            }

            const sections = ['complaint', 'history', 'examination', 'procedures', 'decision'];
            const sectionLabels = {
                'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
            };
            
            listEl.innerHTML = filteredPatients.map(p => {
                const areaInfo = AREA_COLORS[p.area_name || 'yok'] || AREA_COLORS['DiÄŸer'];
                const statusColor = p.discharge_status === 'active' ? 'text-green-600' : 'text-orange-600';
                const forensicBadge = p.is_forensic ? 
                    `<span class="text-sm font-semibold text-red-600 ml-2">ğŸš¨ ADLÄ° VAKA</span>` : '';

                return `
                    <div class="bg-white p-4 rounded-lg shadow-xl border-t-8" style="border-top-color: ${areaInfo.color};">
                        <!-- Hasta Bilgisi ve TÃ¼m Anamnezi Kopyala Butonu -->
                        <div class="flex justify-between items-center mb-4 flex-wrap">
                            <h3 class="text-xl font-bold text-gray-800">${p.patient_name} <span class="text-sm text-gray-500 font-normal">(${p.file_number}, ${p.age} yaÅŸ)</span>${forensicBadge}</h3>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-semibold ${statusColor}">${statusLabels[p.discharge_status]}</span>
                                <button onclick="copyAllAnamnesisForPatient('${p.__backendId}')" 
                                    class="px-3 py-1 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition text-sm mt-2 md:mt-0">
                                    ğŸ“‹ TÃ¼m Anamnezi Kopyala (HÄ±zlÄ±)
                                </button>
                            </div>
                        </div>
                        
                        <!-- Anamnez Kare KartlarÄ± (Madde 2 & 3: Dinamik DÃ¼zenleme ve BÃ¼yÃ¼tme) -->
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                            ${sections.map(section => {
                                const fieldName = `anamnesis_${section}`;
                                const text = p[fieldName] || '';
                                return `
                                    <!-- Madde 3: Tek tÄ±klama ile dÃ¼zenle, Ã‡ift tÄ±klama ile bÃ¼yÃ¼t/oku -->
                                    <div id="anam-card-${p.__backendId}-${section}" 
                                        class="anamnez-square-card"
                                        onclick="toggleEditAnamnesis('${p.__backendId}', '${section}', true)" 
                                        ondblclick="openAnamnesisReader('${p.__backendId}', '${section}')"
                                        style="min-height: 150px;">
                                        <div class="anamnez-card-header">
                                            <span>${sectionLabels[section]}</span>
                                            <!-- Bireysel Kopyalama Ä°konu -->
                                            <button onclick="event.stopPropagation(); copyAnamnesisSectionFromView('${p.__backendId}', '${section}')" 
                                                class="text-gray-500 hover:text-indigo-600 transition" title="Bu BÃ¶lÃ¼mÃ¼ Kopyala">
                                                ğŸ“‹
                                            </button>
                                        </div>
                                        <div id="anam-content-${p.__backendId}-${section}" class="anamnez-card-content">
                                            <p class="text-sm text-gray-700 line-clamp-4">${text.trim() || '<span class="text-gray-400 italic">BoÅŸ</span>'}</p>
                                        </div>
                                        <!-- Madde 3: DÃ¼zenleme AlanÄ± -->
                                        <textarea id="anam-textarea-${p.__backendId}-${section}" 
                                            class="anamnez-textarea hidden p-3 flex-1"
                                            placeholder="DÃ¼zenle..."
                                            data-patient-id="${p.__backendId}" 
                                            data-section="${section}"></textarea>
                                        <button id="anam-save-btn-${p.__backendId}-${section}"
                                            class="hidden w-full py-1 bg-green-500 text-white text-xs font-semibold hover:bg-green-600 transition"
                                            onclick="event.stopPropagation(); document.getElementById('anam-textarea-${p.__backendId}-${section}').blur();">
                                            Kaydet (veya dÄ±ÅŸa tÄ±kla)
                                        </button>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        // Madde 2: Anamnez gÃ¶rÃ¼nÃ¼mÃ¼ndeki tÃ¼m anamnezleri kopyalar (Toplu Kopyalama)
        window.copyAllAnamnesisFromAnamnesisView = () => { 
            const areaFilterSelect = document.getElementById('anamnesis-area-filter');
            const statusFilterSelect = document.getElementById('anamnesis-status-filter');
            const selectedArea = areaFilterSelect.value;
            const selectedStatus = statusFilterSelect.value;
            
            let filteredPatients = patients.filter(p => 
                (p.anamnesis_complaint || p.anamnesis_history || p.anamnesis_examination || p.anamnesis_procedures || p.anamnesis_decision)
            );
            
            if (selectedStatus !== 'all') {
                if (selectedStatus === 'forensic') {
                    filteredPatients = filteredPatients.filter(p => p.is_forensic);
                } else {
                    filteredPatients = filteredPatients.filter(p => p.discharge_status === selectedStatus);
                }
            }
            
            if (selectedArea !== 'all') {
                 if (selectedArea === 'yok') {
                    filteredPatients = filteredPatients.filter(p => !p.area_name || p.area_name === '');
                } else {
                    filteredPatients = filteredPatients.filter(p => p.area_name === selectedArea);
                }
            }

            let statusText = selectedStatus === 'forensic' ? 'ADLÄ° VAKALAR' : statusLabels[selectedStatus];
            let fullText = `--- SEÃ‡Ä°LÄ° ANAMNEZ Ã–ZETÄ° (Durum: ${statusText}, Alan: ${AREA_COLORS[selectedArea].text || 'TÃ¼m Alanlar'}) ---\n\n`;

            filteredPatients.forEach(p => {
                 fullText += `==========================================\n`;
                 fullText += `HASTA: ${p.patient_name} (${p.file_number})${p.is_forensic ? ' ğŸš¨ ADLÄ° VAKA' : ''}\n`;
                 fullText += `Durum: ${statusLabels[p.discharge_status]} ${p.favorite_category ? `(Favori: ${p.favorite_category})` : ''}\n`;
                 fullText += `Alan: ${p.area_name || 'Yok'} ${p.bed_number ? `(Yatak: ${p.bed_number})` : ''}\n`;
                 fullText += `==========================================\n\n`;
                 
                 const sections = ['complaint', 'history', 'examination', 'procedures', 'decision'];
                 sections.forEach(section => {
                     const fieldName = `anamnesis_${section}`;
                     const text = p[fieldName] || '';
                     if (text.trim()) {
                         const title = {
                             'complaint': 'GeliÅŸ Åikayeti', 'history': 'Hikayesi', 'examination': 'Fizik Muayene', 'procedures': 'YapÄ±lan Ä°ÅŸlemler', 'decision': 'Karar'
                         }[section];
                         // Madde 2: Ä°ki satÄ±r boÅŸlukla ayÄ±r
                         fullText += `**${title}:**\n${text.trim()}\n\n`; 
                     }
                 });
                 fullText += '------------------------------------------\n\n'; 
            });
            
            copyToClipboard(fullText.trim());
        };


        // Hata DÃ¼zeltme: switchView fonksiyonunu global olarak tanÄ±mla
        window.switchView = (viewName) => {
            const views = ['patient-list-view', 'favorites-view', 'anamnesis-view', 'settings-view'];
            views.forEach(id => {
                 const el = document.getElementById(id);
                 if (el) el.classList.add('hidden');
            });

            // View adÄ± 'patients' ise, ID 'patient-list-view' olmalÄ±dÄ±r, aksi takdirde dinamik olarak oluÅŸturulur.
            const targetId = viewName === 'patients' ? 'patient-list-view' : `${viewName}-view`;
            const targetEl = document.getElementById(targetId);
            
            if (targetEl) {
                targetEl.classList.remove('hidden');
                currentView = viewName;
            } else {
                 console.error(`GÃ¶rÃ¼ntÃ¼leme Ã¶ÄŸesi bulunamadÄ±: ${targetId}`);
                 return;
            }


            // Navigasyon butonlarÄ±nÄ± gÃ¼ncelle
            document.querySelectorAll('.flex.gap-1 button').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtnId = viewName === 'patients' ? 'patient-view-btn' : viewName === 'favorites' ? 'favorites-view-btn' : viewName === 'anamnesis' ? 'anamnesis-view-btn' : viewName === 'settings' ? 'settings-btn' : null;
            if (activeBtnId) {
                const activeBtn = document.getElementById(activeBtnId);
                if (activeBtn) {
                     activeBtn.classList.add('bg-indigo-600', 'text-white');
                     activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                }
            }


            if (viewName === 'favorites') {
                renderFavoritesView();
                closeDetailPanel();
            } else if (viewName === 'anamnesis') {
                // Madde 4: Anamnez filtresi iÃ§in varsayÄ±lan deÄŸeri ayarla
                const statusFilter = document.getElementById('anamnesis-status-filter');
                // Adli vaka filtresini korumak iÃ§in, eÄŸer "forensic" seÃ§iliyse deÄŸiÅŸtirmeyelim
                if (statusFilter && statusFilter.value !== currentAnamnesisStatusFilter && currentAnamnesisStatusFilter !== 'forensic') {
                    statusFilter.value = currentAnamnesisStatusFilter;
                }
                renderAnamnesisView();
                closeDetailPanel();
            } else if (viewName === 'settings') {
                closeDetailPanel();
                document.querySelectorAll('div[id$="-settings-modal"]').forEach(modal => modal.classList.add('hidden'));
                renderSettingsSections();
            } else if (viewName === 'patients') {
                renderPatientCards();
            }
        };


        // --- Uygulama BaÅŸlatma ---
        async function initializeApp() {
            loadPatientsFromLocalStorage();
            
            // Local Storage'dan ÅablonlarÄ±/AyarlarÄ± YÃ¼kle 
            // HATA DÃœZELTME: localStorage.getItem(key) || '[]' formatÄ±na Ã§evrildi.
            testTemplates = JSON.parse(localStorage.getItem('testTemplates') || '[]');
            anamnezTemplates = JSON.parse(localStorage.getItem('anamnezTemplates') || '[]');
            diagnosisTemplates = JSON.parse(localStorage.getItem('diagnosisTemplates') || '[]');
            scoringSystems = JSON.parse(localStorage.getItem('scoringSystems') || '[]');

            // DÄ±ÅŸ kaynaklardan (./external) varsa ÅŸablon ve engine yÃ¼kle
            try {
                await loadExternalResources();
            } catch (e) {
                console.info('External kaynaklar yÃ¼klenemedi veya yok. Devam ediliyor.');
            }

            // Fizik muayene ÅŸablonlarÄ±nÄ± yÃ¼kle
            loadPhysicalExamTemplates();
            
            // VarsayÄ±lan ÅablonlarÄ±/SkorlarÄ± Ayarla (EÄŸer boÅŸsa) 
            if (diagnosisTemplates.length === 0) {
                diagnosisTemplates = [
                    { name: "Akut Koroner Sendrom" }, { name: "Pulmoner Emboli" }, { name: "Ä°skemik Ä°nme" }, { name: "Ä°ntrakraniyal Kanama" },
                    { name: "Sepsis/Septik Åok" }, { name: "Akut Kalp YetmezliÄŸi" }, { name: "KOAH Alevlenmesi" }, { name: "AstÄ±m AtaÄŸÄ±" },
                    { name: "PnÃ¶moni" }, { name: "Ãœst GIS Kanama" }, { name: "Akut Apandisit" }, { name: "Akut Kolesistit" },
                    { name: "Akut Pankreatit" }, { name: "BÃ¶brek TaÅŸÄ±/Renal Kolik" }, { name: "Ãœriner Sistem Enfeksiyonu" }
                ];
                localStorage.setItem('diagnosisTemplates', JSON.stringify(diagnosisTemplates));
            }

            if (scoringSystems.length === 0) {
                scoringSystems = [
                    { name: "HEART Skoru", diagnosis: "Akut Koroner Sendrom" }, { name: "EDACS Skoru", diagnosis: "Akut Koroner Sendrom" }, { name: "TIMI Skoru", diagnosis: "Akut Koroner Sendrom" },
                    { name: "Wells Skoru (PE)", diagnosis: "Pulmoner Emboli" }, { name: "PERC KuralÄ±", diagnosis: "Pulmoner Emboli" },
                    { name: "NIHSS", diagnosis: "Ä°skemik Ä°nme" }, { name: "qSOFA", diagnosis: "Sepsis/Septik Åok" },
                    { name: "CURB-65", diagnosis: "PnÃ¶moni" }, { name: "Glasgow-Blatchford Skoru", diagnosis: "Ãœst GIS Kanama" }
                ];
                localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
            }

            // EÄŸer mevcut scoringSystems kaydÄ±nda EDACS yoksa ekleyelim (gÃ¼ncelleme sonrasÄ± uyumluluk)
            try {
                if (!scoringSystems.some(s => s.name === 'EDACS Skoru' && s.diagnosis === 'Akut Koroner Sendrom')) {
                    scoringSystems.push({ name: 'EDACS Skoru', diagnosis: 'Akut Koroner Sendrom' });
                    localStorage.setItem('scoringSystems', JSON.stringify(scoringSystems));
                    console.info('EDACS varsayÄ±lan skor listesine eklendi.');
                }
            } catch (e) { console.warn('EDACS ekleme hatasÄ±', e); }

            if (testTemplates.length === 0) {
                testTemplates = [
                    {
                        name: "Akut Koroner Sendrom ProtokolÃ¼",
                        diagnosis: "Akut Koroner Sendrom",
                        tests: [
                            { name: "EKG", delayMinutes: 0 }, { name: "Troponin", delayMinutes: 0 }, { name: "CBC", delayMinutes: 0 },
                            { name: "Biyokimya (Glu, Ãœre, Kre, AST, ALT, CK, CK-MB)", delayMinutes: 0 }, { name: "Kontrol Troponin", delayMinutes: 180 },
                            { name: "Kontrol EKG", delayMinutes: 30 }
                        ]
                    },
                    {
                        name: "Pulmoner Emboli ProtokolÃ¼",
                        diagnosis: "Pulmoner Emboli",
                        tests: [
                            { name: "D-Dimer", delayMinutes: 0 }, { name: "CBC", delayMinutes: 0 }, { name: "KoagÃ¼lasyon", delayMinutes: 0 },
                            { name: "Troponin", delayMinutes: 0 }, { name: "ABG", delayMinutes: 0 }, { name: "BT Pulmoner Anjio", delayMinutes: 0 }
                        ]
                    }
                ];
                localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
            }

            // Issue 2: VarsayÄ±lan karar ÅŸablonlarÄ±nÄ± anamneze ekle
            if (anamnezTemplates.length === 0) {
                 anamnezTemplates = [
                    { name: "Normal FM", section: "examination", text: "Bilinci aÃ§Ä±k, oryante, koopere. Solunum sesleri bilateral eÅŸit, ronkÃ¼s/ral yok. Kalp sesleri ritmik, ek ses/Ã¼fÃ¼rÃ¼m yok. BatÄ±n rahat, defans/rebound yok. Extremiteler bilateral nabÄ±zlar palpe, Ã¶dem yok. NÃ¶rolojik muayene doÄŸal." },
                    { name: "YatÄ±ÅŸ KararÄ± (Åablon)", section: "decision", text: "Hasta yatÄ±ÅŸ endikasyonu mevcuttur. TanÄ±sÄ± [Ã–n TanÄ±] olarak dÃ¼ÅŸÃ¼nÃ¼ldÃ¼. Ä°lgili bÃ¶lÃ¼me [BÃ¶lÃ¼m AdÄ±] yatÄ±ÅŸ verildi. Ä°stemleri dÃ¼zenlendi. Genel durumu stabil." },
                    { name: "Taburcu KararÄ± (Åablon)", section: "decision", text: "Hasta genel durumu stabil, vital bulgularÄ± normal sÄ±nÄ±rlarda olup taburcu edildi. Kontrol [Poliklinik AdÄ±] polikliniÄŸine Ã¶nerildi. KullanacaÄŸÄ± ilaÃ§lar reÃ§ete edildi. Tekrar acil baÅŸvurmasÄ± gereken durumlar hakkÄ±nda bilgilendirildi." },
                    { name: "Ä°zinsiz Terk (Åablon)", section: "decision", text: "Hasta tarafÄ±mÄ±zca taburcu edilmemiÅŸtir. Tedavisini reddetmiÅŸ ve izinsiz olarak acil servisi terk etmiÅŸtir. Hasta bilgilendirilmiÅŸtir." },
                    { name: "Ä°mzalÄ± Taburcu (Åablon)", section: "decision", text: "Hasta tedavi Ã¶nerilerimize raÄŸmen taburcu olmak istediÄŸini belirtti. OlasÄ± riskler anlatÄ±ldÄ±. Hasta bilgilendirilmiÅŸtir ve kendi isteÄŸi ile imza karÅŸÄ±lÄ±ÄŸÄ± taburcu edildi." },
                    { name: "Eksitus KararÄ± (Åablon)", section: "decision", text: "TÃ¼m resÃ¼sitasyon Ã§abalarÄ±na raÄŸmen hasta kaybedildi. Eksitus kabul edildi. Saat [Saat] civarÄ±nda ex kabul edildi." },
                    { name: "Akut BatÄ±n Hikayesi", section: "history", text: "YaklaÅŸÄ±k [Saat/GÃ¼n] Ã¶nce baÅŸlayan, [KarÄ±n BÃ¶lgesi] yerleÅŸimli, vasfÄ± [SancÄ±/KÃ¼nt/Keskin] olan karÄ±n aÄŸrÄ±sÄ± ÅŸikayeti ile baÅŸvurdu. AÄŸrÄ±ya ek olarak [BulantÄ±/Kusma/AteÅŸ] eÅŸlik ediyor. Ã–ncesinde benzer ÅŸikayeti yok. Ek hastalÄ±k/Ä°laÃ§ kullanÄ±mÄ± yok." }
                ];
                 localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
            }
            
            // BaÅŸlangÄ±Ã§ gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ve kartlarÄ± render et
            renderPatientCards();
            // Ä°lk yÃ¼klemede collapsible baÅŸlÄ±klarÄ± default kapalÄ± konuma getir
            try { initCollapsibles(); } catch (e) { console.warn('initCollapsibles hata:', e); }
            
            // Test kontrol intervalini baÅŸlat
            if (testCheckInterval === null) {
                testCheckInterval = setInterval(checkTestTimings, 30000); 
            }

            // Auto-backup: yÃ¼kle ve UI olaylarÄ±nÄ± baÄŸla
            try {
                loadAutoBackupSettings();
                const abs = document.getElementById('auto-backup-start'); if (abs) abs.addEventListener('click', startAutoBackup);
                const abo = document.getElementById('auto-backup-stop'); if (abo) abo.addEventListener('click', stopAutoBackup);
                const abn = document.getElementById('auto-backup-now'); if (abn) abn.addEventListener('click', performAutoBackup);
                const abe = document.getElementById('auto-backup-enabled'); if (abe) abe.addEventListener('change', () => { saveAutoBackupSettings(); });
                // EÄŸer kullanÄ±cÄ± kaydÄ±na gÃ¶re etkinse otomatik baÅŸlat
                if (window._autoBackupSettings && window._autoBackupSettings.enabled) {
                    startAutoBackup();
                }
            } catch (e) { console.warn('auto-backup init hata:', e); }
        }

        // --- Event Listener BaÄŸlantÄ±larÄ± ---
        document.getElementById('scan-btn').addEventListener('click', () => { 
            document.getElementById('scan-modal').classList.remove('hidden');
            // Tab sistemini baÅŸlat
            document.getElementById('scan-tab-hid').classList.remove('hidden');
            document.getElementById('scan-tab-camera').classList.add('hidden');
            document.getElementById('scan-tab-manual').classList.add('hidden');
            document.getElementById('tab-hid').classList.add('text-indigo-600', 'border-b-2', 'border-indigo-600');
            document.getElementById('tab-camera').classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
            document.getElementById('tab-manual').classList.remove('text-indigo-600', 'border-b-2', 'border-indigo-600');
            document.getElementById('hid-parsed').classList.add('hidden');
            document.getElementById('hid-use-parsed').classList.add('hidden');
            document.getElementById('hid-buffer').value = '';
            document.getElementById('hid-buffer').focus();
        });
        // Eski kopyala/yapÄ±ÅŸtÄ±r butonlarÄ± kaldÄ±rÄ±ldÄ±, yerine dosya yÃ¼kleme inputu tetikleniyor.
        
        document.getElementById('scan-confirm').addEventListener('click', () => {
            const name = document.getElementById('scan-name').value.trim();
            const fileNumber = document.getElementById('scan-file-number').value.trim();
            const age = parseInt(document.getElementById('scan-age').value);
            const gender = document.getElementById('scan-gender').value;
            const area = document.getElementById('scan-area').value.trim();
            const bed = document.getElementById('scan-bed-number').value.trim();
            const complaint = (document.getElementById('scan-complaint') && document.getElementById('scan-complaint').value) ? document.getElementById('scan-complaint').value.trim() : '';

            if (!name || !fileNumber) {
                showNotification('âŒ Hasta adÄ± ve Dosya NumarasÄ± zorunludur.', 'error');
                return;
            }

                const newPatient = {
                patient_name: name,
                file_number: fileNumber,
                age: isNaN(age) ? null : age,
                gender: gender,
                chief_complaint: complaint || '',
                discharge_status: 'active',
                is_favorite: false,
                is_forensic: false, // VarsayÄ±lan olarak adli vaka deÄŸil
                created_at: new Date().toISOString(),
                created_date: new Date().toLocaleDateString('tr-TR'),
                news_score: 0,
                tests_json: '[]',
                area_name: area, 
                bed_number: bed,
                anamnesis_complaint: complaint || '',
                anamnesis_history: '',
                anamnesis_examination: '',
                anamnesis_procedures: '',
                anamnesis_decision: '',
                // Madde 1: VarsayÄ±lan favori kategori
                favorite_category: '' 
            };

            const result = createPatientInLocalStorage(newPatient); // createPatientInLocalStorage iÃ§inde default vitaller atanÄ±r.

            if (result.isOk) {
                showNotification(`âœ… Yeni hasta eklendi: ${name} (${area} ${bed})`, 'success');
                document.getElementById('scan-modal').classList.add('hidden');
                document.getElementById('scan-name').value = '';
                document.getElementById('scan-file-number').value = '';
                document.getElementById('scan-age').value = '';
                document.getElementById('scan-gender').value = '';
                document.getElementById('scan-area').value = ''; 
                document.getElementById('scan-bed-number').value = '';
                if (document.getElementById('scan-complaint')) document.getElementById('scan-complaint').value = '';
            } else {
                showNotification('âŒ Hasta eklenirken bir hata oluÅŸtu!', 'error');
                console.error('Hasta ekleme hatasÄ±:', result.error);
            }
        });

        // --- FotoÄŸraf tabanlÄ± ekleme / AI OCR entegrasyonu ---
        (function() {
            let currentStream = null;
            let lastCapturedBlob = null;

            function showPhotoTab() {
                document.getElementById('scan-tab-photo').classList.remove('hidden');
                document.getElementById('scan-tab-manual').classList.add('hidden');
                document.getElementById('tab-photo').classList.add('text-indigo-600','border-b-2','border-indigo-600');
                document.getElementById('tab-manual').classList.remove('text-indigo-600','border-b-2','border-indigo-600');
            }
            function showManualTab() {
                document.getElementById('scan-tab-manual').classList.remove('hidden');
                document.getElementById('scan-tab-photo').classList.add('hidden');
                document.getElementById('tab-manual').classList.add('text-indigo-600','border-b-2','border-indigo-600');
                document.getElementById('tab-photo').classList.remove('text-indigo-600','border-b-2','border-indigo-600');
                stopCamera();
            }

            function openScanModal() {
                document.getElementById('scan-modal').classList.remove('hidden');
                showPhotoTab();
                // reset previews
                clearPreview();
            }

            function stopCamera() {
                if (currentStream) {
                    currentStream.getTracks().forEach(t => t.stop());
                    currentStream = null;
                }
                const preview = document.getElementById('camera-preview'); if (preview) preview.style.display = 'none';
                const status = document.getElementById('camera-status'); if (status) { status.textContent = ''; }
            }

            async function startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    currentStream = stream;
                    const video = document.getElementById('camera-stream');
                    video.srcObject = stream;
                    document.getElementById('camera-preview').style.display = 'block';
                } catch (e) {
                    showNotification('Kamera aÃ§Ä±lamadÄ±: ' + (e.message || e), 'error');
                }
            }

            function captureFromCamera() {
                const video = document.getElementById('camera-stream');
                if (!video || !video.videoWidth) { showNotification('Kamera hazÄ±r deÄŸil.', 'error'); return; }
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    lastCapturedBlob = blob;
                    previewBlob(blob);
                }, 'image/jpeg', 0.9);
                stopCamera();
            }

            function previewBlob(blob) {
                const url = URL.createObjectURL(blob);
                const img = document.getElementById('preview-img');
                img.src = url;
                document.getElementById('photo-preview-img').style.display = 'block';
                document.getElementById('ocr-result').classList.add('hidden');
            }

            function clearPreview() {
                lastCapturedBlob = null;
                const img = document.getElementById('preview-img'); if (img) img.src = '';
                document.getElementById('photo-preview-img').style.display = 'none';
                document.getElementById('ocr-result').classList.add('hidden');
                stopCamera();
                const fileInput = document.getElementById('photo-file-input'); if (fileInput) fileInput.value = '';
            }


            
            // --- GÃ–RÃœNTÃœ ANALÄ°Z VE OCR FONKSÄ°YONU ---
            async function analyzePhotoWithAI(blob) {
                const apiKey = localStorage.getItem('gemini_api_key');

                if (!apiKey) {
                    showNotification('âš ï¸ Ã–nce Ayarlar menÃ¼sÃ¼nden Google API AnahtarÄ±nÄ±zÄ± girin.', 'error');
                    window.switchView('settings');
                    return;
                }

                // Butonu geÃ§ici olarak kilitle ve bilgi ver
                const analyzeBtn = document.getElementById('analyze-photo');
                const originalBtnText = analyzeBtn.innerHTML;
                analyzeBtn.innerHTML = 'â³ Analiz Ediliyor...';
                analyzeBtn.disabled = true;
                
                showNotification('ğŸ§  FotoÄŸraf Yapay Zeka ile taranÄ±yor...', 'info');

                try {
                    // 1. Resmi Base64 formatÄ±na Ã§evir (Gemini'ye gÃ¶ndermek iÃ§in ÅŸart)
                    const base64Image = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });

                    // 2. KullanÄ±labilir Modeli Bul (Flash modeli resim konusunda hÄ±zlÄ± ve iyidir)
                    // Ã–nce model listesini Ã§ekiyoruz
                    let validModelName = "models/gemini-1.5-flash"; // VarsayÄ±lan hÄ±zlÄ± model
                    try {
                        const listResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                        const listData = await listResponse.json();
                        if (listData.models) {
                            // Flash modelini ara, yoksa Pro, yoksa herhangi bir Gemini
                            const flash = listData.models.find(m => m.name.includes('flash') && m.supportedGenerationMethods.includes('generateContent'));
                            if (flash) validModelName = flash.name;
                            else {
                                const anyGemini = listData.models.find(m => m.name.includes('gemini') && m.supportedGenerationMethods.includes('generateContent'));
                                if (anyGemini) validModelName = anyGemini.name;
                            }
                        }
                    } catch (e) {
                        console.warn("Model listesi alÄ±namadÄ±, varsayÄ±lan deneniyor.", e);
                    }

                    // 3. Prompt (Ä°stem) HazÄ±rla - Senin hastane formatÄ±na Ã¶zel
                    const promptText = `
                        Bu bir hastane hasta barkodu veya hasta kabul kaÄŸÄ±dÄ±dÄ±r. FotoÄŸrafÄ± analiz et ve aÅŸaÄŸÄ±daki bilgileri Ã§Ä±kar.
                        
                        ARANACAK DÃœZEN Ä°PUÃ‡LARI:
                        1. Hasta AdÄ± SoyadÄ±: Genelde etiketin en Ã¼st satÄ±rÄ±nda yazar.
                        2. Dosya NumarasÄ± (Protokol): Genelde ismin hemen alt satÄ±rÄ±nda yazar.
                        3. YaÅŸ: Genelde dosya numarasÄ±nÄ±n saÄŸ tarafÄ±nda veya yanÄ±nda yazar.

                        EÄŸer bu dÃ¼zende bulamazsan, kaÄŸÄ±dÄ±n herhangi bir yerindeki "AdÄ± SoyadÄ±", "Dosya No/Protokol" ve "YaÅŸ" verilerini bul.
                        
                        Ã‡IKTI FORMATI:
                        Sadece ve sadece saf JSON formatÄ±nda cevap ver. Markdown bloÄŸu kullanma.
                        Ã–rnek: {"patient_name": "AHMET YILMAZ", "file_number": "1234567", "age": "45"}
                    `;

                    // 4. API Ä°steÄŸi GÃ¶nder
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${validModelName}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: promptText },
                                    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();

                    if (data.error) throw new Error(data.error.message);

                    // 5. CevabÄ± Ä°ÅŸle ve Formu Doldur
                    if (data.candidates && data.candidates.length > 0) {
                        let textResponse = data.candidates[0].content.parts[0].text;
                        
                        // OlasÄ± Markdown temizliÄŸi (```json ... ``` gibi)
                        textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                        
                        const result = JSON.parse(textResponse);

                        // Form AlanlarÄ±nÄ± Doldur
                        if (result.patient_name) document.getElementById('scan-name').value = result.patient_name.toUpperCase();
                        if (result.file_number) document.getElementById('scan-file-number').value = result.file_number;
                        if (result.age) {
                            // Sadece sayÄ±yÄ± al (Ã¶rn: "45 YaÅŸ" -> "45")
                            const ageNum = result.age.toString().match(/\d+/);
                            if (ageNum) document.getElementById('scan-age').value = ageNum[0];
                        }

                        // AlgÄ±lanan verileri gÃ¶ster (Opsiyonel bilgi kutusu)
                        const infoBox = document.getElementById('ocr-result');
                        const infoContent = document.getElementById('ocr-result-content');
                        if (infoBox && infoContent) {
                            infoBox.classList.remove('hidden');
                            infoContent.innerHTML = `
                                <strong>Ad:</strong> ${result.patient_name || '-'}<br>
                                <strong>Dosya:</strong> ${result.file_number || '-'}<br>
                                <strong>YaÅŸ:</strong> ${result.age || '-'}
                            `;
                        }

                        showNotification('âœ… Bilgiler baÅŸarÄ±yla Ã§Ä±karÄ±ldÄ±! LÃ¼tfen kontrol edin.', 'success');
                        
                        // KullanÄ±cÄ± gÃ¶rsÃ¼n diye Manuel sekmeye geÃ§iÅŸ yap
                        setTimeout(() => {
                            document.getElementById('tab-manual').click();
                        }, 1000);
                    }

                } catch (error) {
                    console.error('OCR HatasÄ±:', error);
                    showNotification('âŒ Analiz hatasÄ±: ' + error.message, 'error');
                } finally {
                    analyzeBtn.innerHTML = originalBtnText;
                    analyzeBtn.disabled = false;
                }
            }

            // Event bindings
            document.getElementById('scan-btn').addEventListener('click', () => {
                openScanModal();
            });

            document.getElementById('tab-photo').addEventListener('click', showPhotoTab);
            document.getElementById('tab-manual').addEventListener('click', showManualTab);

            document.getElementById('scan-cancel').addEventListener('click', () => {
                clearPreview();
                document.getElementById('scan-modal').classList.add('hidden');
            });

            document.getElementById('camera-start').addEventListener('click', async () => {
                await startCamera();
            });

            document.getElementById('camera-capture').addEventListener('click', () => {
                captureFromCamera();
            });

            document.getElementById('photo-file-input').addEventListener('change', (e) => {
                const f = e.target.files && e.target.files[0];
                if (!f) return;
                lastCapturedBlob = f;
                previewBlob(f);
            });

            document.getElementById('clear-photo').addEventListener('click', () => {
                clearPreview();
            });

            document.getElementById('analyze-photo').addEventListener('click', async () => {
                if (!lastCapturedBlob) { showNotification('ğŸ“· Ã–nce fotoÄŸraf Ã§ekin veya yÃ¼kleyin.', 'info'); return; }
                // Stub: Replace this with your own AI API call
                await analyzePhotoWithAI(lastCapturedBlob);
            });

            document.getElementById('scan-confirm').addEventListener('click', () => {
                const name = document.getElementById('scan-name').value.trim();
                const fileNumber = document.getElementById('scan-file-number').value.trim();
                const age = parseInt(document.getElementById('scan-age').value);
                const gender = document.getElementById('scan-gender').value;
                const area = document.getElementById('scan-area').value.trim();
                const bed = document.getElementById('scan-bed-number').value.trim();
                const complaint = (document.getElementById('scan-complaint') && document.getElementById('scan-complaint').value) ? document.getElementById('scan-complaint').value.trim() : '';

                if (!name || !fileNumber) {
                    showNotification('âŒ Hasta adÄ± ve Dosya NumarasÄ± zorunludur.', 'error');
                    return;
                }

                const newPatient = {
                    patient_name: name,
                    file_number: fileNumber,
                    age: isNaN(age) ? null : age,
                    gender: gender,
                    chief_complaint: complaint || '',
                    discharge_status: 'active',
                    is_favorite: false,
                    is_forensic: false,
                    created_at: new Date().toISOString(),
                    created_date: new Date().toLocaleDateString('tr-TR'),
                    news_score: 0,
                    tests_json: '[]',
                    area_name: area,
                    bed_number: bed,
                    anamnesis_complaint: complaint || '',
                    anamnesis_history: '',
                    anamnesis_examination: '',
                    anamnesis_procedures: '',
                    anamnesis_decision: '',
                    favorite_category: ''
                };

                const result = createPatientInLocalStorage(newPatient);
                if (result.isOk) {
                    showNotification(`âœ… Yeni hasta eklendi: ${name} (${area} ${bed})`, 'success');
                    document.getElementById('scan-modal').classList.add('hidden');
                    // clear inputs
                    ['scan-name','scan-file-number','scan-age','scan-gender','scan-area','scan-bed-number','scan-complaint'].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                    clearPreview();
                } else {
                    showNotification('âŒ Hasta eklenirken bir hata oluÅŸtu!', 'error');
                    console.error('Hasta ekleme hatasÄ±:', result.error);
                }
            });
        })();



        
        document.getElementById('filter-select').addEventListener('change', (e) => { currentFilter = e.target.value; renderPatientCards(); });
        document.getElementById('filter-area-select').addEventListener('change', (e) => { currentAreaFilter = e.target.value; renderPatientCards(); });
        document.getElementById('sort-select').addEventListener('change', (e) => { currentSort = e.target.value; renderPatientCards(); });
        
        // Yeni: Anamnez Durum Filtresi
        document.getElementById('anamnesis-status-filter').addEventListener('change', (e) => { currentAnamnesisStatusFilter = e.target.value; renderAnamnesisView(); });
        document.getElementById('anamnesis-area-filter').addEventListener('change', (e) => { renderAnamnesisView(); }); // Madde 1: Alan filtreleme

        document.getElementById('patient-view-btn').addEventListener('click', () => { window.switchView('patients'); });
        document.getElementById('favorites-view-btn').addEventListener('click', () => { window.switchView('favorites'); });
        document.getElementById('anamnesis-view-btn').addEventListener('click', () => { window.switchView('anamnesis'); });
        document.getElementById('settings-btn').addEventListener('click', () => { window.switchView('settings'); });

        document.getElementById('score-calculator-close').addEventListener('click', () => { document.getElementById('score-calculator-modal').classList.add('hidden'); });
        document.getElementById('template-cancel').addEventListener('click', () => { document.getElementById('template-modal').classList.add('hidden'); });
        document.getElementById('anam-template-cancel').addEventListener('click', () => { document.getElementById('anamnez-template-modal').classList.add('hidden'); });

        document.getElementById('anam-detail-close').addEventListener('click', () => { document.getElementById('anamnesis-detail-modal').classList.add('hidden'); });
        
        document.getElementById('template-save').addEventListener('click', () => { 
            // Tetkik Åablonu Kaydetme MantÄ±ÄŸÄ±
            const name = document.getElementById('template-name').value.trim();
            const diagnosis = document.getElementById('template-diagnosis').value.trim();
            if (!name) { showNotification('âŒ Åablon adÄ± gerekli!', 'error'); return; }
            const testsList = document.getElementById('template-tests-list');
            const tests = [];
            for (let i = 0; i < testsList.children.length; i++) {
                const nameEl = testsList.children[i].querySelector('input:nth-child(1)');
                const delayEl = testsList.children[i].querySelector('input:nth-child(2)');
                if (nameEl && nameEl.value.trim()) {
                    tests.push({ name: nameEl.value.trim(), delayMinutes: parseInt(delayEl ? delayEl.value : 0) || 0 });
                }
            }
            if (tests.length === 0) { showNotification('âŒ En az bir tetkik ekleyin!', 'error'); return; }
            const template = { name, diagnosis, tests };
            if (editingTemplateId !== null) { testTemplates[editingTemplateId] = template; } else { testTemplates.push(template); }
            localStorage.setItem('testTemplates', JSON.stringify(testTemplates));
            document.getElementById('template-modal').classList.add('hidden');
            renderTestTemplatesSettings();
            showNotification('âœ… Åablon kaydedildi!', 'success');
        });
        document.getElementById('add-test-item').addEventListener('click', () => {
            const testsList = document.getElementById('template-tests-list');
            const index = testsList.children.length;
            const testItem = document.createElement('div');
            testItem.className = 'flex gap-2 items-center';
            testItem.innerHTML = `<input type="text" id="test-name-${index}" placeholder="Tetkik adÄ±" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"><input type="number" id="test-delay-${index}" placeholder="Gecikme (dk)" value="0" class="w-32 px-3 py-2 border border-gray-300 rounded-lg text-sm"><button onclick="this.parentElement.remove()" class="px-3 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600">ğŸ—‘ï¸</button>`;
            testsList.appendChild(testItem);
        });
        document.getElementById('anam-template-save').addEventListener('click', () => {
             // Anamnez Åablonu Kaydetme MantÄ±ÄŸÄ±
            const name = document.getElementById('anam-template-name').value.trim();
            const section = document.getElementById('anam-template-section').value;
            const text = document.getElementById('anam-template-text').value.trim();
            if (!name || !text) { showNotification('âŒ Åablon adÄ± ve metni gerekli!', 'error'); return; }
            
            const newTemplate = { name, section, text };

            if (editingTemplateId !== null) { 
                // DÃ¼zenleme
                anamnezTemplates[editingTemplateId] = newTemplate;
                showNotification('âœ… Anamnez ÅŸablonu gÃ¼ncellendi!', 'success');
            } else {
                // Yeni Ekleme
                anamnezTemplates.push(newTemplate);
                showNotification('âœ… Anamnez ÅŸablonu eklendi!', 'success');
            }

            localStorage.setItem('anamnezTemplates', JSON.stringify(anamnezTemplates));
            document.getElementById('anamnez-template-modal').classList.add('hidden');
            
            // EÄŸer Ayarlar aÃ§Ä±ksa Ayarlar'Ä± gÃ¼ncelle
            if (currentView === 'settings') {
                renderAnamnesisSettings();
            }
        });


        // UygulamayÄ± baÅŸlat
        window.onload = initializeApp;


        // --- YAPAY ZEKA ASÄ°STANI (GEMINI) ---
        
        // 1. API AnahtarÄ±nÄ± Kaydetme
        function saveGoogleApiKey() {
            const input = document.getElementById('google-api-key-input');
            if (input && input.value.trim()) {
                localStorage.setItem('gemini_api_key', input.value.trim());
                showNotification('âœ… API AnahtarÄ± kaydedildi!', 'success');
            } else {
                showNotification('âŒ LÃ¼tfen geÃ§erli bir anahtar girin.', 'error');
            }
        }

        // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda kayÄ±tlÄ± anahtar varsa inputa doldur (kullanÄ±cÄ± gÃ¶rsÃ¼n diye)
        // Bu kodu initializeApp iÃ§ine de ekleyebiliriz ama burasÄ± da Ã§alÄ±ÅŸÄ±r.
        setTimeout(() => {
            const savedKey = localStorage.getItem('gemini_api_key');
            const inputEl = document.getElementById('google-api-key-input');
            if (savedKey && inputEl) {
                inputEl.value = savedKey;
            }
        }, 1000);

       // 2. Metni Yapay Zeka ile Ä°ÅŸleme Fonksiyonu (OTOMATÄ°K MODEL ALGILAYICI)
        async function refineTextWithAI(elementId, sectionName) {
            const textarea = document.getElementById(elementId);
            const originalText = textarea.value.trim();
            const apiKey = localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                alert("LÃ¼tfen Ã¶nce Ayarlar kÄ±smÄ±ndan Google API AnahtarÄ±nÄ±zÄ± girin.");
                window.switchView('settings');
                return;
            }

            if (!originalText || originalText.length < 3) {
                showNotification('âš ï¸ Metin Ã§ok kÄ±sa.', 'error');
                return;
            }

            const btn = event.target; 
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = 'ğŸ”'; 
            btn.disabled = true; 
            showNotification('ğŸ§  AÃ§Ä±k olan model aranÄ±yor...', 'info');

            const prompt = `
                GÃ–REV: AÅŸaÄŸÄ±daki tÄ±bbi notu Acil TÄ±p terminolojisine ve hukuki standartlara uygun, profesyonel bir dille yeniden yaz.
                KURALLAR: YazÄ±m hatalarÄ±nÄ± dÃ¼zelt. AnlatÄ±m bozukluÄŸunu gider. Yorum yapma. Sadece revize metni ver.
                METÄ°N: "${originalText}"
            `;

            try {
                // ADIM 1: Ã–nce hesabÄ±nÄ±zda aktif olan modelleri LÄ°STELE
                // Bu adÄ±m "404 Not Found" hatasÄ±nÄ± engeller Ã§Ã¼nkÃ¼ var olanÄ± seÃ§eriz.
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                
                const listResponse = await fetch(listUrl);
                const listData = await listResponse.json();

                if (listData.error) {
                    throw new Error("Model Listesi HatasÄ±: " + listData.error.message);
                }

                // ADIM 2: Listeden uygun bir model seÃ§ (Ä°Ã§inde 'gemini' geÃ§en ve 'generateContent' destekleyen)
                let validModelName = null;
                
                if (listData.models) {
                    // Ã–nce hÄ±zlÄ± olan Flash'Ä± ara
                    const flashModel = listData.models.find(m => m.name.includes('flash') && m.supportedGenerationMethods.includes('generateContent'));
                    // Yoksa Pro'yu ara
                    const proModel = listData.models.find(m => m.name.includes('pro') && m.supportedGenerationMethods.includes('generateContent'));
                    // O da yoksa herhangi bir Gemini modelini al
                    const anyModel = listData.models.find(m => m.name.includes('gemini') && m.supportedGenerationMethods.includes('generateContent'));

                    if (flashModel) validModelName = flashModel.name;
                    else if (proModel) validModelName = proModel.name;
                    else if (anyModel) validModelName = anyModel.name;
                }

                if (!validModelName) {
                    throw new Error("API AnahtarÄ±nÄ±zÄ±n yetkili olduÄŸu hiÃ§bir 'Gemini' modeli bulunamadÄ±. LÃ¼tfen Google AI Studio'dan yeni bir anahtar alÄ±n.");
                }

                console.log("KullanÄ±lacak Model Bulundu:", validModelName);

                // ADIM 3: Bulunan modeli kullanarak iÅŸlemi yap
                // validModelName Ã¶rneÄŸin "models/gemini-1.5-flash-latest" gibi gelir.
                const generateUrl = `https://generativelanguage.googleapis.com/v1beta/${validModelName}:generateContent?key=${apiKey}`;

                const response = await fetch(generateUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.candidates && data.candidates.length > 0) {
                    const newText = data.candidates[0].content.parts[0].text.trim();
                    
                    if (confirm(`Yapay Zeka (${validModelName.replace('models/', '')}):\n\n${newText}\n\nOnaylÄ±yor musunuz?`)) {
                        textarea.value = newText;
                        if(window.saveDetailAnamnesis) window.saveDetailAnamnesis();
                        else if(window.savePatientDetails) window.savePatientDetails();
                        showNotification('âœ… BaÅŸarÄ±lÄ±!', 'success');
                    }
                }

            } catch (error) {
                console.error('AI HatasÄ±:', error);
                
                // KullanÄ±cÄ±ya kesin Ã§Ã¶zÃ¼m yolunu gÃ¶steren mesaj
                if (error.message.includes('Model Listesi HatasÄ±') || error.message.includes('404')) {
                     alert(`KRÄ°TÄ°K HATA: API Servisi KapalÄ±\n\nGoogle, anahtarÄ±nÄ±zÄ±n baÄŸlÄ± olduÄŸu projede "Generative Language API" servisini kapalÄ± gÃ¶rÃ¼yor.\n\nÃ‡Ã–ZÃœM:\n1. 'console.cloud.google.com' adresine gidin.\n2. YukarÄ±dan projenizi seÃ§in.\n3. Arama Ã§ubuÄŸuna 'Generative Language API' yazÄ±n.\n4. 'ENABLE' (EtkinleÅŸtir) butonuna basÄ±n.`);
                } else {
                    alert("HATA: " + error.message);
                }
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }
        




    </script>
 </body>
</html>